<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" href="/static/img/favicon.ico" />
    <title>How to Setup an External GELI Encrypted USB Hard Drive as a ZFS Backup Disk in FreeBSD - Dusko Pijetlovic</title>
    <meta name="author" content="Dusko Pijetlovic" />
    <meta name="description" content="How to Setup an External GELI Encrypted USB Hard Drive as a ZFS Backup Disk in FreeBSD" />
    <meta name="keywords" content="How to Setup an External GELI Encrypted USB Hard Drive as a ZFS Backup Disk in FreeBSD, Dusko Pijetlovic, zfs, freebsd, snapshot, backup" />
    <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml">
    <meta content="1749788565247320" property="fb:app_id">
    <meta content="Dusko Pijetlovic" property="og:site_name">

    

    
      <meta content="How to Setup an External GELI Encrypted USB Hard Drive as a ZFS Backup Disk in FreeBSD" property="og:title">
      <meta content="article" property="og:type">
    

    
      <meta content="Dusko Pijetlovic - My Personal Web Space" property="og:description">
    

    
      <meta content="http://localhost:4000/zfs/freebsd/snapshot/backup/2022/03/19/freebsd-geli-encrypted-usb-external-hdd-zfs-freebsd.html" property="og:url">
    

    
      <meta content="2022-03-19T10:13:21-07:00" property="article:published_time">
      <meta content="http://localhost:4000/about/" property="article:author">
    

    

    
      
        <meta content="zfs" property="article:section">
      
    

    
      
    

    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@github.io">
    <meta name="twitter:creator" content="@github.io">

    
      <meta name="twitter:title" content="How to Setup an External GELI Encrypted USB Hard Drive as a ZFS Backup Disk in FreeBSD">
    

    
      <meta name="twitter:url" content="http://localhost:4000/zfs/freebsd/snapshot/backup/2022/03/19/freebsd-geli-encrypted-usb-external-hdd-zfs-freebsd.html">
    

    
      <meta name="twitter:description" content="Dusko Pijetlovic - My Personal Web Space">
    

    

    <!-- Font awesome icons -->
    <link href="/static/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
    <!-- syntax highlighting CSS -->
    <link rel="stylesheet" href="/static/css/syntax.css">
    <!-- Bootstrap core CSS -->
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Roboto+Condensed:400,300italic,300,400italic,700&amp;subset=latin,latin-ext" rel="stylesheet" type="text/css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/static/css/super-search.css">
    <link rel="stylesheet" href="/static/css/thickbox.css">
    <link rel="stylesheet" href="/static/css/projects.css">
    <link rel="stylesheet" href="/static/css/main.css">

    
  </head>
  <body>
    <div class="container">
      <div class="col-sm-3">
        <div class="fixed-condition">
          <h1 class="author-name"><a href="/">Dusko Pijetlovic</a></h1>
          
            <div class="profile-about">
              My personal notes where I store things I find interesting or might need in the future.
            </div>
          
          <div class="social">
            <ul>
              
                <li><a href="https://twitter.com/duskopijetlovic" target="_blank"><i class="fa fa-twitter"></i></a></li>
              
                <li><a href="https://linkedin.com/in/duskopijetlovic" target="_blank"><i class="fa fa-linkedin"></i></a></li>
              
                <li><a href="https://github.com/duskopijetlovic" target="_blank"><i class="fa fa-github"></i></a></li>
              
            </ul>
          </div>
          <div class="search" id="js-search">
            <input type="text" placeholder="(sitemap)~$ type to search" class="search__input form-control" id="js-search__input">
            <ul class="search__results" id="js-search__results"></ul>
          </div>
          <hr />
          <ul class="sidebar-nav">
            <strong>Navigation</strong>
            <li><a href="/">Home</a></li>
            
              <li><a class="about" href="/about/">About</a></li>
            
              <li><a class="about" href="/feed.xml">XML Feed</a></li>
            
              <li><a class="about" href="/category/categories">Categories</a></li>
            
          </ul>
        </div>
        <!-- end /.fixed-condition -->
      </div>
      <div class="col-sm-8 col-offset-1 main-layout">
        <header class="post-header">
  <h1 class="post-title">How to Setup an External GELI Encrypted USB Hard Drive as a ZFS Backup Disk in FreeBSD</h1>
</header>

<span class="time">19 Mar 2022</span>

  <span class="categories">
    &raquo; <a href="/category/zfs">zfs</a>, <a href="/category/freebsd">freebsd</a>, <a href="/category/snapshot">snapshot</a>, <a href="/category/backup">backup</a>
  </span>


<div class="content">
  <div class="post"><ul>
  <li>OS:  FreeBSD 13.0</li>
  <li>Shell:  csh</li>
  <li>External hard disk drive: WD (WesternDigital) Easystore 14TB USB 3.0 Desktop External Hard Drive, Model:  <a href="https://www.bestbuy.ca/en-ca/product/wd-easystore-14tb-usb-3-0-desktop-external-hard-drive-wdbama0140hbk-nese-black-only-at-best-buy/14936770">WDBAMA0140HBK-NESE</a>
    <ul>
      <li>Possibly, a variation of a model <a href="https://www.westerndigital.com/products/portable-drives/wd-easystore-desktop-usb-3-0-hdd#WDBAMA0140HBK-NESN">WDBAMA0140HBK-NESN</a></li>
    </ul>
  </li>
</ul>

<hr />

<h2 id="preparation">Preparation</h2>

<p>Install packages <code class="language-plaintext highlighter-rouge">zxfer</code> and <code class="language-plaintext highlighter-rouge">zfstools</code>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo pkg install zxfer zfstools
</code></pre></div></div>

<p>The zfstools package has the <code class="language-plaintext highlighter-rouge">zfs-auto-snapshot</code> tool that creates and 
manages ZFS snapshots.</p>

<p>The zxfer package is a shell script that uses <code class="language-plaintext highlighter-rouge">zfs-send(8)</code> for sending 
snapshots and <code class="language-plaintext highlighter-rouge">zfs-receive(8)</code> for receiving them in the external USB hard 
disk drive.</p>

<h2 id="enabling-automatic-zfs-filesystem-snapshotting">Enabling Automatic ZFS Filesystem Snapshotting</h2>

<p>Use <code class="language-plaintext highlighter-rouge">zfs list</code> and <code class="language-plaintext highlighter-rouge">zpool list</code> to check the ZFS filesystems in your pool.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ zfs list
NAME                 USED  AVAIL     REFER  MOUNTPOINT
zroot                189G   710G       88K  /zroot
zroot/ROOT          58.5G   710G       88K  none
zroot/ROOT/default  58.5G   710G     52.6G  /
zroot/tmp           24.4G   710G     24.4G  /tmp
zroot/usr            101G   710G       88K  /usr
zroot/usr/home       101G   710G      101G  /usr/home
zroot/usr/ports       88K   710G       88K  /usr/ports
zroot/usr/src         88K   710G       88K  /usr/src
zroot/var           2.81M   710G       88K  /var
zroot/var/audit       88K   710G       88K  /var/audit
zroot/var/crash       88K   710G       88K  /var/crash
zroot/var/log       1.47M   710G     1.47M  /var/log
zroot/var/mail       144K   710G      144K  /var/mail
zroot/var/tmp        964K   710G      964K  /var/tmp
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ zpool list
NAME   SIZE  ALLOC  FREE CKPOINT EXPANDSZ  FRAG  CAP DEDUP  HEALTH  ALTROOT
zroot  928G   189G  739G       -        -    6%  20% 1.00x  ONLINE  -
</code></pre></div></div>

<p>The default ZFS layout with a fresh FreeBSD 13 sets up the 
following filesystems in the pool (not counting zroot, zroot/ROOT, 
zroot/usr, and zroot/var, which are containers for children filesystems, 
not used directly for data storage):</p>

<p>zroot/ROOT/default <br />
zroot/tmp <br />
zroot/usr/home <br />
zroot/usr/ports <br />
zroot/usr/src <br />
zroot/var/audit <br />
zroot/var/crash <br />
zroot/var/log <br />
zroot/var/mail <br />
zroot/var/tmp</p>

<p>Filesystems and their content: <sup><a href="#footnotes">1</a></sup></p>

<ul>
  <li>zroot/ROOT/default: Configurations and root’s home directory.</li>
  <li>zroot/usr/home: User home directory.</li>
  <li>zroot/var/log: System log files.</li>
  <li>
    <p>zroot/var/mail: Mail spools for your user account and root.</p>
  </li>
  <li>zroot/tmp: Temporary files, which are usually not preserved across 
           a system reboot.</li>
  <li>zroot/usr/ports: FreeBSD Ports Collection.</li>
  <li>zroot/usr/src:   FreeBSD source code for both the kernel and the userland.</li>
  <li>zroot/var/audit: Audit logging not enabled by default.</li>
  <li>zroot/var/crash: Kernel core dumps.</li>
  <li>zroot/var/tmp: Temporary files, which are usually preserved across 
               a system reboot, unless /var is a memory-based file system.</li>
</ul>

<p>Based on that, I chose to snapshot:</p>
<ul>
  <li>zroot/ROOT/default</li>
  <li>zroot/usr/home</li>
  <li>zroot/var/log</li>
  <li>zroot/var/mail</li>
</ul>

<p>Zfstools looks at the ZFS user property <code class="language-plaintext highlighter-rouge">com.sun:auto-snapshot</code> to 
determine whether to snapshot a filesystem or not.  On a new 
system, this property is unset, neither true nor false, neither 
local nor inherited.</p>

<p>From the <code class="language-plaintext highlighter-rouge">/usr/local/share/doc/zfstools/README.md</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#### Dataset setup

Only datasets with the `com.sun:auto-snapshot` property set to `true` will 
be snapshotted.

    zfs set com.sun:auto-snapshot=true DATASET
</code></pre></div></div>

<p>Use <code class="language-plaintext highlighter-rouge">zfs get com.sun:autosnapshot</code> to see its status for all ZFS 
filesystems.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ zfs get -r com.sun:auto-snapshot zroot
NAME                     PROPERTY               VALUE   SOURCE
zroot                    com.sun:auto-snapshot  -       -
zroot/ROOT               com.sun:auto-snapshot  -       -
zroot/ROOT/default       com.sun:auto-snapshot  -       -
zroot/tmp                com.sun:auto-snapshot  -       -
zroot/usr                com.sun:auto-snapshot  -       -
zroot/usr/home           com.sun:auto-snapshot  -       -
zroot/usr/ports          com.sun:auto-snapshot  -       -
zroot/usr/src            com.sun:auto-snapshot  -       -
zroot/var                com.sun:auto-snapshot  -       -
zroot/var/audit          com.sun:auto-snapshot  -       -
zroot/var/crash          com.sun:auto-snapshot  -       -
zroot/var/log            com.sun:auto-snapshot  -       -
zroot/var/mail           com.sun:auto-snapshot  -       -
zroot/var/tmp            com.sun:auto-snapshot  -       -
</code></pre></div></div>

<p>Set the ZFS property <code class="language-plaintext highlighter-rouge">com.sun:auto-snapshot</code> to false on ZFS filesystems 
that you don’t want <code class="language-plaintext highlighter-rouge">zfstools</code> to snapshot.  In this example, 
the command is:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo zfs set \
com.sun:auto-snapshot=false \
zroot/tmp \
zroot/usr/ports \
zroot/usr/src \
zroot/var/audit \
zroot/var/crash \
zroot/var/tmp
</code></pre></div></div>

<p>See <code class="language-plaintext highlighter-rouge">zfs-set(8)</code>, <code class="language-plaintext highlighter-rouge">zfs-inherit(8)</code>, and the “User Properties” section 
of <code class="language-plaintext highlighter-rouge">zfsprops(8)</code> for details.</p>

<p>Next, turn on snapshotting for the rest of the pool:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo zfs set com.sun:auto-snapshot=true zroot
</code></pre></div></div>

<p>Now the <code class="language-plaintext highlighter-rouge">com.sun:autosnapshot</code> property for all ZFS filesystems looks like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ zfs get -r com.sun:auto-snapshot zroot
NAME                     PROPERTY               VALUE   SOURCE
zroot                    com.sun:auto-snapshot  true    local
zroot/ROOT               com.sun:auto-snapshot  true    inherited from zroot
zroot/ROOT/default       com.sun:auto-snapshot  true    inherited from zroot
zroot/tmp                com.sun:auto-snapshot  false   local
zroot/usr                com.sun:auto-snapshot  true    inherited from zroot
zroot/usr/home           com.sun:auto-snapshot  true    inherited from zroot
zroot/usr/ports          com.sun:auto-snapshot  false   local
zroot/usr/src            com.sun:auto-snapshot  false   local
zroot/var                com.sun:auto-snapshot  true    inherited from zroot
zroot/var/audit          com.sun:auto-snapshot  false   local
zroot/var/crash          com.sun:auto-snapshot  false   local
zroot/var/log            com.sun:auto-snapshot  true    inherited from zroot
zroot/var/mail           com.sun:auto-snapshot  true    inherited from zroot
zroot/var/tmp            com.sun:auto-snapshot  false   local
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">zfstools</code> relies on <code class="language-plaintext highlighter-rouge">zfs-auto-snapshot</code> and <code class="language-plaintext highlighter-rouge">zfs-cleanup-snapshots</code>, 
which are located in <code class="language-plaintext highlighter-rouge">/usr/local/sbin/</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ command -v zfs-auto-snapshot; type zfs-auto-snapshot; \
whereis zfs-auto-snapshot; which zfs-auto-snapshot
/usr/local/sbin/zfs-auto-snapshot
zfs-auto-snapshot is /usr/local/sbin/zfs-auto-snapshot
zfs-auto-snapshot: /usr/local/sbin/zfs-auto-snapshot
/usr/local/sbin/zfs-auto-snapshot
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ command -v zfs-cleanup-snapshots; type zfs-cleanup-snapshots \
? whereis zfs-cleanup-snapshots; which zfs-cleanup-snapshots
/usr/local/sbin/zfs-cleanup-snapshots
zfs-cleanup-snapshots is /usr/local/sbin/zfs-cleanup-snapshots
whereis is /usr/bin/whereis
zfs-cleanup-snapshots is a tracked alias for /usr/local/sbin/zfs-cleanup-snapshots
/usr/local/sbin/zfs-cleanup-snapshots
</code></pre></div></div>

<p>To get a brief usage message for these two tools:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ /usr/local/sbin/zfs-auto-snapshot usage
Usage: /usr/local/sbin/zfs-auto-snapshot [-dknpuv] &lt;INTERVAL&gt; &lt;KEEP&gt;
    -d              Show debug output.
    -k              Keep zero-sized snapshots.
    -n              Do a dry-run. Nothing is committed. Only show what would be done.
    -p              Create snapshots in parallel.
    -P pool         Act only on the specified pool.
    -u              Use UTC for snapshots.
    -v              Show what is being done.
    INTERVAL        The interval to snapshot.
    KEEP            How many snapshots to keep.
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ /usr/local/sbin/zfs-cleanup-snapshots usage
Usage: /usr/local/sbin/zfs-cleanup-snapshots [-dnv]
    -d              Show debug output.
    -n              Do a dry-run. Nothing is committed. Only show what would be done.
    -p              Create snapshots in parallel.
    -P pool         Act only on the specified pool.
    -v              Show what is being done.
</code></pre></div></div>

<p>The pkg-message for <code class="language-plaintext highlighter-rouge">zfstools</code> gives an example for enabling automatic 
snapshots by placing a set of cron commands into <strong>/etc/crontab</strong>, which 
is the system crontab.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ pkg info --pkg-message --regex zfstools
zfstools-0.3.6_2:
On install:
To enable automatic snapshots, place lines such as these into /etc/crontab:

    PATH=/etc:/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin
    15,30,45 * * * * root /usr/local/sbin/zfs-auto-snapshot frequent  4
    0        * * * * root /usr/local/sbin/zfs-auto-snapshot hourly   24
    7        0 * * * root /usr/local/sbin/zfs-auto-snapshot daily     7
    14       0 * * 7 root /usr/local/sbin/zfs-auto-snapshot weekly    4
    28       0 1 * * root /usr/local/sbin/zfs-auto-snapshot monthly  12

This will keep 4 15-minutely snapshots, 24 hourly snapshots, 7 daily snapshots,
4 weekly snapshots and 12 monthly snapshots. Any resulting zero-sized snapshots
will be automatically cleaned up.

Enable snapshotting on a dataset or top-level pool with:

    zfs set com.sun:auto-snapshot=true DATASET

Children datasets can be disabled for snapshot with:

    zfs set com.sun:auto-snapshot=false DATASET

Or for specific intervals:

    zfs set com.sun:auto-snapshot:frequent=false DATASET

See website and command usage output for further details.
</code></pre></div></div>

<p>The FreeBSD Handbook, Section <a href="https://docs.freebsd.org/en/books/handbook/config/#configtuning-cron">12.3. Configuring cron(8)</a> (retrieved on Mar 19, 2022) advises against modifying the system crontab.  Instead, it recommends using user crontabs.</p>

<p>Order of <code class="language-plaintext highlighter-rouge">crontab</code> fields (also see <code class="language-plaintext highlighter-rouge">man 5 crontab</code>):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ grep command /etc/crontab
#minute hour    mday    month   wday    who     command
</code></pre></div></div>

<p><strong>NOTE:</strong>
From the FreeBSD Handbook:</p>
<blockquote>
  <p>The format of the system crontab, <strong>/etc/crontab</strong> includes a <strong>who</strong> column 
which does not exist in user crontabs.</p>
</blockquote>

<p>Create a user crontab for the root user.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo crontab -e -u root
</code></pre></div></div>

<p>Check the root user crontab schedule:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo crontab -l
SHELL=/bin/sh
PATH=/etc:/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin

#minute  hour mday month wday command
15,30,45 *    *    *     *    /usr/local/sbin/zfs-auto-snapshot frequent  4
0        *    *    *     *    /usr/local/sbin/zfs-auto-snapshot hourly   24
7        0    *    *     *    /usr/local/sbin/zfs-auto-snapshot daily     7
14       0    *    *     7    /usr/local/sbin/zfs-auto-snapshot weekly    4
28       0    1    *     *    /usr/local/sbin/zfs-auto-snapshot monthly  12
</code></pre></div></div>

<h2 id="preparing-the-backup-drive">Preparing the Backup Drive</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ freebsd-version
13.0-RELEASE-p7
</code></pre></div></div>

<p>Connect one end of the USB cable to your system and the other end to 
the hard drive.</p>

<p>Use <code class="language-plaintext highlighter-rouge">dmseg</code> to find the external drive’s device node name (in this 
example, <code class="language-plaintext highlighter-rouge">da0</code>) and use <code class="language-plaintext highlighter-rouge">gpart destroy</code> to remove any old partition 
table that might be on the drive.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ dmesg | tail -25
[...]
ugen0.4: &lt;Western Digital easystore 264D&gt; at usbus0
umass0 on uhub0
umass0: &lt;Western Digital easystore 264D, class 0/0, rev 3.10/30.12, addr 58&gt; on usbus0
umass0:  SCSI over Bulk-Only; quirks = 0xc001
umass0:7:0: Attached to scbus7
da0 at umass-sim0 bus 0 scbus7 target 0 lun 0
da0: &lt;WD easystore 264D 3012&gt; Fixed Direct Access SPC-4 SCSI device
da0: Serial Number 123D45678901234B
da0: 400.000MB/s transfers
da0: 13351936MB (27344764928 512 byte sectors)
da0: quirks=0x2&lt;NO_6_BYTE&gt;
ses1 at umass-sim0 bus 0 scbus7 target 0 lun 1
ses1: &lt;WD SES Device 3012&gt; Fixed Enclosure Services SPC-4 SCSI device
ses1: Serial Number 123D45678901234B
ses1: 400.000MB/s transfers
ses1: SES Device
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ dmesg | grep -i easy | grep -i store
ugen0.4: &lt;Western Digital easystore 264D&gt; at usbus0
umass0: &lt;Western Digital easystore 264D, class 0/0, rev 3.10/30.12, addr 3&gt; on usbus0
da0: &lt;WD easystore 264D 3012&gt; Fixed Direct Access SPC-4 SCSI device
ugen0.4: &lt;Western Digital easystore 264D&gt; at usbus0
umass0: &lt;Western Digital easystore 264D, class 0/0, rev 3.10/30.12, addr 3&gt; on usbus0
da0: &lt;WD easystore 264D 3012&gt; Fixed Direct Access SPC-4 SCSI device
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo usbconfig show_ifdrv | grep umass0
ugen0.4.0: umass0: &lt;Western Digital easystore 264D, class 0/0, rev 3.10/30.12, addr 58&gt;
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo usbconfig dump_info | grep ugen0.4
ugen0.4: &lt;Western Digital easystore 264D&gt; at usbus0, cfg=0 md=HOST spd=SUPER (5 Gbps) pwr=ON (2mA)
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo usbconfig list | grep ugen0.4
ugen0.4: &lt;Western Digital easystore 264D&gt; at usbus0, cfg=0 md=HOST spd=SUPER (5 Gbps) pwr=ON (2mA)
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo camcontrol devlist
---- snip ----
&lt;WD easystore 264D 3012&gt;           at scbus7 target 0 lun 0 (da0,pass3)
---- snip ----
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ geom disk list
---- snip ----
Geom name: da0
Providers:
1. Name: da0
   Mediasize: 14000519643136 (13T)
   Sectorsize: 512
   Stripesize: 4096
   Stripeoffset: 0
   Mode: r0w0e0
   descr: WD easystore 264D
   lunname: WD      easystore 264D  9MH60Y1K
   lunid: 5000cca290d0d53f
   ident: 394D48363059314B
   rotationrate: 7200
   fwsectors: 63
   fwheads: 255
---- snip ----
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ gpart list | grep -w da0
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ gpart list da0
[...]
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ gpart show | grep -w da0
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ gpart show da0
[...]
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ glabel list | grep da0
</code></pre></div></div>

<p>This is a brand new disk so <code class="language-plaintext highlighter-rouge">gpart list &lt;geom_name&gt;</code> complains:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ glabel list da0
glabel: Class 'LABEL' does not have an instance named 'da0'.
</code></pre></div></div>

<p>Similarly, <code class="language-plaintext highlighter-rouge">gpart destroy</code> complains too:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo gpart destroy -F da0
gpart: arg0 'da0': Invalid argument
</code></pre></div></div>

<p><strong>NOTE:</strong>  If the disk was previously configured and in use
(that is, it had a partitioning scheme on it),
the <code class="language-plaintext highlighter-rouge">gpart destroy -F &lt;geom_name&gt;</code> command 
would destroy the geom and report <code class="language-plaintext highlighter-rouge">&lt;geom_name&gt; destroyed</code>.</p>

<p><strong>NOTE:</strong> <br />
Q: Why the use of <code class="language-plaintext highlighter-rouge">gpart destroy -F &lt;geom_name&gt;</code> command? <br />
A: From the manpage for <code class="language-plaintext highlighter-rouge">gpart(8)</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Rather than deleting each partition and then destroying the partitioning
scheme, the -F option can be given with destroy to delete all of the
partitions before destroying the partitioning scheme.  This is equivalent
to the previous example:
  
      /sbin/gpart destroy -F da0
</code></pre></div></div>

<p>After <code class="language-plaintext highlighter-rouge">gpart destroy</code> (or with a brand new hard disk drive):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ gpart show da0
gpart: No such geom: da0.
 
$ gpart list da0
gpart: Class 'PART' does not have an instance named 'da0'.
</code></pre></div></div>

<p>First, create a GPT partition table (partition table with <strong>gpt</strong> partitioning 
scheme) on disk <code class="language-plaintext highlighter-rouge">da0</code>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo gpart create -s gpt da0
da0 created
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ gpart show da0
=&gt;         40  27344764848  da0  GPT  (13T)
           40  27344764848       - free -  (13T)
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ gpart list da0 | wc -l
      17
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ gpart list da0
Geom name: da0
---- snip ----
</code></pre></div></div>

<p>Having created a partitioning scheme on the disk, you now can create 
a new ZFS partition (on disk <code class="language-plaintext highlighter-rouge">da0</code>, on 1MB boundaries).  In this example, 
I decided to use a label named <strong>external</strong>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo gpart add -a 1m -l external -t freebsd-zfs da0
da0p1 added
</code></pre></div></div>

<p>Explanation:</p>
<ul>
  <li>
    <p>The FreeBSD Handbook, Section <a href="https://docs.freebsd.org/en/books/handbook/disks/#disks-adding">18.2. Adding Disks</a> (retrieved on Mar 19, 2022) recommends alignment on 1MB boundaries:</p>

    <blockquote>
      <p>To improve performance on newer disks with larger hardware block sizes, 
the partition is aligned to one megabyte boundaries.</p>
    </blockquote>
  </li>
  <li>
    <p>From the manpage for <code class="language-plaintext highlighter-rouge">gpart(8)</code>, under section PARTITION TYPES:</p>

    <blockquote>
      <p>freebsd-zfs:    A FreeBSD partition that contains a ZFS volume.</p>
    </blockquote>
  </li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ gpart show da0
=&gt;         40  27344764848  da0  GPT  (13T)
           40         2008       - free -  (1.0M)
         2048  27344760832    1  freebsd-zfs  (13T)
  27344762880         2008       - free -  (1.0M)
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ gpart list da0 | wc -l
      34
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ gpart list da0
Geom name: da0
---- snip ----
scheme: GPT
Providers:
1. Name: da0p1
   Mediasize: 14000517545984 (13T)
   Sectorsize: 512
   Stripesize: 4096
---- snip ----
   label: external
---- snip -----
   type: freebsd-zfs
---- snip ----
Consumers:
1. Name: da0
   Mediasize: 14000519643136 (13T)
   Sectorsize: 512
   Stripesize: 4096
---- snip ----
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ls -lh /dev/gpt/external
crw-r-----  1 root  operator  0x1dd Mar 19 15:53 /dev/gpt/external 
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ date
Sat 19 Mar 2022 15:53:28 PDT
</code></pre></div></div>

<p>To use the <code class="language-plaintext highlighter-rouge">geli(8)</code> utility, you first need to load the <code class="language-plaintext highlighter-rouge">GEOM_ELI</code> module.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo geli load
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ geli status
</code></pre></div></div>

<p>To load the GEOM_ELI module at boot time, add the following line to your <code class="language-plaintext highlighter-rouge">loader.conf(5)</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ printf %s\\n 'geom_eli_load="YES"' | sudo tee -a /boot/loader.conf
</code></pre></div></div>

<p>Create an encrypted provider (initialize a provider which is going to be 
encrypted with a passphrase) on the disk. <br />
Use the AES-XTS encryption algorithm (the default and recommended by the 
manpage for <code class="language-plaintext highlighter-rouge">geli(8)</code> - here used explicitely for the sake of this example), 
key length of 256, and 4kB sector size.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo geli init -e AES-XTS -l 256 -s 4096 "/dev/gpt/external"
Enter new passphrase:
Reenter new passphrase:
</code></pre></div></div>

<p>Output:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Metadata backup for provider /dev/gpt/external can be found in 
  /var/backups/gpt_external.eli
and can be restored with the following command:

        # geli restore /var/backups/gpt_external.eli /dev/gpt/external
</code></pre></div></div>

<p>Attach the provider (in this example, <code class="language-plaintext highlighter-rouge">/dev/gpt/external</code>).</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo geli attach /dev/gpt/external
Enter passphrase:
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ geli status
            Name  Status  Components
gpt/external.eli  ACTIVE  gpt/external
</code></pre></div></div>

<p>List all available ZFS pools on the system before adding a new zpool:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ zpool list
NAME    SIZE  ALLOC   FREE  CKPOINT  EXPANDSZ   FRAG    CAP  DEDUP    HEALTH  ALTROOT
zroot   928G   189G   739G        -         -     6%    20%  1.00x    ONLINE  -
</code></pre></div></div>

<p>Create a new zpool in the geli partition called <strong>external</strong>. 
Name the new pool <strong>external</strong>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo zpool create external gpt/external.eli
</code></pre></div></div>

<p>It’s possible to use the pool named <strong>external</strong> as the destination for 
<code class="language-plaintext highlighter-rouge">zxfer</code> directly; however, in this example create a new dataset inside 
the pool, and name it after the source machine’s hostname.  This will 
help identify backup data and allow multiple hosts to back up to the 
same drive.  Since the source machine’s hostname in this example 
is <strong>fbsd1</strong>, the backup destination for zxfer will be <strong>backup/fbsd1</strong>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ hostname
fbsd1.mydomain.com
</code></pre></div></div>

<p>Trim off any domain information from the printed name of the current host:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ hostname -s
fbsd1
</code></pre></div></div>

<p>The list of all available ZFS pools on the system now includes the new 
zpool (named <strong>external</strong>):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ zpool list
NAME       SIZE  ALLOC   FREE  CKPOINT  EXPANDSZ   FRAG    CAP  DEDUP    HEALTH  ALTROOT
external  12.7T   468K  12.7T        -         -     0%     0%  1.00x    ONLINE  -
zroot      928G   189G   739G        -         -     6%    20%  1.00x    ONLINE  -
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ zfs list
NAME                 USED  AVAIL     REFER  MOUNTPOINT
external             372K  12.3T       96K  /external
zroot                176G   723G       88K  /zroot
---- snip ----
</code></pre></div></div>

<p>Create a ZFS dataset (file system) named <strong>external/fbsd1</strong>. <sup><a href="#footnotes">2</a></sup></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo zfs create external/fbsd1
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ zfs list
NAME                 USED  AVAIL     REFER  MOUNTPOINT
external             504K  12.3T       96K  /external
external/fbsd1        96K  12.3T       96K  /external/fbsd1
zroot                189G   710G       88K  /zroot
---- snip ----
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo zpool import
no pools available to import
</code></pre></div></div>

<p>Run <code class="language-plaintext highlighter-rouge">zpool export</code> and <code class="language-plaintext highlighter-rouge">geli detach</code> to simulate the drive removal from 
the system.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo zpool export external
</code></pre></div></div>

<p>Confirm that the zpool named <strong>external</strong> has been exported:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ zpool list
NAME    SIZE  ALLOC   FREE  CKPOINT  EXPANDSZ   FRAG    CAP  DEDUP    HEALTH  ALTROOT
zroot   928G   189G   739G        -         -     6%    20%  1.00x    ONLINE  -
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo zpool import
   pool: external
     id: 1234567890123456789
  state: ONLINE
 action: The pool can be imported using its name or numeric identifier.
 config:

        external            ONLINE
          gpt/external.eli  ONLINE
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% geli status
            Name  Status  Components
gpt/external.eli  ACTIVE  gpt/external
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo geli detach /dev/gpt/external
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ geli status
</code></pre></div></div>

<p>Disconnect the external drive from the system.</p>

<h2 id="performing-the-first-backup">Performing the First Backup</h2>

<p>Connect one end of the USB cable to your system and the other end to 
the hard drive.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ geli status
</code></pre></div></div>

<p>Attach the provider (in this example, <code class="language-plaintext highlighter-rouge">/dev/gpt/external</code>) with <code class="language-plaintext highlighter-rouge">geli(8)</code>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo geli attach /dev/gpt/external
Enter passphrase: 
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ geli status
            Name  Status  Components
gpt/external.eli  ACTIVE  gpt/external
</code></pre></div></div>

<p>Import the zpool named <strong>external</strong>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo zpool import
   pool: external
     id: 1234567890123456789
  state: ONLINE
 action: The pool can be imported using its name or numeric identifier.
 config:

        external            ONLINE
          gpt/external.eli  ONLINE
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo zpool import external
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ zpool list
NAME       SIZE  ALLOC   FREE  CKPOINT  EXPANDSZ   FRAG    CAP  DEDUP    HEALTH  ALTROOT
external  12.7T   696K  12.7T        -         -     0%     0%  1.00x    ONLINE  -
zroot      928G   189G   739G        -         -     6%    20%  1.00x    ONLINE  -
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ zfs list
NAME                 USED  AVAIL     REFER  MOUNTPOINT
external             588K  12.3T       96K  /external
external/fbsd1        96K  12.3T       96K  /external/fbsd1
zroot                189G   710G       88K  /zroot
---- snip ----
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ls -alh /external/
total 10
drwxr-xr-x   3 root  wheel     3B Mar 19 15:59 .
drwxr-xr-x  21 root  wheel    28B Mar 19 16:06 ..
drwxr-xr-x   2 root  wheel     2B Mar 19 15:59 fbsd1

$ ls -alh /external/fbsd1/
total 1
drwxr-xr-x  2 root  wheel     2B Mar 19 15:59 .
drwxr-xr-x  3 root  wheel     3B Mar 19 15:59 ..
</code></pre></div></div>

<p>In the manpage for <code class="language-plaintext highlighter-rouge">zxfer(8)</code>, the first example (<strong>Ex1 - Backup a pool
(including snapshots and properties)</strong>) offers a use case for replicating
the entire <code class="language-plaintext highlighter-rouge">zroot</code> pool from the host system to the backup drive.</p>

<p>Use <code class="language-plaintext highlighter-rouge">zfs list | awk</code> to confirm that none of the dataset names 
contain spaces. <sup><a href="#footnotes">3</a></sup></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ zfs list -H | \
cut -f1 | \
awk '/[[:space:]]/{printf("Error! Dataset name contains spaces: %s\n",$0)}'
</code></pre></div></div>

<p>Switch to the root user.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ su
Password:
# 
</code></pre></div></div>

<p>The root user’s shell is <code class="language-plaintext highlighter-rouge">csh</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ps $$
  PID TT  STAT    TIME COMMAND
17578  4  S    0:00.01 _su (csh)
 
# printf %s\\n "$SHELL"
/bin/csh
</code></pre></div></div>

<p>So, for defining shell variables, you need to use the <code class="language-plaintext highlighter-rouge">set</code> built-in shell command.</p>

<p>As per <a href="https://thornton2.com/unix/freebsd/geli-encrypted-usb-backup.html">GELI Encrypted USB Backup of ZFS Filesystems in FreeBSD 13</a> (Retrieved on 
Mar 19, 2022), exclude the following ZFS properties 
(note: I’m not excluding <code class="language-plaintext highlighter-rouge">com.sun:auto-snapshot:015m</code>).</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># set exclude="com.sun:auto-snapshot"
# set exclude="${exclude},objsetid"
# set exclude="${exclude},keylocation"
# set exclude="${exclude},keyformat"
# set exclude="${exclude},pbkdf2iters"
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># printf %s\\n "$exclude"
com.sun:auto-snapshot,objsetid,keylocation,keyformat,pbkdf2iters
</code></pre></div></div>

<p><a href="#enabling-automatic-zfs-filesystem-snapshotting">At the beginning</a>, 
you set <code class="language-plaintext highlighter-rouge">com.sun:auto-snapshot</code> property to true for any dataset that you 
want the <code class="language-plaintext highlighter-rouge">zfstools</code> to snapshot.  When running <code class="language-plaintext highlighter-rouge">zxfer</code> to copy snapshots 
to a locally-mounted backup pool, you need to use the <code class="language-plaintext highlighter-rouge">-I</code> option for 
properties that will be ignored in order to prevent that property from 
being copied to the backup data.  If this option is not specified, <code class="language-plaintext highlighter-rouge">zxfer</code> 
will copy the property to the data in the backup pool and the system will 
begin taking snapshots of the backup data, which can prevent files from 
replicating properly.  This option may not be necessary for replication 
to a remote server or if the backup is only applied to specific datasets 
rather than the entire <code class="language-plaintext highlighter-rouge">zroot</code>.</p>

<p>Confirm that the file system <code class="language-plaintext highlighter-rouge">external/fbsd1</code> is mounted:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># df -hT
Filesystem      Type       Size    Used   Avail Capacity  Mounted on
[...]
external        zfs        1.8T     96K    1.8T     0%    /external
external/fbsd1  zfs        1.8T     96K    1.8T     0%    /external/fbsd1
</code></pre></div></div>

<p>Backup the pool <code class="language-plaintext highlighter-rouge">zroot</code> to <code class="language-plaintext highlighter-rouge">external/fbsd1</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># zxfer -dFkPv -I $exclude -R zroot external/fbsd1
---- snip ----
</code></pre></div></div>

<p>From the manpage for <code class="language-plaintext highlighter-rouge">zxfer(8)</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     Modifying an example first is a good way to start using the script, as
     there are some options (e.g. -d and -F in normal mode) that are in
     practice always used.

[...]

EXAMPLES
     Note that some of these example commands are lengthy, so be sure to fix
     the line wrapping appropriately. Also if you wonder why zxfer isn't
     transferring anything, please read the section titled SNAPSHOTS.
  
  Ex1 - Backup a pool (including snapshots and properties)
[...] 

                [-d] deleting stale snapshots that don't exist on the source
                (e.g. if using a snapshot management script such as
                zfs-snapshot-mgmt(8), snapshots are regularly taken and
                regularly deleted to leave a range of frequencies of snapshots
                at different vintages. If you are regularly backing up to
                another pool which is stored off-site as is highly recommended,
                you may want to delete the stale snapshots on the backup pool
                without having to manage the snapshots there too. This is
                especially true for those pools that are usually not connected
                to a machine, e.g. if you are using HDD as backup media. Note
                that zfs send will also refuse to work if you have newer
                snapshots on destination than the most recent common snapshot
                on both, so it's easier to just enable it.)

                [-F] forcing a rollback of destination to the most recent
                snapshot. Given even mounting the filesystem will cause a
                change and hence cause zfs receive to fail with an error,
                enabling this is the way to go. Otherwise you would be
                modifying(!) a backup, wanting to keep the changes you are
                making(!?) and also wanting to copy more stuff to the backup
                (hence it's still being used as a backup)... well if that's
                what you want then don't use this option.

                [-k] storing the original filesystem properties in the file
                external/fbsd1/.zxfer_backup_info.zroot

                [-P] copying across the properties of each filesystem

                [-v] seeing lots of output (verbose)
</code></pre></div></div>

<p>For this example, it took around 35 minutes to complete.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ls -alh /external/fbsd1/
total 34
drwxr-xr-x  3 root  wheel     4B Mar 19 16:53 .
drwxr-xr-x  3 root  wheel     3B Mar 19 15:59 ..
-rw-r--r--  1 root  wheel    28K Mar 19 16:53 .zxfer_backup_info.zroot
drwxr-xr-x  7 root  wheel     7B Mar 19 16:53 zroot
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ zfs list
NAME                                USED  AVAIL     REFER  MOUNTPOINT
external                           37.7G  12.3T       96K  /external
external/fbsd1                     37.7G  12.3T      136K  /external/fbsd1
external/fbsd1/zroot               37.7G  12.3T      152K  /external/fbsd1/zroot
---- snip ----
zroot                               189G   710G       88K  /zroot
zroot/ROOT                         58.5G   710G       88K  none
---- snip ---
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ df -hT
Filesystem                         Type       Size    Used   Avail Capacity  Mounted on
zroot/ROOT/default                 zfs        763G     53G    710G     7%    /
---- snip ----
external                           zfs         12T     96K     12T     0%    /external
external/fbsd1                     zfs         12T    136K     12T     0%    /external/fbsd1
external/fbsd1/zroot               zfs         12T    152K     12T     0%    /external/fbsd1/zroot
---- snip ----
</code></pre></div></div>

<p>You can now scrub the external backup drive to make sure everything is good.
(From the manpage for <code class="language-plaintext highlighter-rouge">zpool-scrub(8)</code>: for the option <code class="language-plaintext highlighter-rouge">-w</code> :  Wait until 
scrub has completed before returning.  This is so you to know when you 
get the shell prompt back that the scrube is done.)  The scrub takes at least 
as long as the first backup because it examines all data in the external 
pool to verify that it checksums correctly.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo zpool scrub -w external
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">zpool status</code> command reports the progress of the scrub.
From a separate shell:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ zpool status external
  pool: external
 state: ONLINE
  scan: scrub in progress since Sat Mar 19 19:42:44 2022
        69.2G scanned at 68.2M/s, 32.7G issued at 32.2M/s, 69.2G total
        0B repaired, 47.27% done, 00:19:20 to go
config:

        NAME                STATE     READ WRITE CKSUM
        external            ONLINE       0     0     0
          gpt/external.eli  ONLINE       0     0     0

errors: No known data errors
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ zpool list
NAME       SIZE  ALLOC   FREE  CKPOINT  EXPANDSZ   FRAG    CAP  DEDUP    HEALTH  ALTROOT
external  12.7T  37.7G  12.7T        -         -     0%     0%  1.00x    ONLINE  -
zroot      928G   189G   739G        -         -     6%    20%  1.00x    ONLINE  -
</code></pre></div></div>

<p>When the scrub is done:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% zpool status external
  pool: external
 state: ONLINE
  scan: scrub repaired 0B in 00:35:28 with 0 errors on Sat Mar 19 20:18:12 2022
config:

        NAME                STATE     READ WRITE CKSUM
        external            ONLINE       0     0     0
          gpt/external.eli  ONLINE       0     0     0

errors: No known data errors
</code></pre></div></div>

<h2 id="scripting-the-regular-backup">Scripting the Regular Backup</h2>

<p>Download the script <code class="language-plaintext highlighter-rouge">extbackup.sh</code>:</p>
<ul>
  <li><a href="http://localhost:4000/assets/txt/extbackup.sh">extbackup.sh</a></li>
</ul>

<p>Remember to edit the line <code class="language-plaintext highlighter-rouge">backupdev="da0"</code>, and replace <code class="language-plaintext highlighter-rouge">da0</code> with the 
drive matching your system.</p>

<p>Now when it comes time to run a backup, all you have to do is plug in the
external backup drive, get root, and run <code class="language-plaintext highlighter-rouge">./extbackup.sh</code>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo ./extbackup.sh
[ OK ]  Attaching external backup drive.
Enter passphrase: 
[ OK ]  Importing external pool.
[ OK ]  Mounting 'external/fbsd1'.
[ OK ]  Commencing backup.
[...]
</code></pre></div></div>

<p>When it’s done, the script also unmounts the external backup drive and 
does geli detach.  After that unplug the external backup drive and put it away.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ zpool list | grep external
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ zfs list | grep external
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo zpool import
no pools available to import
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ geli status
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ df -hT | grep external
</code></pre></div></div>

<h2 id="performing-subsequent-backups">Performing Subsequent Backups</h2>

<p>Attach the external hard disk drive to the system.</p>

<p>Run the external backup script <code class="language-plaintext highlighter-rouge">./extbackup.sh</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo ./extbackup.sh
[ OK ]  Attaching external backup drive.
Enter passphrase: 
[ OK ]  Importing external pool.
[ OK ]  Mounting 'external/fbsd1'.
[ OK ]  Commencing backup.
[...]
[ OK ]  Backup completed successfully.
[ OK ]  Unmounted 'external/fbsd1' cleanly.
[ OK ]  Exporting external pool.
[ OK ]  Detaching external backup drive.
[ OK ]  Done.
</code></pre></div></div>

<h2 id="recovering-a-file-from-zfs-snapshot-on-the-external-usb-geli-encrypted-hard-disk-drive">Recovering a File from ZFS Snapshot on the External USB Geli Encrypted Hard Disk Drive</h2>

<p>If you now mount a file system on the external USB drive 
<code class="language-plaintext highlighter-rouge">external/fbsd1/somefilesystem</code> and check a file on this 
filesystem’s snapshot with for example 
<code class="language-plaintext highlighter-rouge">less /external/fbsd1/somefilesystem/.zfs/snapshot/zfs-auto-snap_hourly-2022-03-19-20h00/somefile</code>, 
you’ll see the contents of that file if it existed 
in <code class="language-plaintext highlighter-rouge">zroot/somefilesystem</code> at that time.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo geli attach /dev/gpt/external
Enter passphrase: 
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ geli status
            Name  Status  Components
gpt/external.eli  ACTIVE  gpt/external
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo zpool import
   pool: external
     id: 12345678901234567890
  state: ONLINE
 action: The pool can be imported using its name or numeric identifier.
 config:

        external            ONLINE
          gpt/external.eli  ONLINE
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo zpool import external
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo zpool import
no pools available to import
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ zfs list | grep external
external                     1.19T  11.1T     1.02T  /external
external/fbsd1                172G  11.1T      172K  /external/fbsd1
external/fbsd1/zroot          172G  11.1T      152K  /external/fbsd1/zroot
[...]
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ zpool list | grep external
external  12.7T  1.19T  11.5T      -       -    0%    9%  1.00x    ONLINE  -
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ df -hT | grep external
external                         zfs   12T   1.0T  11T  8%  /external
external/fbsd1                   zfs   11T   172K  11T  0%  /external/fbsd1
external/fbsd1/zroot             zfs   11T   152K  11T  0%  /external/fbsd1/zroot
external/fbsd1/zroot/usr/ports   zfs   11T    96K  11T  0%  /external/fbsd1/zroot/usr/ports
[...]
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ls -alh /external/fbsd1/zroot/usr/home/
total 34
drwxr-xr-x   3 root   wheel     3B Dec 26  2021 .
drwxr-xr-x   5 root   wheel     5B Mar 18 19:26 ..
drwxr-xr-x  42 dusko  dusko   112B Mar 19 20:36 dusko
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ls -alh /external/fbsd1/zroot/usr/home/.zfs/
total 1
dr-xr-xr-x+  3 root  wheel     3B Dec 24  2021 .
drwxr-xr-x   3 root  wheel     3B Dec 26  2021 ..
dr-xr-xr-x+ 28 root  wheel    28B Mar 19 19:54 snapshot
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ls -alh /external/fbsd1/zroot/usr/home/.zfs/snapshot/
total 13
dr-xr-xr-x+ 28 root wheel 28B Mar 19 19:54 .
dr-xr-xr-x+  3 root wheel  3B Dec 24  2021 ..
drwxr-xr-x   3 root wheel  3B Dec 26  2021 zfs-auto-snap_daily-2022-03-19-20h07
drwxr-xr-x   3 root wheel  3B Dec 26  2021 zfs-auto-snap_frequent-2022-03-19-19h45
[...]
drwxr-xr-x   3 root wheel  3B Dec 26  2021 zfs-auto-snap_hourly-2022-03-19-20h00
[...]
</code></pre></div></div>

<p>Unmount <code class="language-plaintext highlighter-rouge">external/fbsd1</code> after you’re done with it.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo zpool import
no pools available to import
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ zpool list | grep external
external  12.7T  1.19T  11.5T      -       -    0%    9%  1.00x    ONLINE  -
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo zpool export external
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ zpool list | grep external
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo zpool import
   pool: external
     id: 12345678901234567890
  state: ONLINE
 action: The pool can be imported using its name or numeric identifier.
 config:

        external            ONLINE
          gpt/external.eli  ONLINE
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ zfs list | grep external
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ df -hT | grep external
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ geli status
            Name  Status  Components
gpt/external.eli  ACTIVE  gpt/external
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo geli detach /dev/gpt/external
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ geli status
</code></pre></div></div>

<h2 id="add-a-backup-directory-for-a-new-host-that-you-dont-need-to-snapshot-automatically">Add a Backup Directory for a New Host that You Don’t Need to Snapshot Automatically</h2>

<p>Assumptions:</p>

<ul>
  <li>The backup drive:
    <ul>
      <li>is big enough for backing up another computer;</li>
      <li>stays plugged into the first computer;</li>
      <li>is a destination for archiving regular backups from the second computer, and snapshotting those backups is not necessary.</li>
    </ul>
  </li>
  <li>The second computer’s name: host2.mydomain.com.</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo mkdir /external/host2 
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo chown dusko /external/host2/ 
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ cd /external/host2/
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ scp dusko@host2.mydomain.com:/backup/stuff.tar.gz .
</code></pre></div></div>

<hr />

<h2 id="footnotes">Footnotes</h2>

<p>[1] For details, refer to:</p>
<ul>
  <li>FreeBSD Handbook, Section <a href="https://docs.freebsd.org/en/books/handbook/book/#dirstructure">3.5 Directory Structure</a> (Retrieved on Mar 19, 2022)</li>
  <li><code class="language-plaintext highlighter-rouge">hier(7)</code> manpage</li>
  <li>man page for <code class="language-plaintext highlighter-rouge">bsdinstall(8)</code></li>
</ul>

<p>From the man page for <code class="language-plaintext highlighter-rouge">bsdinstall(8)</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ZFSBOOT_BEROOT_NAME      Name for the boot environment parent dataset.
                         This is a non-mountable dataset meant to be a
                         parent dataset where different boot environment
                         are going to be created.  Default: "ROOT"

[...]

ZFSBOOT_BOOTFS_NAME      Name for the primary boot environment, which
                         will be the default boot environment for the
                         system.  Default: "default"

[...]

ZFSBOOT_DATASETS         ZFS datasets to be created on the root zpool, it
                         requires the following datasets: /tmp, /var/tmp,
                         /$ZFSBOOT_BEROOT_NAME/$ZFSBOOT_BOOTFS_NAME.  See
                         ZFS DATASETS for more information about who to
                         write this variable and to take a look into the
                         default value of it.

[...]

zfsboot                  Provides a ZFS-only automatic interactive disk
                         partitioner.  Creates a single zpool with
                         separate datasets for /tmp, /usr, /usr/home,
                         /usr/ports, /usr/src, and /var.  Optionally can
                         set up geli(8) to encrypt the disk.

[...]

ZFS DATASETS
  The zfsboot partitioning takes the ZFSBOOT_DATASETS variable to create
  the datasets on the base system.  This variable can get pretty huge if
  the pool contains a lot of datasets.  The default value of the
  ZFSBOOT_DATASETS looks like this:

        # DATASET       OPTIONS (comma or space separated; or both)

        # Boot Environment [BE] root and default boot dataset
        /$ZFSBOOT_BEROOT_NAME                           mountpoint=none
        /$ZFSBOOT_BEROOT_NAME/$ZFSBOOT_BOOTFS_NAME      mountpoint=/

        # Compress /tmp, allow exec but not setuid
        /tmp            mountpoint=/tmp,exec=on,setuid=off

        # Do not mount /usr so that 'base' files go to the BEROOT
        /usr            mountpoint=/usr,canmount=off

        # Home directories separated so they are common to all BEs
        /usr/home       # NB: /home is a symlink to /usr/home

        # Ports tree
        /usr/ports      setuid=off

        # Source tree (compressed)
        /usr/src

        # Create /var and friends
        /var            mountpoint=/var,canmount=off
        /var/audit      exec=off,setuid=off
        /var/crash      exec=off,setuid=off
        /var/log        exec=off,setuid=off
        /var/mail       atime=on
        /var/tmp        setuid=off

The first column if the dataset to be created on the top of the
ZFSBOOT_POOL_NAME and the rest of the columns are the options to be set
on each dataset.  The options must be written on a coma or space
separated list, or both.  And everything behind a pound/hash character is
ignored as a comment.
</code></pre></div></div>

<p>[2] From the man page for <code class="language-plaintext highlighter-rouge">zfs(8)</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>DESCRIPTION
     The zfs command configures ZFS datasets within a ZFS storage pool, as
     described in zpool(8).  A dataset is identified by a unique path within
     the ZFS namespace.  For example:
             pool/{filesystem,volume,snapshot}
  
     where the maximum length of a dataset name is MAXNAMELEN (256B) and the
     maximum amount of nesting allowed in a path is 50 levels deep.

     A dataset can be one of the following:
  
           file system  Can be mounted within the standard system namespace
                        and behaves like other file systems.  While ZFS file
                        systems are designed to be POSIX-compliant, known
                        issues exist that prevent compliance in some cases.
                        Applications that depend on standards conformance
                        might fail due to non-standard behavior when checking
                        file system free space.
  
           volume       A logical volume exported as a raw or block device.
                        This type of dataset should only be used when a block
                        device is required.  File systems are typically used
                        in most environments.
  
           snapshot     A read-only version of a file system or volume at a
                        given point in time.  It is specified as
                        filesystem@name or volume@name.

           bookmark     Much like a snapshot, but without the hold on on-disk
                        data.  It can be used as the source of a send (but not
                        for a receive).  It is specified as filesystem#name or
                        volume#name.
  
    See zfsconcepts(7) for details.
</code></pre></div></div>

<p>[3] From the man page for <code class="language-plaintext highlighter-rouge">zxfer(8)</code>:</p>

<blockquote>
  <p>Note that at present, the usage of spaces in zfs(8) filesystem names is
NOT supported. There is no plan to support it without someone else doing
the coding or a good funding proposal coming my way.</p>
</blockquote>

<hr />

<h3 id="references">References</h3>

<ul>
  <li>
    <p><a href="https://mwl.io/archives/2140">FreeBSD ZFS snapshots with zfstools</a> 
(Posted on Aug 6, 2014) (Retrieved on Mar 19, 2022)</p>
  </li>
  <li>
    <p><a href="https://thornton2.com/unix/freebsd/geli-encrypted-usb-backup.html">GELI Encrypted USB Backup of ZFS Filesystems in FreeBSD 13</a> (Posted on Dec 22, 2021 - edited on Dec 23, 2021) (Retrieved on Mar 19, 2022)</p>
  </li>
  <li>
    <p><a href="https://www.ccammack.com/posts/back-up-zfs-to-a-removable-drive-using-zxfer/">Back Up ZFS to a Removable Drive Using zxfer</a>
(Posted on Mar 30, 2020) (Retrieved on Mar 19, 2022)</p>
  </li>
</ul>
</div>
  <div class="share-page">
  <span style="float: left;">Share this on &rarr;&nbsp;&nbsp;</span>

  <!-- Twitter -->
  <a href="https://twitter.com/share" class="twitter-share-button" data-via="github.io">Tweet</a>
  <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

  <!-- Facebook -->
  <div class="fb-share-button" data-href="http://localhost:4000/zfs/freebsd/snapshot/backup/2022/03/19/freebsd-geli-encrypted-usb-external-hdd-zfs-freebsd.html" data-layout="button_count" style="position: relative; top: -8px; left: 3px;"></div>
</div>

<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.6&appId=1749788565247320";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>

</div>


  
    
      
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
    
        
          
      
          
            
            <div class="panel-body">
              <h4>Related Posts</h4>
              <ul>
            
                <li class="relatedPost">
                  <a href="http://localhost:4000/font/freebsd/unix/x11/xorg/dotfiles/2022/04/17/x-fonts.html">Fonts in X11 - aka Fonts in X (Xorg)</a>
                  
                    (Categories: <a href="/category/font">font</a>, <a href="/category/freebsd">freebsd</a>, <a href="/category/unix">unix</a>, <a href="/category/x11">x11</a>, <a href="/category/xorg">xorg</a>, <a href="/category/dotfiles">dotfiles</a>)
                  
                </li>
          
          
        
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
  
    
      
  
    
      
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
            
                <li class="relatedPost">
                  <a href="http://localhost:4000/wm/x11/xorg/freebsd/unix/dotfiles/2022/04/03/twm.html">TWM - Tab Window Manager for the X Window System</a>
                  
                    (Categories: <a href="/category/wm">wm</a>, <a href="/category/x11">x11</a>, <a href="/category/xorg">xorg</a>, <a href="/category/freebsd">freebsd</a>, <a href="/category/unix">unix</a>, <a href="/category/dotfiles">dotfiles</a>)
                  
                </li>
          
          
        
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
            
                <li class="relatedPost">
                  <a href="http://localhost:4000/howto/bhyve/virtualization/xorg/x11/freebsd/2022/03/09/bhyve-connect-to-xorg-linux-guest.html">How to Connect to Xorg in Linux Guest from Bhyve</a>
                  
                    (Categories: <a href="/category/howto">howto</a>, <a href="/category/bhyve">bhyve</a>, <a href="/category/virtualization">virtualization</a>, <a href="/category/xorg">xorg</a>, <a href="/category/x11">x11</a>, <a href="/category/freebsd">freebsd</a>)
                  
                </li>
          
          
        
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
    
        
          
      
          
            
                <li class="relatedPost">
                  <a href="http://localhost:4000/unix/freebsd/rhel/linux/howto/oneliner/sed/cli/terminal/shell/script/2022/02/27/sed-stream-editor.html">sed - Stream Editor</a>
                  
                    (Categories: <a href="/category/unix">unix</a>, <a href="/category/freebsd">freebsd</a>, <a href="/category/rhel">rhel</a>, <a href="/category/linux">linux</a>, <a href="/category/howto">howto</a>, <a href="/category/oneliner">oneliner</a>, <a href="/category/sed">sed</a>, <a href="/category/cli">cli</a>, <a href="/category/terminal">terminal</a>, <a href="/category/shell">shell</a>, <a href="/category/script">script</a>)
                  
                </li>
          
          
        
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
            
                <li class="relatedPost">
                  <a href="http://localhost:4000/freebsd/howto/diagram/java/graph/graphviz/2022/02/26/freebsd-kroki-plantuml-graphviz-diagrams.html">Create Diagrams from Textual Descriptions with Graphviz, PlantUML and Kroki</a>
                  
                    (Categories: <a href="/category/freebsd">freebsd</a>, <a href="/category/howto">howto</a>, <a href="/category/diagram">diagram</a>, <a href="/category/java">java</a>, <a href="/category/graph">graph</a>, <a href="/category/graphviz">graphviz</a>)
                  
                </li>
          
          
        
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
            
                <li class="relatedPost">
                  <a href="http://localhost:4000/freebsd/howto/diagram/java/2022/02/25/freebsd-java-kroki-diagrams.html">How to Run Kroki on FreeBSD 13 with Java</a>
                  
                    (Categories: <a href="/category/freebsd">freebsd</a>, <a href="/category/howto">howto</a>, <a href="/category/diagram">diagram</a>, <a href="/category/java">java</a>)
                  
                </li>
          
          
        
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
    
  
  
  </ul>
</div>


<div class="PageNavigation">
  
    <a class="prev" href="/unix/shell/script/cli/terminal/perl/sysadmin/2022/03/13/occasionally-revisited-code-shell-script-snippets.html">&laquo; Occasionally Revisited Code and Shell Script Snippets</a>
  
  
    <a class="next" href="/hpc/server/hardware/sysadmin/automation/configmanagement/howto/2022/03/20/xcat.html">HPC with xCAT, PBS/TORQUE, Gaussian and WebMO &raquo;</a>
  
</div>

<div class="disqus-comments">
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    /* <![CDATA[ */
    var disqus_shortname = "";
    var disqus_identifier = "http://localhost:4000_How to Setup an External GELI Encrypted USB Hard Drive as a ZFS Backup Disk in FreeBSD";
    var disqus_title = "How to Setup an External GELI Encrypted USB Hard Drive as a ZFS Backup Disk in FreeBSD";

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    /* ]]> */
  </script>
</div>

        <footer>
          <!-- &copy; Dusko Pijetlovic -->
          
            <!-- - <a href="https://github.com/duskopijetlovic">https://github.com/duskopijetlovic</a> - Powered by Jekyll. -->
          
          <div class="btn-github" style="float:right;">
            <!-- <iframe src="https://ghbtns.com/github-btn.html?user=agusmakmun&repo=agusmakmun.github.io&type=star&count=true" frameborder="0" scrolling="0" width="100" height="20px"></iframe> -->
            <!-- <iframe src="https://ghbtns.com/github-btn.html?user=agusmakmun&repo=agusmakmun.github.io&type=fork&count=true" frameborder="0" scrolling="0" width="100" height="20px"></iframe> -->
          </div>
        </footer>
      </div>
      <!-- end /.col-sm-8 -->
    </div>
    <!-- end /.container -->

    <!-- Bootstrap core JavaScript -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <script src="//code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
    <script src="/static/js/bootstrap.min.js"></script>
    <script src="/static/js/super-search.js"></script>
    <script src="/static/js/thickbox-compressed.js"></script>
    <script src="/static/js/projects.js"></script>
  </body>
</html>

