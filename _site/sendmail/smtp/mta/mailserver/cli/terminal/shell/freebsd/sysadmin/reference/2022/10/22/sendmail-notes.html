<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" href="/static/img/favicon.ico" />
    <title>Sendmail Notes [WIP] - Dusko Pijetlovic</title>
    <meta name="author" content="Dusko Pijetlovic" />
    <meta name="description" content="Sendmail Notes [WIP]" />
    <meta name="keywords" content="Sendmail Notes [WIP], Dusko Pijetlovic, sendmail, smtp, mta, mailserver, cli, terminal, shell, freebsd, sysadmin, reference" />
    <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml">
    <meta content="1749788565247320" property="fb:app_id">
    <meta content="Dusko Pijetlovic" property="og:site_name">

    

    
      <meta content="Sendmail Notes [WIP]" property="og:title">
      <meta content="article" property="og:type">
    

    
      <meta content="Dusko Pijetlovic - My Personal Web Space" property="og:description">
    

    
      <meta content="http://localhost:4000/sendmail/smtp/mta/mailserver/cli/terminal/shell/freebsd/sysadmin/reference/2022/10/22/sendmail-notes.html" property="og:url">
    

    
      <meta content="2022-10-22T09:50:18-07:00" property="article:published_time">
      <meta content="http://localhost:4000/about/" property="article:author">
    

    

    
      
        <meta content="sendmail" property="article:section">
      
    

    
      
    

    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@github.io">
    <meta name="twitter:creator" content="@github.io">

    
      <meta name="twitter:title" content="Sendmail Notes [WIP]">
    

    
      <meta name="twitter:url" content="http://localhost:4000/sendmail/smtp/mta/mailserver/cli/terminal/shell/freebsd/sysadmin/reference/2022/10/22/sendmail-notes.html">
    

    
      <meta name="twitter:description" content="Dusko Pijetlovic - My Personal Web Space">
    

    

    <!-- Font awesome icons -->
    <link href="/static/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
    <!-- syntax highlighting CSS -->
    <link rel="stylesheet" href="/static/css/syntax.css">
    <!-- Bootstrap core CSS -->
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Roboto+Condensed:400,300italic,300,400italic,700&amp;subset=latin,latin-ext" rel="stylesheet" type="text/css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/static/css/super-search.css">
    <link rel="stylesheet" href="/static/css/thickbox.css">
    <link rel="stylesheet" href="/static/css/projects.css">
    <link rel="stylesheet" href="/static/css/main.css">

    
  </head>
  <body>
    <div class="container">
      <div class="col-sm-3">
        <div class="fixed-condition">
          <h1 class="author-name"><a href="/">Dusko Pijetlovic</a></h1>
          
            <div class="profile-about">
              My personal notes where I store things I find interesting or might need in the future.
            </div>
          
          <div class="social">
            <ul>
              
                <li><a href="https://twitter.com/duskopijetlovic" target="_blank"><i class="fa fa-twitter"></i></a></li>
              
                <li><a href="https://linkedin.com/in/duskopijetlovic" target="_blank"><i class="fa fa-linkedin"></i></a></li>
              
                <li><a href="https://github.com/duskopijetlovic" target="_blank"><i class="fa fa-github"></i></a></li>
              
            </ul>
          </div>
          <div class="search" id="js-search">
            <input type="text" placeholder="(sitemap)~$ type to search" class="search__input form-control" id="js-search__input">
            <ul class="search__results" id="js-search__results"></ul>
          </div>
          <hr />
          <ul class="sidebar-nav">
            <strong>Navigation</strong>
            <li><a href="/">Home</a></li>
            
              <li><a class="about" href="/about/">About</a></li>
            
              <li><a class="about" href="/notes/index.html">Notes</a></li>
            
              <li><a class="about" href="/feed.xml">XML Feed</a></li>
            
              <li><a class="about" href="/category/categories">Categories</a></li>
            
          </ul>
        </div>
        <!-- end /.fixed-condition -->
      </div>
      <div class="col-sm-8 col-offset-1 main-layout">
        <header class="post-header">
  <h1 class="post-title">Sendmail Notes [WIP]</h1>
</header>

<span class="time">22 Oct 2022</span>

  <span class="categories">
    &raquo; <a href="/category/sendmail">sendmail</a>, <a href="/category/smtp">smtp</a>, <a href="/category/mta">mta</a>, <a href="/category/mailserver">mailserver</a>, <a href="/category/cli">cli</a>, <a href="/category/terminal">terminal</a>, <a href="/category/shell">shell</a>, <a href="/category/freebsd">freebsd</a>, <a href="/category/sysadmin">sysadmin</a>, <a href="/category/reference">reference</a>
  </span>


<div class="content">
  <div class="post"><h2 id="todo--sanitize"><strong>[TODO]:</strong>  SANITIZE!</h2>

<p>OSs: <br />
FreeBSD 13.1-RELEASE-p2 with sendmail 8.17.1, Shell: csh <br />
Red Hat Enterprise Linux Server release 6.8 (Santiago) with sendmail 8.14.4, Shell: bash</p>

<p>Restart sendmail:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># kill -HUP `head -1 /var/run/sendmail.pid`
</code></pre></div></div>

<p>From <a href="https://gist.github.com/drmalex07/d63348dc9d26d1349309">configure-sendmail-as-relay.md</a>:</p>

<p>On the mail server:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ printf "Subject: Hello\r\n\r\nI say hello"| sendmail -v -F 'Contact' someone@foo.com
</code></pre></div></div>

<h2 id="test-starttls">Test STARTTLS</h2>

<p>Reference: Bat book, 4th edition</p>

<p>Assumption: <em>sendmail</em> built with STARTTLS support.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># sendmail -bs -Am
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">-bs</code> tells <em>sendmail</em> to speak SMTP on its standard input.<br />
The <code class="language-plaintext highlighter-rouge">-Am</code> tells <em>sendmail</em> to use its server configuration file
(not <em>submit.cf</em>), even though it is running in mail-submission mode.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># sendmail -bs -Am
220 your.host.domain ESMTP mailer ready at Wed, 26 Oct 2022 19:02:10 -0700
ehlo your.host.domain
250-your.host.domain Hello root@localhost, pleased to meet you
250-ENHANCEDSTATUSCODES
250-8BITMIME
250-SIZE 52428800
250-STARTTLS
250-DELIVERBY
250 HELP
quit
221 2.0.0 your.host.domain closing connection
</code></pre></div></div>

<p>Note the line <code class="language-plaintext highlighter-rouge">250-STARTTLS</code></p>

<h2 id="test-sasl-support-in-sendmail">Test SASL support in sendmail</h2>

<p>Reference: The Bat book, 4th edition - 5.1.2.1 Test SASL support in sendmail</p>

<p>The <code class="language-plaintext highlighter-rouge">-bs</code> tells <em>sendmail</em> to speak SMTP on its standard input.<br />
The <code class="language-plaintext highlighter-rouge">-Am</code> tells <em>sendmail</em> to use its server configuration file
(not <em>submit.cf</em>), even though it is running in mail-submission mode.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># sendmail -bs -Am
220 test.host.domain ESMTP mailer ready at Wed, 26 Oct 2022 19:13:41 -0700
ehlo localhost
250-test.host.domain Hello root@localhost, pleased to meet you
250-ENHANCEDSTATUSCODES
250-8BITMIME
250-SIZE 52428800
250-STARTTLS
250-DELIVERBY
250 HELP
quit
221 2.0.0 test.host.domain closing connection
</code></pre></div></div>

<p>Look for a line with <code class="language-plaintext highlighter-rouge">250-AUTH</code>. <br />
If it’s missing, check the log file:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># grep 'Oct 26 19:13:41' /var/log/maillog | grep 'allowed mech' 
Oct 26 19:13:41 test sendmail[14440]: AUTH: available mech=GSSAPI, allowed mech=LOGIN PLAIN
</code></pre></div></div>

<p>But:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># sendmail -bs -L sm-smmsp-queue -Ac
220 test.host.domain ESMTP Sendmail 8.14.4/8.14.4/Submit; Wed, 26 Oct 2022 19:59:22 -0700
ehlo localhost
250-test.host.domain Hello root@localhost, pleased to meet you
250-ENHANCEDSTATUSCODES
250-PIPELINING
250-8BITMIME
250-SIZE
250-DSN
250-AUTH GSSAPI
250-DELIVERBY
250 HELP
quit
221 2.0.0 test.host.domain closing connection
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># grep 'Oct 26 19:59:22' /var/log/maillog
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># sendmail -bs -OLogLevel=13 -L sm-smmsp-queue -Ac
220 test.host.domain ESMTP Sendmail 8.14.4/8.14.4/Submit; Wed, 26 Oct 2022 19:59:59 -0700
ehlo localhost
250-test.host.domain Hello root@localhost, pleased to meet you
250-ENHANCEDSTATUSCODES
250-PIPELINING
250-8BITMIME
250-SIZE
250-DSN
250-AUTH GSSAPI
250-DELIVERBY
250 HELP
quit
221 2.0.0 test.host.domain closing connection
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># grep 'Oct 26 19:59:59' /var/log/maillog
Oct 26 19:59:59 test sm-smmsp-queue[23675]: NOQUEUE: connect from root@localhost
Oct 26 19:59:59 test sm-smmsp-queue[23675]: STARTTLS: ServerCertFile missing
Oct 26 19:59:59 test sm-smmsp-queue[23675]: AUTH: available mech=ANONYMOUS GSSAPI PLAIN LOGIN, allowed mech=EXTERNAL GSSAPI KERBEROS_V4 DIGEST-MD5 CRAM-MD5
Oct 26 19:59:59 test sm-smmsp-queue[23675]: 29R0xxvL023675: Milter: no active filter
</code></pre></div></div>

<h2 id="to-expand">TO EXPAND</h2>

<h3 id="1">1</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># cd /etc/mail

# make --dry-run
# make -n 
</code></pre></div></div>

<h3 id="address-test-mode--bt">Address Test Mode (<code class="language-plaintext highlighter-rouge">-bt</code>)</h3>

<p>From the man page for <em>sendmail</em>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-bt    Run in address test mode.  This mode reads addresses and shows
       the steps in parsing; it is used for debugging configuration
       tables.
</code></pre></div></div>

<p>From<br />
sendmail Cookbook - Craig Hunt <br />
2009 O’Reilly Media, Inc. <br />
1005 Gravenstein Highway North, Sebastopol, CA 95472</p>

<blockquote>
  <p><strong>1.9. Testing a New Configuration</strong></p>

  <p><strong>Problem</strong></p>

  <p>You need to test the sendmail configuration before it is deployed.</p>

  <p><strong>Solution</strong></p>

  <p>Use the <em>sendmail</em> command-line options <code class="language-plaintext highlighter-rouge">-bt</code>, <code class="language-plaintext highlighter-rouge">-bv</code>, and <code class="language-plaintext highlighter-rouge">-v</code>.</p>

  <p><strong>Discussion</strong></p>

  <p>At the end of Recipe 1.8, the newly created sendmail.cf is copied over
the old configuration.  Do not copy a customized configuration into the
<em>/etc/mail</em> directory until it is thoroughly tested.  <em>sendmail</em> provides
excellent test tools that are used extensively in this book.</p>

  <p>The single most important tool for testing sendmail is sendmail itself.
When started with the <code class="language-plaintext highlighter-rouge">-bt</code> command-line option, <em>sendmail</em> enters
<strong>test mode</strong>.  While in test mode, <em>sendmail</em> accepts a variety of
commands that examine the configuration, check settings, and observe how
email addresses are processed by sendmail.  Table 1-2 lists the commands
that are available in test mode.</p>
</blockquote>

<p>Table 1-2. sendmail test mode commands</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>+--------------------+-------------------------------------------------------+
| Command            | Usage                                                 |
+--------------------+-------------------------------------------------------+
| &lt;ruleset address&gt;  | Process the address through the comma-separated lists |
|                    | of rulesets.                                          |
+--------------------+-------------------------------------------------------+
| =S &lt;ruleset&gt;       | Display the contents of the rulesets                  |
+--------------------+-------------------------------------------------------+
| =M                 | Display all of the mailer definitions.                |
+--------------------+-------------------------------------------------------+
| $ &lt;v&gt;              | Display the value of macro &lt;v&gt;.                       |
+--------------------+-------------------------------------------------------+
| $= &lt;c&gt;             | Display the value of class &lt;c&gt;.                       |  
+--------------------+-------------------------------------------------------+
| .D &lt;vvalue&gt;        | Set the macro &lt;v&gt; to &lt;value&gt;.                         |
+--------------------+-------------------------------------------------------+
| .C &lt;cvalue&gt;        | Add &lt;value&gt; to class &lt;c&gt;.                             |  
+--------------------+-------------------------------------------------------+
| -d &lt;value&gt;         | Set the debug value to &lt;value&gt;.                       | 
+--------------------+-------------------------------------------------------+
| /tryflags &lt;flags&gt;  | Set the flags used for address processing by /try     |
+--------------------+-------------------------------------------------------+
| /try &lt;mailer&gt; &lt;ad- | Process the address for the &lt;mailer&gt;.                 |
| dress&gt;             |                                                       |
+--------------------+-------------------------------------------------------+
| /parse &lt;address&gt;   | Return the mailer/host/user delivery triple for       |
|                    | the address.                                          |  
+--------------------+-------------------------------------------------------+
| /canon &lt;hostname&gt;  | Canonify &lt;hostname&gt;.                                  |
+--------------------+-------------------------------------------------------+
| /mx &lt;hostname&gt;     | Lookup the MX records for &lt;hostname&gt;.                 |
+--------------------+-------------------------------------------------------+
| /map &lt;mapname&gt;     | Look up &lt;key&gt; in the database identify by &lt;mapname&gt;.  |
+--------------------+-------------------------------------------------------+
| /quit              | Exit address test mode.                               |
+--------------------+-------------------------------------------------------+
</code></pre></div></div>

<hr />

<p>sendmail Cookbook - Craig Hunt<br />
2009 O’Reilly Media, Inc.<br />
1005 Gravenstein Highway North, Sebastopol, CA 95472</p>

<p>https://learning.oreilly.com/library/view/sendmail-cookbook/0596004710/ch03.html#sendmailckbk-CHP-3-SECT-1</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># cat &gt; special-test
               /parse tyler@science.foo.edu
               /parse sara@crab
               /parse craig
               CTRL-D
# sendmail -bt &lt; special-test | grep '^mailer'
mailer relay, host smtp.wrotethebook.com, user tyler@science.foo.edu
mailer relay, host smtp.wrotethebook.com, user sara@crab.wrotethebook.com
mailer local, user craig
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># sendmail -bv dusko -C/etc/mail/sendmail.cf
-C/etc/mail/sendmail.cf... User unknown
dusko... deliverable: mailer local, user dusko

# sendmail -bv dusko@some.domain -C/etc/mail/sendmail.cf
-C/etc/mail/sendmail.cf... User unknown
dusko@some.domain... deliverable: mailer local, user dusko

# sendmail -bv duskop@some.domain -C/etc/mail/sendmail.cf
-C/etc/mail/sendmail.cf... User unknown
duskop@some.domain ... deliverable: mailer esmtp, host mail.some.domain., user duskop@mail.some.comain

# sendmail -bv dusko_pijetlovic@yahoo.ca -C/etc/mail/sendmail.cf
-C/etc/mail/sendmail.cf... User unknown
dusko_pijetlovic@yahoo.ca... deliverable: mailer esmtp, host yahoo.ca., user dusko_pijetlovic@yahoo.ca
</code></pre></div></div>

<p>The content of the <code class="language-plaintext highlighter-rouge">relay-domains</code> file (in the following example it’s empty):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># sendmail -bt
ADDRESS TEST MODE (ruleset 3 NOT automatically invoked)
Enter &lt;ruleset&gt; &lt;address&gt;
&gt; $=R
&gt; /quit
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># service sendmail status
sendmail (pid  538) is running...
sm-client (pid  547) is running...
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ps aux | grep -v grep | grep 538 
root       538  0.0  0.0  88884  3580 ?        Ss   Oct24   0:24 sendmail: accepting connections
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ps aux | grep -v grep | grep 547 
smmsp      547  0.0  0.0  78260  2116 ?        Ss   Oct24   0:00 sendmail: Queue runner@00:05:00 for /var/spool/clientmqueue
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># cat /var/run/sendmail.pid 
538
/usr/sbin/sendmail -bd -q5m
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># grep -r sendmail /etc/rc* | grep '\-bd'
/etc/rc.d/init.d/sendmail:    daemon /usr/sbin/sendmail $([ "x$DAEMON" = xyes ] &amp;&amp; echo -bd) \

# grep -r sendmail /etc/init* | grep '\-bd'
/etc/init.d/sendmail:    daemon /usr/sbin/sendmail $([ "x$DAEMON" = xyes ] &amp;&amp; echo -bd) \
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># grep -r sendmail /etc/rc* | grep Ac
/etc/rc.d/init.d/sendmail:      daemon --check sm-client /usr/sbin/sendmail -L sm-msp-queue -Ac \

# grep -r sendmail /etc/init* | grep Ac
/etc/init.d/sendmail:   daemon --check sm-client /usr/sbin/sendmail -L sm-msp-queue -Ac \
</code></pre></div></div>

<blockquote>
  <p>The <code class="language-plaintext highlighter-rouge">-bd</code> option line causes sendmail to run as a daemon and listen 
for incoming mail on ports 25 and 587.  This first command creates the 
sendmail daemon that reads the <em>sendmail.cf</em> configuration file and 
runs in the traditional role of a mail transfer agent (MTA). 
The second command starts sendmail as a mail submission program (MSP).
The <code class="language-plaintext highlighter-rouge">-Ac</code> option on this command line directs sendmail to read the
<em>submit.cf</em> configuration file.  The <code class="language-plaintext highlighter-rouge">-L</code> option tells this copy of 
sendmail to use the name <em>sm-msp</em> when it logs messages.  Without the
<code class="language-plaintext highlighter-rouge">-L</code> option, both copies of sendmail would log messages using the
name <em>sendmail</em> making it difficult to determine which copy of sendmail
logged the message.  The <code class="language-plaintext highlighter-rouge">-q5m</code> option directs a copy of sendmail to 
process its mail queue every 5 minutes.</p>
</blockquote>

<h4 id="chapter-masquerading">Chapter Masquerading</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ grep MASQUERADE_AS /etc/mail/freebsd.submit.mc
MASQUERADE_AS(`mydomain.to.masqueradeas')dnl
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ hostname
fbsd1.mydomain.to.masqueradeas
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ su
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># sendmail -bt -Ac
ADDRESS TEST MODE (ruleset 3 NOT automatically invoked)
Enter &lt;ruleset&gt; &lt;address&gt;

&gt; $M
mydomain.to.masqueradeas
 
&gt; $w
fbsd1
 
&gt; $j
fbsd1.mydomain.to.masqueradeas

&gt; /quit
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># sendmail -bt
ADDRESS TEST MODE (ruleset 3 NOT automatically invoked)
Enter &lt;ruleset&gt; &lt;address&gt;

&gt; $M
Undefined

&gt; $w
fbsd1
 
&gt; $j
fbsd1.mydomain.to.masqueradeas

&gt; /quit
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># sendmail -bt -Ac
ADDRESS TEST MODE (ruleset 3 NOT automatically invoked)
Enter &lt;ruleset&gt; &lt;address&gt;
 
&gt; /tryflags HS
&gt; /try esmtp dusko
Trying header sender address dusko for mailer esmtp
canonify           input: dusko
Canonify2          input: dusko
Canonify2        returns: dusko
canonify         returns: dusko
1                  input: dusko
1                returns: dusko
HdrFromSMTP        input: dusko
PseudoToReal       input: dusko
PseudoToReal     returns: dusko
MasqSMTP           input: dusko
MasqSMTP         returns: dusko &lt; @ *LOCAL* &gt;
MasqHdr            input: dusko &lt; @ *LOCAL* &gt;
MasqHdr          returns: dusko &lt; @ mydomain . to . masqueradeas . &gt;
HdrFromSMTP      returns: dusko &lt; @ mydomain . to . masqueradeas . &gt;
final              input: dusko &lt; @ mydomain . to . masqueradeas . &gt;
final            returns: dusko @ mydomain . to . masqueradeas
Rcode = 0, addr = dusko@mydomain.to.masqueradeas
 
&gt; /quit
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># sendmail -bt
ADDRESS TEST MODE (ruleset 3 NOT automatically invoked)
Enter &lt;ruleset&gt; &lt;address&gt;
 
&gt; /tryflags HS
&gt; /try esmtp dusko
Trying header sender address dusko for mailer esmtp
canonify           input: dusko
Canonify2          input: dusko
Canonify2        returns: dusko
canonify         returns: dusko
1                  input: dusko
1                returns: dusko
HdrFromSMTP        input: dusko
PseudoToReal       input: dusko
PseudoToReal     returns: dusko
MasqSMTP           input: dusko
MasqSMTP         returns: dusko &lt; @ *LOCAL* &gt;
MasqHdr            input: dusko &lt; @ *LOCAL* &gt;
MasqHdr          returns: dusko &lt; @ fbsd1 . mydomain . to . masqueradeas . &gt;
HdrFromSMTP      returns: dusko &lt; @ fbsd1 . mydomain . to . masqueradeas . &gt;
final              input: dusko &lt; @ fbsd1 . mydomain . to . masqueradeas . &gt;
final            returns: dusko @ fbsd1 . mydomain . to . masqueradeas
Rcode = 0, addr = dusko@fbsd1.mydomain.to.masqueradeas
 
&gt; /quit
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">$M</code> command shows <code class="language-plaintext highlighter-rouge">$M</code> macro (<code class="language-plaintext highlighter-rouge">MASQUERADE_AS</code>). <br />
The <code class="language-plaintext highlighter-rouge">$j</code> command shows the fully qualified name of this host. <br />
The <code class="language-plaintext highlighter-rouge">/tryflags</code> command tells sendmail to process the header sender (HS) address. <br />
The <code class="language-plaintext highlighter-rouge">/try</code> command tells sendmail to process <em>dusko</em> as the header sender 
address for the <code class="language-plaintext highlighter-rouge">esmtp</code> mailer.  Notice that <em>dusko</em> is an email address 
that does not contain a host part.  sendmail adds a hostname to the 
unqualified username, and, by default, it adds the hostname found in <code class="language-plaintext highlighter-rouge">$j</code>. 
The value returned by the <code class="language-plaintext highlighter-rouge">MasqHdr</code> ruleset shows this.</p>

<h4 id="dump-a-class-macro-with-">Dump a Class Macro with $=</h4>

<p>The <code class="language-plaintext highlighter-rouge">$=</code> rule-testing command tells <em>sendmail</em> to print all the members for
a class.  The class name must immediately follow the <code class="language-plaintext highlighter-rouge">=</code> with no
intervening space.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># sendmail -bt
ADDRESS TEST MODE (ruleset 3 NOT automatically invoked)
Enter &lt;ruleset&gt; &lt;address&gt;
 
&gt; $=w
localhost
fbsd1.your.local.domain
[127.0.0.1]
[123.45.67.8]
localhost.my.domain
[localhost.my.domain]

&gt; $=m
your.local.domain

&gt; $=M

&gt; $={VirtHost}
 
&gt; $=R

&gt; $=N

&gt; $=E
root

&gt; /quit
</code></pre></div></div>

<p>ES = Envelope Sender</p>

<p>The <code class="language-plaintext highlighter-rouge">/tryflags ES</code> command configures sendmail to test header 
sender (HS) address processing:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># sendmail -bt
ADDRESS TEST MODE (ruleset 3 NOT automatically invoked)
Enter &lt;ruleset&gt; &lt;address&gt;
 
&gt; /tryflags ES
&gt; /try esmtp dusko@mydomain.to.masqueradeas
Trying envelope sender address dusko@mydomain.to.masqueradeas for mailer esmtp
canonify           input: dusko @ mydomain . to . masqueradeas
Canonify2          input: dusko &lt; @ mydomain . to . masqueradeas &gt;
Canonify2        returns: dusko &lt; @ mydomain . to . masqueradeas . &gt;
canonify         returns: dusko &lt; @ mydomain . to . masqueradeas . &gt;
1                  input: dusko &lt; @ mydomain . to . masqueradeas . &gt;
1                returns: dusko &lt; @ mydomain . to . masqueradeas . &gt;
EnvFromSMTP        input: dusko &lt; @ mydomain . to . masqueradeas . &gt;
PseudoToReal       input: dusko &lt; @ mydomain . to . masqueradeas . &gt;
PseudoToReal     returns: dusko &lt; @ mydomain . to . masqueradeas . &gt;
MasqSMTP           input: dusko &lt; @ mydomain . to . masqueradeas . &gt;
MasqSMTP         returns: dusko &lt; @ mydomain . to . masqueradeas . &gt;
MasqEnv            input: dusko &lt; @ mydomain . to . masqueradeas . &gt;
MasqHdr            input: dusko &lt; @ mydomain . to . masqueradeas . &gt;
MasqHdr          returns: dusko &lt; @ mydomain . to . masqueradeas . &gt;
MasqEnv          returns: dusko &lt; @ mydomain . to . masqueradeas . &gt;
EnvFromSMTP      returns: dusko &lt; @ mydomain . to . masqueradeas . &gt;
final              input: dusko &lt; @ mydomain . to . masqueradeas . &gt;
final            returns: dusko @ mydomain . to . masqueradeas . &gt;
Rcode = 0, addr = dusko@mydomain.to.masqueradeas
 
&gt; /quit
</code></pre></div></div>

<h4 id="chapter-controlling-spam">Chapter Controlling Spam</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># sendmail -bt
ADDRESS TEST MODE (ruleset 3 NOT automatically invoked)
Enter &lt;ruleset&gt; &lt;address&gt;

&gt; check_mail dusko@some.ext.domain
check_mail         input: dusko @ some . ext . domain
Basic_check_mail   input: dusko @ some . ext . domain
tls_client         input: $| MAIL
D                  input: &lt; &gt; &lt; ? &gt; &lt; ! "TLS_Clt" &gt; &lt; &gt;
D                returns: &lt; ? &gt; &lt; &gt; &lt; ? &gt; &lt; ! "TLS_Clt" &gt; &lt; &gt;
A                  input: &lt; &gt; &lt; ? &gt; &lt; ! "TLS_Clt" &gt; &lt; &gt;
A                returns: &lt; &gt; &lt; ? &gt; &lt; ! "TLS_Clt" &gt; &lt; &gt;
TLS_connection     input: $| &lt; &gt; &lt; ? &gt; &lt; ! "TLS_Clt" &gt; &lt; &gt;
TLS_connection   returns: OK
tls_client       returns: OK
CanonAddr          input: &lt; dusko @ some . ext . domain &gt;
canonify           input: &lt; dusko @ some . ext . domain &gt;
Canonify2          input: dusko &lt; @ some . ext . domain &gt;
Canonify2        returns: dusko &lt; @ some . ext . domain . &gt;
canonify         returns: dusko &lt; @ some . ext . domain . &gt;
Parse0             input: dusko &lt; @ some . ext . domain . &gt;
Parse0           returns: dusko &lt; @ some . ext . domain . &gt;
CanonAddr        returns: dusko &lt; @ some . ext . domain . &gt;
SearchList         input: &lt; + From &gt; $| &lt; F : dusko @ some . ext . domain &gt; &lt; U : dusko @ &gt; &lt; D : some . ext . domain &gt; &lt; &gt;
F                  input: &lt; dusko @ some . ext . domain &gt; &lt; ? &gt; &lt; + From &gt; &lt; &gt;
F                returns: &lt; ? &gt; &lt; &gt;
SearchList         input: &lt; + From &gt; $| &lt; U : dusko @ &gt; &lt; D : some . ext . domain &gt; &lt; &gt;
U                  input: &lt; dusko @ &gt; &lt; ? &gt; &lt; + From &gt; &lt; &gt;
U                returns: &lt; ? &gt; &lt; &gt;
SearchList         input: &lt; + From &gt; $| &lt; D : some . ext . domain &gt; &lt; &gt;
D                  input: &lt; some . ext . domain &gt; &lt; ? &gt; &lt; + From &gt; &lt; &gt;
D                  input: &lt; ext . domain &gt; &lt; ? &gt; &lt; + From &gt; &lt; &gt;
D                  input: &lt; domain &gt; &lt; ? &gt; &lt; + From &gt; &lt; &gt;
D                returns: &lt; ? &gt; &lt; &gt;
D                returns: &lt; ? &gt; &lt; &gt;
D                returns: &lt; ? &gt; &lt; &gt;
SearchList       returns: &lt; ? &gt;
SearchList       returns: &lt; ? &gt;
SearchList       returns: &lt; ? &gt;
Basic_check_mail returns: @ dusko &lt; @ some . ext . domain &gt;
check_mail       returns: @ dusko &lt; @ some . ext . domain &gt;

&gt; check_relay dusko@some.external.domain
check_relay        input: dusko @ some . external . domain
check_relay      returns: dusko @ some . external . domain $| dusko @ some . external . domain

&gt; .D{client_addr}192.168.111.68

&gt; Basic_check_relay &lt;&gt;
Basic_check_rela   input: &lt; &gt;
Basic_check_rela returns: &lt; &gt;
 
&gt; /quit
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># sendmail -bt -Ac
ADDRESS TEST MODE (ruleset 3 NOT automatically invoked)
Enter &lt;ruleset&gt; &lt;address&gt;
 
&gt; check_mail dusko@some.ext.domain
check_mail         input: dusko @ some . ext . domain
Basic_check_mail   input: dusko @ some . ext . domain
tls_client         input: $| MAIL
TLS_connection     input:
TLS_connection   returns:
tls_client       returns:
CanonAddr          input: &lt; dusko @ some . ext . domain &gt;
canonify           input: &lt; dusko @ some . ext . domain &gt;
Canonify2          input: dusko &lt; @ some . ext . domain &gt;
Canonify2        returns: dusko &lt; @ some . ext . domain . &gt;
canonify         returns: dusko &lt; @ some . ext . domain . &gt;
Parse0             input: dusko &lt; @ some . ext . domain . &gt;
Parse0           returns: dusko &lt; @ some . ext . domain . &gt;
CanonAddr        returns: dusko &lt; @ some . ext . domain . &gt;
Basic_check_mail returns: @ dusko &lt; @ some . ext . domain &gt;
check_mail       returns: @ dusko &lt; @ some . ext . domain &gt;
 
&gt; check_relay dusko@some.ext.domain
check_relay        input: dusko @ some . ext . domain
check_relay      returns: dusko @ some . ext . domain $| dusko @ some . ext . domain

&gt; .D{client_addr}192.168.111.68     

&gt; Basic_check_relay &lt;&gt;
Basic_check_rela   input: &lt; &gt;
Basic_check_rela returns: &lt; &gt;
 
&gt; /quit
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># sendmail -bt
ADDRESS TEST MODE (ruleset 3 NOT automatically invoked)
Enter &lt;ruleset&gt; &lt;address&gt;
 
&gt; Local_check_mail dusko
Local_check_mail   input: dusko
Local_check_mail returns: dusko
 
&gt; Local_check_mail dusko@some.ext.domain
Local_check_mail   input: dusko @ some . ext . domain
Local_check_mail returns: dusko @ some . ext . domain
 
&gt; Local_check_mail dusko_pijetlovic@yahoo.ca
Local_check_mail   input: dusko_pijetlovic @ yahoo . ca
Local_check_mail returns: dusko_pijetlovic @ yahoo . ca

&gt; /quit
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ps $$
  PID TT  STAT    TIME COMMAND
11825  2  Ss   0:00.09 -tcsh (tcsh)
 
$ printf %s\\n "$SHELL"
/bin/tcsh

$ su
Password:
# 

# command -v bash; type bash; whereis bash; which bash
/usr/local/bin/bash
bash is /usr/local/bin/bash
bash: /usr/local/bin/bash /usr/local/man/man1/bash.1.gz /usr/ports/shells/bash
/usr/local/bin/bash

# pkg info --regex bash
bash-5.2.2_1

# cat /etc/shells
# $FreeBSD$
#
# List of acceptable shells for chpass(1).
# Ftpd will not allow users to connect who are not using
# one of these shells.

/bin/sh
/bin/csh
/bin/tcsh
/usr/local/bin/bash
/usr/local/bin/rbash
/usr/local/libexec/git-core/git-shell
/usr/local/bin/ksh93

# bash
# 

# ps $$
  PID TT  STAT    TIME COMMAND
13555  2  S    0:00.01 bash
</code></pre></div></div>

<p>While in <em>bash</em>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># echo -n "${EMAIL_CONTENT:6:-3}" | sendmail -Am -d60.5 -v dusko@some.ext.domain
map_lookup(dequote, dusko, %0=dusko) =&gt; NOT FOUND (0), ad=0
map_lookup(host, some.ext.domain, %0=some.ext.domain) =&gt; some.ext.domain. (0), ad=0
dusko@some.ext.domain... Connecting to esva.mail-relay.your.isp. via esmtp...
220 srv01.mail-relay.your.isp ESMTP
&gt;&gt;&gt; EHLO fbsd1.home.arpa
250-srv01.mail-relay.your.isp 
250-8BITMIME
250-SIZE 52428800
250 STARTTLS
&gt;&gt;&gt; STARTTLS
220 Go ahead with TLS
map_lookup(macro, {TLS_Name}, %0={TLS_Name}, %1=esva.mail-relay.your.isp) =&gt;  (0), ad=0
&gt;&gt;&gt; EHLO fbsd1.home.arpa
250-srv01.mail-relay.your.isp 
250-8BITMIME
250 SIZE 52428800
&gt;&gt;&gt; MAIL From:&lt;dusko@fbsd1.home.arpa&gt;
250 sender &lt;dusko@fbsd1.home.arpa&gt; ok
map_lookup(macro, {TLS_Name}, %0={TLS_Name}, %1=esva.mail-relay.your.isp) =&gt;  (0), ad=0
map_lookup(host, some.ext.domain, %0=some.ext.domain) =&gt; some.ext.domain. (0), ad=0
&gt;&gt;&gt; RCPT To:&lt;dusko@some.ext.domain&gt;
250 recipient &lt;dusko@some.ext.domain&gt; ok
&gt;&gt;&gt; DATA
354 go ahead
&gt;&gt;&gt; .
250 ok:  Message 7580284 accepted
dusko@some.ext.domain... Sent (ok:  Message 7580284 accepted)
Closing connection to esva.mail-relay.your.isp.
&gt;&gt;&gt; QUIT
221 srv01.mail-relay.your.isp
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># echo -n "${EMAIL_CONTENT:6:-3}" | sendmail -Ac -d60.5 -v dusko@some.ext.domain
map_lookup(dequote, dusko, %0=dusko) =&gt; NOT FOUND (0), ad=0
map_lookup(host, some.ext.domain, %0=some.ext.domain) =&gt; some.ext.domain. (0), ad=0
dusko@some.ext.domain... Connecting to [127.0.0.1] port 1465 via smartrelay...
220 your.isp.net ESMTP mailer ready at Sat, 28 Jan 2023 21:15:03 -0800
&gt;&gt;&gt; EHLO fbsd1.home.arpa
250-your.isp.net Hello fbsd1.home.arpa [123.45.67.89], pleased to meet you
250-ENHANCEDSTATUSCODES
250-8BITMIME
250-SIZE 52428800
250-AUTH LOGIN PLAIN
250-DELIVERBY
250 HELP
map_lookup(authinfo, AuthInfo:[127.0.0.1], %0=AuthInfo:[127.0.0.1]) =&gt; "U:smmsp" "I:dusko"  "P:YourSmartHostPwd" "M:LOGIN" (0), ad=0
&gt;&gt;&gt; AUTH LOGIN
334 VXNlcm5hbWU6
&gt;&gt;&gt; ABCab12=
334 UGFzc3dvcmQ6
&gt;&gt;&gt; ABCdEF12gHIJkLMnoPQRSt==
235 2.0.0 OK Authenticated
&gt;&gt;&gt; MAIL From:&lt;dusko@fbsd1.home.arpa&gt; AUTH=dusko@fbsd1.home.arpa
250 2.1.0 &lt;dusko@fbsd1.home.arpa&gt;... Sender ok
&gt;&gt;&gt; RCPT To:&lt;dusko@some.ext.domain&gt;
250 2.1.5 &lt;dusko@some.ext.domain&gt;... Recipient ok
&gt;&gt;&gt; DATA
354 Enter mail, end with "." on a line by itself
&gt;&gt;&gt; .
250 2.0.0 30T5F3AO022530 Message accepted for delivery
dusko@some.ext.domain... Sent (30T5F3AO022530 Message accepted for delivery)
Closing connection to [127.0.0.1]
&gt;&gt;&gt; QUIT
221 2.0.0 your.isp.net closing connection
</code></pre></div></div>

<p>Exit <em>bash</em>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># exit
</code></pre></div></div>

<p>Exit <em>root</em>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># exit
$ 
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># find /etc -iname '*sasl*'
/etc/selinux/targeted/modules/active/modules/sasl.pp
/etc/sysconfig/saslauthd
/etc/rc.d/rc2.d/S65saslauthd
/etc/rc.d/rc1.d/K10saslauthd
/etc/rc.d/rc6.d/K10saslauthd
/etc/rc.d/rc4.d/S65saslauthd
/etc/rc.d/rc5.d/S65saslauthd
/etc/rc.d/rc3.d/S65saslauthd
/etc/rc.d/rc0.d/K10saslauthd
/etc/rc.d/init.d/saslauthd
/etc/sasl2

# ls -lh /etc/sasl2
total 4.0K
-rw-r--r-- 1 root root 49 Sep 25  2016 Sendmail.conf

# ls -lh /etc/sasl2/Sendmail.conf 
-rw-r--r-- 1 root root 49 Sep 25  2016 /etc/sasl2/Sendmail.conf

# cat /etc/sasl2/Sendmail.conf 
pwcheck_method:saslauthd
#mech_list: login plain
</code></pre></div></div>

<h4 id="chapter-authenticating-with-auth">Chapter Authenticating with AUTH</h4>

<p>Send mail to the remote host to test the AUTH credentials.  Call <code class="language-plaintext highlighter-rouge">sendmail</code> 
with the <code class="language-plaintext highlighter-rouge">-v</code> option in order to watch the protocol interactions. Here is a 
sample test:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># sendmail -Am -v -t
To: dusko@example.com
From: dusko@example.dom
Subject: Test

Please ignore.
</code></pre></div></div>

<p>Press <em>Ctrl-D</em></p>

<p>In addition to the <code class="language-plaintext highlighter-rouge">-v</code> option, this test invokes sendmail with <code class="language-plaintext highlighter-rouge">-t</code> 
and <code class="language-plaintext highlighter-rouge">-Am</code>. <code class="language-plaintext highlighter-rouge">-t</code> tells sendmail to obtain the recipient address from any 
To:, CC:, and Bcc: lines in the message.  (In the example, you specified 
the recipient with a To: line in the message.)  The first five lines after 
the <code class="language-plaintext highlighter-rouge">sendmail</code> command is your test message, which is terminated by a 
Ctrl-D end-of-file mark.  The <code class="language-plaintext highlighter-rouge">-Am</code> option tells sendmail to run as an MTA, 
using the <em>sendmail.cf</em> configuration.  If this option is not specified, 
sendmail runs as a message submission program (MSP), uses the <em>submit.cf</em> 
configuration, and displays the interaction between the user’s <code class="language-plaintext highlighter-rouge">sendmail</code> 
command and the local system.  Because you want to watch the MTA interaction 
between your system and a remote system, you need to use the <code class="language-plaintext highlighter-rouge">-Am</code> option.</p>

<p>Every line after the Ctrl-D is output from sendmail.  Output lines that 
start with <code class="language-plaintext highlighter-rouge">&gt;&gt;&gt;</code> are SMTP commands coming from the sending system. 
Lines that start with a numeric response code come from the receiving system.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># grep AuthMechanisms /etc/mail/sendmail.cf
O AuthMechanisms=LOGIN PLAIN
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># grep TrustAuthMech /etc/mail/sendmail.cf
C{TrustAuthMech}LOGIN PLAIN
R$* $| $={TrustAuthMech}        $# RELAY
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># grep DaemonPortOptions /etc/mail/sendmail.cf
O DaemonPortOptions=Name=MTA, M=A
O DaemonPortOptions=Port=465, Name=MTASSL, M=s a
O DaemonPortOptions=Port=587, Name=MSA, M=a
O DaemonPortOptions=Addr=127.0.0.1, Port=10026
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># grep -r Srv_Features /etc/mail/sendmail.cf
R$*             $: $&gt;D &lt;$&amp;{client_name}&gt; &lt;?&gt; &lt;! "Srv_Features"&gt; &lt;&gt;
R&lt;?&gt;$*          $: $&gt;A &lt;$&amp;{client_addr}&gt; &lt;?&gt; &lt;! "Srv_Features"&gt; &lt;&gt;
R&lt;?&gt;$*          $: &lt;$(access "Srv_Features": $: ? $)&gt;
</code></pre></div></div>

<h2 id="chapter-securing-the-mail-transport">Chapter Securing the Mail Transport</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># grep -r Try_TLS /etc/mail/sendmail.cf
R$*             $: $&gt;D &lt;$&amp;{server_name}&gt; &lt;?&gt; &lt;! "Try_TLS"&gt; &lt;&gt;
R&lt;?&gt;$*          $: $&gt;A &lt;$&amp;{server_addr}&gt; &lt;?&gt; &lt;! "Try_TLS"&gt; &lt;&gt;
R&lt;?&gt;$*          $: &lt;$(access "Try_TLS": $: ? $)&gt;
</code></pre></div></div>

<h2 id="chapter-managing-the-queue">Chapter Managing the Queue</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># grep QueueDirectory /etc/mail/sendmail.cf
O QueueDirectory=/var/spool/mqueue
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">/mx</code> command returns the MX list sendmail will use to deliver to the 
specified recipient host:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># sendmail -bt 
ADDRESS TEST MODE (ruleset 3 NOT automatically invoked)
Enter &lt;ruleset&gt; &lt;address&gt;
 
&gt; /mx sendmail.org
getmxrr(sendmail.org) returns 1 value(s):
        mc.sendmail.org.
 
&gt; /mx yahoo.com
getmxrr(yahoo.com) returns 3 value(s):
        mta5.am0.yahoodns.net.
        mta7.am0.yahoodns.net.
        mta6.am0.yahoodns.net.

&gt; /mx aol.com
getmxrr(aol.com) returns 1 value(s):
        mx-aol.mail.gm0.yahoodns.net.

&gt; /mx gmail.com
getmxrr(gmail.com) returns 5 value(s):
        gmail-smtp-in.l.google.com.
        alt1.gmail-smtp-in.l.google.com.
        alt2.gmail-smtp-in.l.google.com.
        alt3.gmail-smtp-in.l.google.com.
        alt4.gmail-smtp-in.l.google.com.

&gt; /mx some_domain.com 
getmxrr(duskopijetlovic.com) returns 2 value(s):
        aspmx1.somemx.com.
        aspmx2.somemx.com.

&gt; /quit
</code></pre></div></div>

<h2 id="chapter-securing-sendmail">Chapter Securing sendmail</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># grep '^M' /etc/mail/sendmail.cf | awk '{ print $1 $3 }'
Msmtp,F=mDFMuX,
Mesmtp,F=mDFMuXa,
Msmtp8,F=mDFMuX8,
Mdsmtp,F=mDFMuXa%,
Mrelay,F=mDFMuXa8,
Mlocal,F=lsDFMAw5:/|@qSPfhn9,
Mprog,F=lsDFMoqeu9,
Mprocmail,F=DFMSPhnu9,
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># grep '^Mprog' /etc/mail/sendmail.cf
Mprog,          P=/usr/sbin/smrsh, F=lsDFMoqeu9, S=EnvFromL/HdrFromL, R=EnvToL/HdrToL, D=$z:/,

# strings /usr/sbin/smrsh | grep '^/'
/lib64/ld-linux-x86-64.so.2
/wTH
/w&amp;H
/etc/smrsh
/bin:/usr/bin
/bin/sh
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># grep '^DZ' /etc/mail/sendmail.cf
DZ8.14.4
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># grep '^T' /etc/mail/sendmail.cf
Troot
Tdaemon
</code></pre></div></div>

<h2 id="bat-book">Bat Book</h2>

<p>Book: <br />
<strong>sendmail</strong><br />
by Bryan Coastales with Eric Allman and Neil Rickert<br />
Copyright (c) 1993 O’Reilly &amp; Associates, Inc. <br />
Printing history:<br />
November 1993: First Edition. <br />
February 1994: Minor corrections.<br />
September 1994: Minor corrections.  <br />
ISBN: 1-56592-056-2</p>

<p><strong>sendmail, Fourth Edition</strong><br />
by Bryan Coastales, George Jansen and Clauss Assman with Gregory Neil Shapiro
Copyright (c) 2008 Bryan Coastales, George Jansen and Clauss Assman<br />
Published by O’Reilly Media, Inc.</p>

<p>Printing history:<br />
November 1993: First Edition. <br />
January 1997: Second Edition.<br />
December 2002: Third Editon.<br />
October 2007: Fourt Editon.<br />
ISBN-10: 0-596-51029-2 <br />
ISBN-13: 978-0-596-51029-2</p>

<h3 id="chapter-3-the-roles-of-sendmail">Chapter 3 The Roles of sendmail</h3>

<p>Locations of other programs and files that <code class="language-plaintext highlighter-rouge">sendmail</code> uses:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># grep -v \# /etc/mail/sendmail.cf | grep "/[^0-9].*/"
Fw/etc/mail/local-host-names
FR-o /etc/mail/relay-domains
Kaccess hash -T&lt;TMPF&gt; /etc/mail/access
Kaccess hash -o -T&lt;TMPF&gt; /etc/mail/access
Kmailertable hash -o /etc/mail/mailertable
Kvirtuser hash -o /etc/mail/virtusertable
O AliasFile=/etc/aliases
O HelpFile=/etc/mail/helpfile
O ForwardPath=$z/.forward.$w:$z/.forward
O QueueDirectory=/var/spool/mqueue
O CACertPath=/etc/mail/certs/alpha
O CACertFile=/etc/mail/certs/alpha/alphaintercert.crt
O ServerCertFile=/etc/mail/certs/alpha/my.domain.crt
O ServerKeyFile=/etc/mail/certs/alpha/my.domain.key
O ClientCertFile=/etc/mail/certs/alpha/my.domain.crt
O ClientKeyFile=/etc/mail/certs/alpha/my.domain.key
Ft-o /etc/mail/trusted-users
             T=DNS/RFC822/SMTP,
             T=DNS/RFC822/SMTP,
             T=DNS/RFC822/SMTP,
             T=DNS/RFC822/SMTP,
             T=DNS/RFC822/SMTP,
Mlocal,      P=/usr/bin/procmail, F=lsDFMAw5:/|@qSPfhn9, S=EnvFromL/HdrFromL, R=EnvToL/HdrToL,
             T=DNS/RFC822/X-Unix,
Mprog,       P=/usr/sbin/smrsh, F=lsDFMoqeu9, S=EnvFromL/HdrFromL, R=EnvToL/HdrToL, D=$z:/,
                T=X-Unix/X-Unix/X-Unix,
Mprocmail,   P=/usr/bin/procmail, F=DFMSPhnu9, S=EnvFromSMTP/HdrFromSMTP, R=EnvToSMTP/HdrFromSMTP,
             T=DNS/RFC822/X-Unix,
</code></pre></div></div>

<p>Lines beginning with an O character: a line as a configuration option.
The string following the O is the name of the option.</p>

<p>Lines beginning with an M character: a line defining a <em>delivery agent</em>,
a.k.a. <em>MDA</em> (<em>Mail Delivery Agent</em>). 
A delivery agent is a program that handles final local delivery to a 
user’s mailbox (the <code class="language-plaintext highlighter-rouge">Mlocal</code>), handles delivery through a program 
(the <code class="language-plaintext highlighter-rouge">Mprog</code>), or <code class="language-plaintext highlighter-rouge">procmail(1)</code> program (the <code class="language-plaintext highlighter-rouge">Mprocmail</code>).
The <em>procmail</em> delivery agent allows additional processing for local or 
special delivery needs.</p>

<h3 id="network-forwarding">Network Forwarding</h3>

<h4 id="tcpip">TCP/IP</h4>

<p>The <em>sendmail</em> program has the <em>internal</em> ability to forward mail over 
only one kind of network, one that uses TCP/IP.<br />
Lines that instruct <em>sendmail</em> to do this have <code class="language-plaintext highlighter-rouge">[IPC]</code>
(may appear as <code class="language-plaintext highlighter-rouge">[TCP]</code>).</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># grep -v \# /etc/mail/sendmail.cf | grep '^M'
Msmtp,       P=[IPC], F=mDFMuX, S=EnvFromSMTP/HdrFromSMTP, R=EnvToSMTP, E=\r\n, L=990,
Mesmtp,      P=[IPC], F=mDFMuXa, S=EnvFromSMTP/HdrFromSMTP, R=EnvToSMTP, E=\r\n, L=990,
Msmtp8,      P=[IPC], F=mDFMuX8, S=EnvFromSMTP/HdrFromSMTP, R=EnvToSMTP, E=\r\n, L=990,
Mdsmtp,      P=[IPC], F=mDFMuXa%, S=EnvFromSMTP/HdrFromSMTP, R=EnvToSMTP, E=\r\n, L=990,
Mrelay,      P=[IPC], F=mDFMuXa8, S=EnvFromSMTP/HdrFromSMTP, R=MasqSMTP, E=\r\n, L=2040,
Mlocal,      P=/usr/bin/procmail, F=lsDFMAw5:/|@qSPfhn9, S=EnvFromL/HdrFromL, R=EnvToL/HdrToL,
Mprog,       P=/usr/sbin/smrsh, F=lsDFMoqeu9, S=EnvFromL/HdrFromL, R=EnvToL/HdrToL, D=$z:/,
Mprocmail,   P=/usr/bin/procmail, F=DFMSPhnu9, S=EnvFromSMTP/HdrFromSMTP, R=EnvToSMTP/HdrFromSMTP,
</code></pre></div></div>

<p><strong>Note:</strong> The lines beginning with <code class="language-plaintext highlighter-rouge">Msmtp</code>, <code class="language-plaintext highlighter-rouge">Mesmtp</code>, <code class="language-plaintext highlighter-rouge">Msmtp8</code>, <code class="language-plaintext highlighter-rouge">Mpdsmtp</code>, 
<code class="language-plaintext highlighter-rouge">Mrelay</code> indicate the internal SMTP delivery agents.</p>

<p>The five SMTP delivery agents all use TCP to connect to other hosts.</p>

<h3 id="the-sendmail-daemon">The sendmail Daemon</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># grep -r sendmail /etc/rc*
/etc/rc.d/init.d/sendmail:# sendmail      This shell script takes care of starting and stopping
/etc/rc.d/init.d/sendmail:#               sendmail.
/etc/rc.d/init.d/sendmail:# processname: sendmail
/etc/rc.d/init.d/sendmail:# config: /etc/mail/sendmail.cf
/etc/rc.d/init.d/sendmail:# pidfile: /var/run/sendmail.pid
/etc/rc.d/init.d/sendmail:# Provides: sendmail MTA smtpdaemon
/etc/rc.d/init.d/sendmail:# Short-Description: start and stop sendmail
/etc/rc.d/init.d/sendmail:# Description: sendmail is a Mail Transport Agent (MTA)
/etc/rc.d/init.d/sendmail:# Source sendmail configureation.
/etc/rc.d/init.d/sendmail:if [ -f /etc/sysconfig/sendmail ]; then
/etc/rc.d/init.d/sendmail:    . /etc/sysconfig/sendmail
/etc/rc.d/init.d/sendmail:[ -x /usr/sbin/sendmail ] || exit 5
/etc/rc.d/init.d/sendmail:prog="sendmail"
/etc/rc.d/init.d/sendmail:    echo -n $"Package sendmail-cf is required to update configuration."
/etc/rc.d/init.d/sendmail:    daemon /usr/sbin/sendmail $([ "x$DAEMON" = xyes ] &amp;&amp; echo -bd) \
/etc/rc.d/init.d/sendmail:    [ $RETVAL -eq 0 ] &amp;&amp; touch /var/lock/subsys/sendmail
/etc/rc.d/init.d/sendmail:      daemon --check sm-client /usr/sbin/sendmail -L sm-msp-queue -Ac \
/etc/rc.d/init.d/sendmail:    killproc sendmail -HUP
/etc/rc.d/init.d/sendmail:    killproc sendmail
/etc/rc.d/init.d/sendmail:    [ $RETVAL -eq 0 ] &amp;&amp; rm -f /var/lock/subsys/sendmail
/etc/rc.d/init.d/sendmail:status -p /var/run/sendmail.pid &gt;/dev/null || status -p /var/run/sm-client.pid &gt;/dev/null
/etc/rc.d/init.d/sendmail:      echo -n sendmail; status -p /var/run/sendmail.pid -l sendmail
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># grep -r sendmail /etc/init.d/
/etc/init.d/sendmail:# sendmail      This shell script takes care of starting and stopping
/etc/init.d/sendmail:#               sendmail.
/etc/init.d/sendmail:# processname: sendmail
/etc/init.d/sendmail:# config: /etc/mail/sendmail.cf
/etc/init.d/sendmail:# pidfile: /var/run/sendmail.pid
/etc/init.d/sendmail:# Provides: sendmail MTA smtpdaemon
/etc/init.d/sendmail:# Short-Description: start and stop sendmail
/etc/init.d/sendmail:# Description: sendmail is a Mail Transport Agent (MTA)
/etc/init.d/sendmail:# Source sendmail configureation.
/etc/init.d/sendmail:if [ -f /etc/sysconfig/sendmail ]; then
/etc/init.d/sendmail:    . /etc/sysconfig/sendmail
/etc/init.d/sendmail:[ -x /usr/sbin/sendmail ] || exit 5
/etc/init.d/sendmail:prog="sendmail"
/etc/init.d/sendmail:   echo -n $"Package sendmail-cf is required to update configuration."
/etc/init.d/sendmail:    daemon /usr/sbin/sendmail $([ "x$DAEMON" = xyes ] &amp;&amp; echo -bd) \
/etc/init.d/sendmail:    [ $RETVAL -eq 0 ] &amp;&amp; touch /var/lock/subsys/sendmail
/etc/init.d/sendmail:   daemon --check sm-client /usr/sbin/sendmail -L sm-msp-queue -Ac \
/etc/init.d/sendmail:    killproc sendmail -HUP
/etc/init.d/sendmail:    killproc sendmail
/etc/init.d/sendmail:    [ $RETVAL -eq 0 ] &amp;&amp; rm -f /var/lock/subsys/sendmail
/etc/init.d/sendmail:status -p /var/run/sendmail.pid &gt;/dev/null || status -p /var/run/sm-client.pid &gt;/dev/null
/etc/init.d/sendmail:   echo -n sendmail; status -p /var/run/sendmail.pid -l sendmail
</code></pre></div></div>

<h3 id="bat-book-fourth-edition-chapter-16-configuration-file-overview">Bat Book (Fourth Edition): Chapter 16. Configuration File Overview</h3>

<blockquote>
  <p>Chapter 16. Configuration File Overview</p>

  <p>The <em>sendmail</em> configuration file (usually called <em>sendmail.cf</em>, but 
for MSP submission, called <em>submit.cf</em>) provides all the central
information that controls the sendmail program’s behavior.</p>

  <p>[ . . . ]</p>

  <p>The location of the <em>sendmail.cf</em> (and <em>submit.cf</em>) file is compiled
into sendmail.  Beginning with V8.10, sendmail expects to find its
configuration file in the <em>/etc/mail</em> directory.</p>

  <p>[ . . . ]</p>

  <p>The configuration file is read and parsed by <em>sendmail</em> every time it
starts up.  Because <em>sendmail</em> is run every time electronic mail is sent,
its configuration file is designed to be easy for <em>sendmail</em> to parse
rather than easy for humans to read.</p>
</blockquote>

<blockquote>
  <p>The listening daemon and the submission <em>msp sendmail</em> use two different
configuration files (i.e., <em>sendmail.cf</em> and <em>submit.cf</em>).  Unless you
specify a specific configuration file with <code class="language-plaintext highlighter-rouge">-C</code>, the <code class="language-plaintext highlighter-rouge">-Am</code> and <code class="language-plaintext highlighter-rouge">-Ac</code>
switches determine which of the two configuration files is used.</p>
</blockquote>

<p>From the <code class="language-plaintext highlighter-rouge">/usr/local/share/sendmail/cf/README</code> file:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>+----------------------------+
| MESSAGE SUBMISSION PROGRAM |
+----------------------------+
                                        
The purpose of the message submission program (MSP) is explained
in sendmail/SECURITY.  This section contains a list of caveats and
a few hints how for those who want to tweak the default configuration
for it (which is installed as submit.cf).

Notice: do not add options/features to submit.mc unless you are
absolutely sure you need them.  Options you may want to change
include:

- confTRUSTED_USERS, FEATURE(`use_ct_file'), and confCT_FILE for
  avoiding X-Authentication warnings.
- confTIME_ZONE to change it from the default `USE_TZ'.
- confDELIVERY_MODE is set to interactive in msp.m4 instead
  of the default background mode.
- FEATURE(stickyhost) and LOCAL_RELAY to send unqualified addresses
  to the LOCAL_RELAY instead of the default relay.
- confRAND_FILE if you use STARTTLS and sendmail is not compiled with
  the flag HASURANDOM.

[ . . . ]

Some things are not intended to work with the MSP.  These include
features that influence the delivery process (e.g., mailertable,
aliases), or those that are only important for a SMTP server (e.g.,
virtusertable, DaemonPortOptions, multiple queues).  Moreover,
relaxing certain restrictions (RestrictQueueRun, permissions on
queue directory) or adding features (e.g., enabling prog/file mailer)
can cause security problems.

Other things don't work well with the MSP and require tweaking or
workarounds.  For example, to allow for client authentication it
is not just sufficient to provide a client certificate and the
corresponding key, but it is also necessary to make the key group
(smmsp) readable and tell sendmail not to complain about that, i.e.,

        define(`confDONT_BLAME_SENDMAIL', `GroupReadableKeyFile')

If the MSP should actually use AUTH then the necessary data
should be placed in a map as explained in SMTP AUTHENTICATION:

FEATURE(`authinfo', `DATABASE_MAP_TYPE /etc/mail/msp-authinfo')

/etc/mail/msp-authinfo should contain an entry like:

        AuthInfo:127.0.0.1      "U:smmsp" "P:secret" "M:DIGEST-MD5"

The file and the map created by makemap should be owned by smmsp,
its group should be smmsp, and it should have mode 640.  The database
used by the MTA for AUTH must have a corresponding entry.
Additionally the MTA must trust this authentication data so the AUTH=
part will be relayed on to the next hop.  This can be achieved by
adding the following to your sendmail.mc file:

        LOCAL_RULESETS
        SLocal_trust_auth
        R$*     $: $&amp;{auth_authen}
        Rsmmsp  $# OK

[ . . . ]

feature/msp.m4 defines almost all settings for the MSP.  Most of
those should not be changed at all.  Some of the features and options
can be overridden if really necessary.  It is a bit tricky to do
this, because it depends on the actual way the option is defined
in feature/msp.m4.  If it is directly defined (i.e., define()) then
the modified value must be defined after

        FEATURE(`msp')

If it is conditionally defined (i.e., ifdef()) then the desired
value must be defined before the FEATURE line in the .mc file.
To see how the options are defined read feature/msp.m4.
</code></pre></div></div>

<h3 id="bat-book-fourth-edition-chapter-17-configure-sendmailcf-with-m4">Bat Book (Fourth Edition): Chapter 17. Configure sendmail.cf with m4</h3>

<blockquote>
  <p>The MAILER definition must always be last in your <em>mc</em> configuration file.
(Although it can and probably should be followed by rule set declarations,
as for example, LOCAL_RULESET_0).  If you include MAILER definitions for
procmail(1), maildrop(1), or uucp, those definitions must always follow
the definition for <code class="language-plaintext highlighter-rouge">smtp</code>.  Any modification of a MAILER definition
(as, for example, with LOCAL_MAILER_MAX) must precede that MAILER definition.</p>
</blockquote>

<p>From <strong>sendmail-source-tree/doc/op/op.txt</strong>:  <br />
(On FreeBSD 13.1: <code class="language-plaintext highlighter-rouge">/usr/local/share/doc/sendmail/op.txt</code>)  <br />
(On Linux distributions: <code class="language-plaintext highlighter-rouge">/usr/share/doc/sendmail-X.XX.X</code> (e.g. <code class="language-plaintext highlighter-rouge">/usr/share/doc/sendmail-8.17.1</code>)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      m   This mailer can send to multiple users on the same
          host in one transaction.  When a $u macro occurs
          in the argv part of the mailer definition, that
          field will be repeated as necessary for all quali-
          fying users.  Removing this flag can defeat dupli-
          cate  suppression on a remote site as each recipi-
          ent is sent in a separate transaction.

      D*  This mailer wants a "Date:" header line.

      F*  This mailer wants a "From:" header line.
 
      u   Upper case should be preserved in user names for
          this mailer.  Standards require preservation of
          case in the local part of addresses, except for
          those address for which your system accepts  re-
          sponsibility.   RFC 2142 provides a long list of
          addresses which should be case insensitive.   If
          you use this flag, you may be violating RFC 2142.
          Note that postmaster is always treated as a case
          insensitive address regardless of this flag.

      X   This mailer wants to use the hidden dot algorithm
          as specified in RFC 821; basically, any line be-
          ginning with a  dot  will have an extra  dot
          prepended (to be stripped at the other end).  This
          insures that lines in the message containing a dot
          will not terminate the message prematurely.
 
      a   Run Extended SMTP  (ESMTP)  protocol (defined in
          RFCs 1869, 1652, and 1870).  This flag defaults on
          if the SMTP greeting message includes the word
          "ESMTP".

      k   Normally when sendmail connects to a host via
          SMTP, it checks to make sure that this isn't acci-
          dentally the same host name as might happen if
          sendmail is misconfigured or if a long-haul net-
          work interface is set in loopback mode.  This flag
          disables the loopback check.  It should only be
          used under very unusual circumstances.
</code></pre></div></div>

<h2 id="essential-system-administration-3rd-edition">Essential System Administration, 3rd Edition</h2>

<p>By Æleen Frisch  <br />
O’Reilly Media, Inc.  <br />
August 2002</p>

<h3 id="chapter-94-configuring-the-transport-agent-the-whole-chapter">Chapter 9.4. Configuring the Transport Agent (The whole chapter)</h3>

<p>Also, about the <code class="language-plaintext highlighter-rouge">delay_checks</code> feature:</p>

<p>The entries in the access database are used by three distinct sendmail 
message examination phases. [1]</p>

<p>[1] To be more technically accurate, the entries are used by three 
different sendmail “rulesets”: <code class="language-plaintext highlighter-rouge">check_relay</code>, <code class="language-plaintext highlighter-rouge">check_mail</code>, and <code class="language-plaintext highlighter-rouge">check_rcpt</code>.</p>

<p>Messages are checked first for allowed relaying (based on the client 
hostname and address), then for an allowed sender, and finally for an 
allowed recipient.  If a message is rejected in one phase, it cannot be 
restored later.  This means that the preceding syntax does not allow for 
certain kinds of exceptions to be defined.  For example, you cannot allow 
email to a specific user always to get through regardless of its origin 
because the local addresses checks are downstream from the message 
source checks.</p>

<p>However, you can use the <code class="language-plaintext highlighter-rouge">delay_checks</code> feature to reverse the order of 
the three test phases.  In this mode, recipient-level access controls 
have the highest precedence, rather than the lowest.</p>

<h2 id="the-sendmail-cfreadme-file-and-documentation-doc-directory">The sendmail cf/README file and Documentation (doc Directory)</h2>

<ul>
  <li>Location of the <em>doc</em> directory on FreeBSD 13.1 is
<code class="language-plaintext highlighter-rouge">/usr/local/share/doc/sendmail</code>:</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ls /usr/local/share/doc/sendmail/
DEVTOOLS        MAIL.LOCAL      PGPKEYS         SECURITY        TRACEFLAGS
KNOWNBUGS       op.ps           README          SENDMAIL        TUNING
LICENSE         op.txt          RELEASE_NOTES   SMRSH
</code></pre></div></div>

<p>The <em>op</em> document is the <em>sendmail</em> “INSTALLATION AND OPERATION GUIDE”.
That guide is supplied as a text file (<em>op.txt</em>) and as a PostScript
document (<em>op.ps</em>).</p>

<ul>
  <li>
    <p>Location on FreeBSD 13.1 with <em>sendmail</em> 8.17.1: <br />
<code class="language-plaintext highlighter-rouge">/usr/local/share/sendmail/cf/README</code></p>
  </li>
  <li>
    <p>Location on RHEL Server release 6.8 (Santiago) 
with <em>sendmail</em> 8.14.4: <br />
<code class="language-plaintext highlighter-rouge">/usr/share/sendmail-cf/README</code></p>
  </li>
</ul>

<p>On FreeBSD 13, the man page for <code class="language-plaintext highlighter-rouge">sendmail(8)</code> under SEE ALSO section lists <em>Sendmail Installation and Operation Guide, No. 8, SMM</em>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ man sendmail

. . . 

  SEE ALSO
         mail(1), syslog(3), aliases(5), mailaddr(7), mail.local(8), rc(8),
         rmail(8)
  
         DARPA Internet Request For Comments RFC819, RFC821, RFC822.  Sendmail
         Installation and Operation Guide, No. 8, SMM.
</code></pre></div></div>

<p>NOTE: <em>SMM</em> stands for UNIX <em>System Manager’s Manual</em>.</p>

<ul>
  <li>
    <p>Sendmail Installation and Operation Guide - Eric Allman, Claus Assman, Gregory Neil Shapiro – PostScript version - Location on FreeBSD 13.1:
<code class="language-plaintext highlighter-rouge">/usr/local/share/doc/sendmail/op.ps</code></p>
  </li>
  <li>
    <p>Sendmail Installation and Operation Guide - Eric Allman, Claus Assmann, Gregory Neil Shapiro - Plain text version – Location on FreeBSD 13.1:
<code class="language-plaintext highlighter-rouge">/usr/local/share/doc/sendmail/op.txt</code></p>
  </li>
</ul>

<h3 id="the-features-section---the-require_rdns-feature">The FEATURES Section - The require_rdns Feature</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Available features are:

[ . . . ]

require_rdns    Reject mail from connecting SMTP clients without proper
                rDNS (reverse DNS), functional gethostbyaddr() resolution.
                Note: this feature will cause false positives, i.e., there
                are legitimate MTAs that do not have proper DNS entries.
                Rejecting mails from those MTAs is a local policy decision.

[ . . . ]

                EXCEPTIONS:

                Exceptions based on access entries are discussed below.
                Any IP address matched using $=R (the "relay-domains" file)
                is excepted from the rules.  Since we have explicitly
                allowed relaying for this host, based on IP address, we
                ignore the rDNS failure.

[ . . . ] 
                If `delay_checks' is in effect (recommended), then any
                sender who has authenticated is also excepted from the
                restrictions.  This happens because the rules produced by
                this FEATURE() will not be applied to authenticated senders
                (assuming `delay_checks').

                ACCESS MAP ENTRIES:

                Entries such as
                        Connect:1.2.3.4         OK
                        Connect:1.2             RELAY
                will whitelist IP address 1.2.3.4, so that the rDNS
                blocking does apply to that IP address

                Entries such as
                        Connect:1.2.3.4         REJECT
                will have the effect of forcing a temporary failure for
                that address to be treated as a permanent failure.
</code></pre></div></div>

<h3 id="the-delay-all-checks-section-of-the-sendmail-cfreadme-file">The “Delay all checks” Section of the sendmail cf/README file</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Delay all checks
----------------

By using FEATURE(`delay_checks') the rulesets check_mail and check_relay
will not be called when a client connects or issues a MAIL command,
respectively.  Instead, those rulesets will be called by the check_rcpt
ruleset; they will be skipped if a sender has been authenticated using
a "trusted" mechanism, i.e., one that is defined via TRUST_AUTH_MECH().
If check_mail returns an error then the RCPT TO command will be rejected
with that error.  If it returns some other result starting with $# then
check_relay will be skipped.  If the sender address (or a part of it) is
listed in the access map and it has a RHS of OK or RELAY, then check_relay
will be skipped.  This has an interesting side effect: if your domain is
my.domain and you have

        my.domain       RELAY

in the access map, then any e-mail with a sender address of
&lt;user@my.domain&gt; will not be rejected by check_relay even though
it would match the hostname or IP address.  This allows spammers
to get around DNS based blacklist by faking the sender address.  To
avoid this problem you have to use tagged entries:

        To:my.domain            RELAY
        Connect:my.domain       RELAY

if you need those entries at all (class {R} may take care of them).
</code></pre></div></div>

<h3 id="the-connection-control-section-of-the-sendmail-cfreadme-file">The CONNECTION CONTROL Section of the sendmail cf/README file</h3>

<p>About the order of the <code class="language-plaintext highlighter-rouge">access_db</code>, <code class="language-plaintext highlighter-rouge">delay_checks</code>, <code class="language-plaintext highlighter-rouge">ratecontrol</code> 
and <code class="language-plaintext highlighter-rouge">conncontrol</code> features in the mc file; that is:</p>

<p><code class="language-plaintext highlighter-rouge">access_db</code>  <br />
<code class="language-plaintext highlighter-rouge">delay_checks</code> <br />
<code class="language-plaintext highlighter-rouge">ratecontrol</code> <br />
<code class="language-plaintext highlighter-rouge">conncontrol</code></p>

<p>Excerpt from the cf/README file:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>The features ratecontrol and conncontrol allow to establish connection
limits per client IP address or net.  These features can limit the
rate of connections (connections per time unit) or the number of
incoming SMTP connections, respectively.  If enabled, appropriate
rulesets are called at the end of check_relay, i.e., after DNS
blacklists and generic access_db operations.  The features require 
FEATURE(`access_db') to be listed earlier in the mc file.

Note: FEATURE(`delay_checks') delays those connection control checks
after a recipient address has been received, hence making these
connection control features less useful.  To run the checks as early
as possible, specify the parameter `nodelay', e.g.,

        FEATURE(`ratecontrol', `nodelay')

In that case, FEATURE(`delay_checks') has no effect on connection
control (and it must be specified earlier in the mc file).

An optional second argument `terminate' specifies whether the
rulesets should return the error code 421 which will cause
sendmail to terminate the session with that error if it is
returned from check_relay, i.e., not delayed as explained in
the previous paragraph.  Example:

        FEATURE(`ratecontrol', `nodelay', `terminate')
</code></pre></div></div>

<h2 id="submission-sendmail-tls-sasl-smtp-auth-port-465-port-587">Submission (Sendmail TLS SASL SMTP-AUTH Port 465 Port 587)</h2>

<p><a href="https://serverfault.com/questions/880547/authentication-succeeds-but-sending-still-fails">Authentication succeeds, but sending still fails</a></p>

<p>The locally-invoked sendmail on the mail server:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># sendmail -O LogLevel=14 -bs -Am
220 test.host.domain ESMTP mailer ready at Wed, 26 Oct 2022 20:03:40 -0700
HELO test.host.domain
250 test.host.domain Hello root@localhost, pleased to meet you
EHLO test.host.domain
250-test.host.domain Hello root@localhost, pleased to meet you
250-ENHANCEDSTATUSCODES
250-8BITMIME
250-SIZE 52428800
250-STARTTLS
250-DELIVERBY
250 HELP
MAIL From:&lt;dusko@test.host.domain&gt;
250 2.1.0 &lt;dusko@test.host.domain&gt;... Sender ok
RCPT To:&lt;dusko@host.domain.
250 2.1.5 &lt;dusko@host.domain&gt;... Recipient ok
DATA
354 Enter mail, end with "." on a line by itself
From: Dusko &lt;dusko@foobar.com&gt;
To: &lt;dusko@host.domain&gt; Dusko Pijetlovic
Subject: Test

Testing.
.
250 2.0.0 29S4ceAq025509 Message accepted for delivery
QUIT
221 2.0.0 test.host.domain closing connection
</code></pre></div></div>

<p><a href="https://slackwiki.com/Sendmail_TLS_SASL_SMTP-AUTH">Sendmail TLS SASL SMTP-AUTH</a></p>

<p>The <code class="language-plaintext highlighter-rouge">define(`confAUTH_OPTIONS', `A p y')dnl</code> configures sendmail to:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">A</code> is a workaround for broken MTAs that do not implement RFC 2554.</li>
  <li>The <code class="language-plaintext highlighter-rouge">p</code> option tells sendmail: “don’t permit mechanisms susceptible to 
simple passive attack (e.g., <code class="language-plaintext highlighter-rouge">LOGIN</code>, <code class="language-plaintext highlighter-rouge">PLAIN</code>), unless a security layer
(think TLS tunnel) is active.”</li>
  <li>The <code class="language-plaintext highlighter-rouge">y</code> option prohibits anonymous logins.</li>
</ul>

<p>Take note that this will only allow LOGIN/PLAIN SMTP-AUTH after encryption
has been established in a TLS tunnel.  Allowing both TLS and non-TLS 
PLAIN/LOGIN SMTP-AUTH is left as an exercise to the reader.</p>

<p><a href="https://access.redhat.com/solutions/60803">How to configure sendmail for relaying mail over port 587 using authentication</a></p>

<p>What is: <code class="language-plaintext highlighter-rouge">sendmail -Am -v -t</code></p>

<p><a href="https://www.sendmail.org/~ca/email/authrealms.html">SMTP AUTH for sendmail 8.10: Realms and Examples</a><br />
Last Update 2000-06-24</p>

<p><strong>PLAIN</strong>  <br />
According to <a href="https://www.rfc-editor.org/rfc/rfc2595">RFC 2595</a> the client must send: <a href="https://www.sendmail.org/~ca/email/auth.html#userid">[authorize-id]</a> \0 <a href="https://www.sendmail.org/~ca/email/auth.html#authid">[authenticate-id]</a> \0 password. <a href="https://www.sendmail.org/~ca/email/authrealms.html#authpwcheck_method">pwcheck_method</a> has been set to <a href="https://www.sendmail.org/~ca/email/authrealms.html#PWCHECK_SASLDB">sasldb</a> for the following example.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt;&gt;&gt; AUTH PLAIN dGVzdAB0ZXN0QHdpei5leGFtcGxlLmNvbQB0RXN0NDI=
235 2.0.0 OK Authenticated
</code></pre></div></div>

<p><a href="https://www.sendmail.org/~ca/email/prgs/ed64.c">Decoded:</a></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>test\000test@wiz.example.com\000tEst42
</code></pre></div></div>

<p>With <a href="https://www.sendmail.org/~ca/email/patches/cyrus-sasl-1.5.15-lib-checkpw.c.p1">patch for lib/checkpw.c</a> or a <a href="https://www.sendmail.org/~ca/email/authrealms.html#authpwcheck_method">pwcheck_method</a> that doesn’t support realms:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt;&gt;&gt; AUTH PLAIN dGVzdAB0ZXN0AHRFc3Q0Mg==
</code></pre></div></div>

<p><a href="https://www.sendmail.org/~ca/email/prgs/ed64.c">Decoded:</a></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>test\000test\000tEst42
</code></pre></div></div>

<p><strong>LOGIN</strong></p>

<p><a href="https://www.sendmail.org/~ca/email/authrealms.html#authpwcheck_method">pwcheck_method</a> has been set to <a href="https://www.sendmail.org/~ca/email/authrealms.html#PWCHECK_SASLDB">sasldb</a> for the following example.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt;&gt;&gt; AUTH LOGIN
334 VXNlcm5hbWU6
&gt;&gt;&gt; dGVzdEB3aXouZXhhbXBsZS5jb20=
334 UGFzc3dvcmQ6
&gt;&gt;&gt; dEVzdDQy
235 2.0.0 OK Authenticated
</code></pre></div></div>

<p><a href="https://www.sendmail.org/~ca/email/prgs/ed64.c">Decoded:</a></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>test
tEst42
</code></pre></div></div>

<p><a href="https://stackoverflow.com/questions/59464979/what-is-the-difference-between-using-plain-vs-login-in-active-mailer-smtp">What is the difference between using <code class="language-plaintext highlighter-rouge">:plain</code> vs <code class="language-plaintext highlighter-rouge">:login</code> in active mailer smtp settings?</a></p>

<blockquote>
  <p>Long story short as you are using TLS your credentials are safe as they 
are being exchanged on an encrypted connection.</p>

  <p>According to ActionMailer documentation <a href="https://api.rubyonrails.org/classes/ActionMailer/Base.html#class-ActionMailer::Base-label-Configuration+options">here</a> irrespective of authentication <code class="language-plaintext highlighter-rouge">:plain</code> or <code class="language-plaintext highlighter-rouge">:login</code> the password is always <code class="language-plaintext highlighter-rouge">Base64</code> encoded.  The problem with Base64 encoding is that it can be easily decoded by anybody eavesdropping in on the SMTP communication. So both of these authentication mechanisms are really the same in terms of security.</p>

  <p>However as you are using <code class="language-plaintext highlighter-rouge">TLS</code> the connection is encrypted and the Base64
credentials are sent over this encrypted connection making it secure.
If you were not using TLS then it would be better to use <code class="language-plaintext highlighter-rouge">:cram_md5</code> 
instead of <code class="language-plaintext highlighter-rouge">:login</code> or <code class="language-plaintext highlighter-rouge">:plain</code> to secure the credentials.</p>
  <hr />
  <p>This answer is correct but incomplete since OP also asked the difference
between PLAIN and LOGIN. PLAIN sends both login and password in the 
same Base64-encoded string, whereas LOGIN sends them separately.</p>
</blockquote>

<ul>
  <li><a href="https://wiki.zimbra.com/wiki/Simple_Troubleshooting_For_SMTP_Via_Telnet_And_Openssl">Simple Troubleshooting For SMTP Via Telnet And Openssl</a></li>
</ul>

<h2 id="sasl">SASL</h2>

<p>On the mail server:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># man -k sasl
pluginviewer         (8)  - list loadable SASL plugins and their properties
saslauthd            (8)  - sasl authentication server
saslauthd_selinux    (8)  - Security Enhanced Linux Policy for the saslauthd processes
sasldblistusers2     (8)  - list users in sasldb
saslpasswd2          (8)  - set a user's sasl password
testsaslauthd        (8)  - test utility for the SASL authentication server
</code></pre></div></div>

<p>List <code class="language-plaintext highlighter-rouge">auxprop</code> mechanisms and plugins:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># pluginviewer -a
Installed auxprop mechanisms are:
sasldb
List of auxprop plugins follows
Plugin "sasldb" ,       API version: 4
        supports store: yes
</code></pre></div></div>

<p>List server authentication (SASL) plugins:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># pluginviewer -s
Installed SASL (server side) mechanisms are:
ANONYMOUS GSSAPI PLAIN LOGIN EXTERNAL
List of server plugins follows
Plugin "anonymous" [loaded],    API version: 4
        SASL mechanism: ANONYMOUS, best SSF: 0, supports setpass: no
        security flags: NO_PLAINTEXT
        features: WANT_CLIENT_FIRST
Plugin "gssapiv2" [loaded],     API version: 4
        SASL mechanism: GSSAPI, best SSF: 56, supports setpass: no
        security flags: NO_ANONYMOUS|NO_PLAINTEXT|NO_ACTIVE|PASS_CREDENTIALS|MUTUAL_AUTH
        features: WANT_CLIENT_FIRST|PROXY_AUTHENTICATION
Plugin "plain" [loaded],        API version: 4
        SASL mechanism: PLAIN, best SSF: 0, supports setpass: no
        security flags: NO_ANONYMOUS
        features: WANT_CLIENT_FIRST|PROXY_AUTHENTICATION
Plugin "login" [loaded],        API version: 4
        SASL mechanism: LOGIN, best SSF: 0, supports setpass: no
        security flags: NO_ANONYMOUS
        features:
</code></pre></div></div>

<p>Similarly, list client authentication (SASL) plugins:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># pluginviewer -c
Installed SASL (client side) mechanisms are:
ANONYMOUS GSSAPI PLAIN LOGIN EXTERNAL
List of client plugins follows
[ . . . ]
</code></pre></div></div>

<p>The directory where the Cyrus SASL library package installed its plug-ins:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ls -ld /usr/lib64/sasl2/
drwxr-xr-x. 2 root root 4096 May 17  2015 /usr/lib64/sasl2/
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ls -lh /usr/lib64/sasl2/
total 116K
lrwxrwxrwx 1 root root  22 May 17  2015 libanonymous.so -&gt; libanonymous.so.2.0.23
lrwxrwxrwx 1 root root  22 May 17  2015 libanonymous.so.2 -&gt; libanonymous.so.2.0.23
-rwxr-xr-x 1 root root 19K Feb 27  2015 libanonymous.so.2.0.23
lrwxrwxrwx 1 root root  21 May 17  2015 libgssapiv2.so -&gt; libgssapiv2.so.2.0.23
lrwxrwxrwx 1 root root  21 May 17  2015 libgssapiv2.so.2 -&gt; libgssapiv2.so.2.0.23
-rwxr-xr-x 1 root root 31K Feb 27  2015 libgssapiv2.so.2.0.23
lrwxrwxrwx 1 root root  18 May 17  2015 liblogin.so -&gt; liblogin.so.2.0.23
lrwxrwxrwx 1 root root  18 May 17  2015 liblogin.so.2 -&gt; liblogin.so.2.0.23
-rwxr-xr-x 1 root root 19K Feb 27  2015 liblogin.so.2.0.23
lrwxrwxrwx 1 root root  18 May 17  2015 libplain.so -&gt; libplain.so.2.0.23
lrwxrwxrwx 1 root root  18 May 17  2015 libplain.so.2 -&gt; libplain.so.2.0.23
-rwxr-xr-x 1 root root 19K Feb 27  2015 libplain.so.2.0.23
lrwxrwxrwx 1 root root  19 May 17  2015 libsasldb.so -&gt; libsasldb.so.2.0.23
lrwxrwxrwx 1 root root  19 May 17  2015 libsasldb.so.2 -&gt; libsasldb.so.2.0.23
-rwxr-xr-x 1 root root 23K Feb 27  2015 libsasldb.so.2.0.23
</code></pre></div></div>

<h3 id="check-and-test-sasl-support-in-sendmail">Check and Test SASL Support in sendmail</h3>

<p>There are two concepts to SASL and its use: authorization and authentication.</p>

<p><em>Authorization</em> refers to a user’s permission to perform certain actions.
One form of authorization, for example, might be to allow a user to relay
mail through your mail hub machine.  In general, authorization is 
associated with a user’s identifier (<code class="language-plaintext highlighter-rouge">userid</code>), which may be the username
or something more complex.</p>

<p><em>Authentication</em> refers to the validation of a user or machine’s identity.
One form of authentication, for example, might be the recognition that 
a laptop is a company-owned machine. Authentication is communicated inside
credentials and is associated with a client’s identifier (<code class="language-plaintext highlighter-rouge">authid</code>).</p>

<hr />

<p>The <code class="language-plaintext highlighter-rouge">-bs</code> tells <em>sendmail</em> to speak SMTP on its standard input.
The <code class="language-plaintext highlighter-rouge">-Am</code> tells <em>sendmail</em> to use its server configuration file
(not <em>submit.cf</em>), even though it is running in mail-submission mode.</p>

<p>Sendmail might not advertise it.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># sendmail -bs -Am
220 test.host.domain ESMTP mailer ready at Wed, 26 Oct 2022 20:07:35 -0700
helo test.host.domain 
250 test.host.domain Hello root@localhost, pleased to meet you
ehlo test.host.domain 
250-test.host.domain Hello root@localhost, pleased to meet you
250-ENHANCEDSTATUSCODES
250-8BITMIME
250-SIZE 52428800
250-STARTTLS
250-DELIVERBY
250 HELP
quit
221 2.0.0 test.host.domain closing connection
</code></pre></div></div>

<p>Here, the <code class="language-plaintext highlighter-rouge">AUTH</code> SMTP keyword doesn’t appear.</p>

<p>In that case, try increasing the log level, and checking the log file.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># sendmail -OLogLevel=14 -bs -Am
220 test.host.domain ESMTP mailer ready at Wed, 26 Oct 2022 20:08:32 -0700
ehlo test.host.domain 
250-test.host.domain Hello root@localhost, pleased to meet you
250-ENHANCEDSTATUSCODES
250-8BITMIME
250-SIZE 52428800
250-STARTTLS
250-DELIVERBY
250 HELP
quit
221 2.0.0 test.host.domain closing connection
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># grep 'Oct 26 20:08:32' /var/log/maillog 
Oct 26 20:08:32 test sendmail[30261]: STARTTLS=server, Diffie-Hellman init, key=1024 bit (1)
Oct 26 20:08:32 test sendmail[30261]: STARTTLS=server, init=1
Oct 26 20:08:32 test sendmail[30261]: AUTH: available mech=GSSAPI, allowed mech=LOGIN PLAIN
[ . . . ]
</code></pre></div></div>

<p>The log excerpt shows the <code class="language-plaintext highlighter-rouge">AUTH</code> SMTP keyword, indicating that this
site supports SASL authentication and two modes of authentication,
LOGIN and PLAIN.</p>

<p>The <em>saslpasswd2</em> program is installed in the <em>/usr/sbin</em> directory and 
is used to set up user accounts that exist only for email.</p>

<p>These user accounts and passwords are stored in the <em>sasldb</em> database.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># command -v saslpasswd2; type -a saslpasswd2; \
 whereis saslpasswd2; which saslpasswd2 
/usr/sbin/saslpasswd2
saslpasswd2 is /usr/sbin/saslpasswd2
saslpasswd2: /usr/sbin/saslpasswd2 /usr/share/man/man8/saslpasswd2.8.gz
/usr/sbin/saslpasswd2
</code></pre></div></div>

<p>The <em>sasldb</em> database provides the means to set up accounts for email 
that are separate from the user accounts that normally exist on your 
machine.</p>

<p>If you wish to use only existing accounts, you need to install
<em>Sendmail.conf</em>.</p>

<p>At a minimum, one line should appear in that file and that line should 
indicate your preferred password verification method.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># cat /etc/sasl2/Sendmail.conf 
pwcheck_method:saslauthd
</code></pre></div></div>

<p>In this example, the password verification method is <code class="language-plaintext highlighter-rouge">saslauthd</code>, 
which means:  Connect to the <em>saslauthd(8)</em> program for all authentication.</p>

<p>On this machine, that program is installed in <em>/usr/sbin</em>.</p>

<p><strong>Note:</strong> Instead of <code class="language-plaintext highlighter-rouge">saslauthd</code>, you could’ve used <code class="language-plaintext highlighter-rouge">pwcheck</code>; that is,
<code class="language-plaintext highlighter-rouge">pwcheck</code> is a synonym for <code class="language-plaintext highlighter-rouge">saslauthd</code>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># command -v saslauthd; type -a saslauthd; \
 whereis saslauthd; which saslauthd
/usr/sbin/saslauthd
saslauthd is /usr/sbin/saslauthd
saslauthd: /usr/sbin/saslauthd /usr/share/man/man8/saslauthd.8.gz
/usr/sbin/saslauthd
</code></pre></div></div>

<p>If you use it, the <em>saslauthd(8)</em> program must be started 
as a daemon automatically.</p>

<h3 id="auth-mechanisms-that-your-server-requires">AUTH Mechanisms that Your Server Requires</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># grep -r -i AUTH /etc/mail/ | grep -i mechanisms | grep -v \# 
/etc/mail/sendmail.cf:O AuthMechanisms=LOGIN PLAIN
/etc/mail/sendmail.mc:define(`confAUTH_MECHANISMS', `LOGIN PLAIN')dnl
</code></pre></div></div>

<p>This only defines the mechanisms that will be required if <code class="language-plaintext highlighter-rouge">AUTH</code> is 
required for inbound connections.  Whether or not connections must be 
authenticated is determined by the setting of the <code class="language-plaintext highlighter-rouge">DaemonOptions</code> option.</p>

<p>The class <code class="language-plaintext highlighter-rouge">$={TrustAuthMech}</code> contains a list of authentication
mechanisms that allow relaying.  It must contain a subset, or a
matching set of the list of all authentication mechanisms defined
with the <code class="language-plaintext highlighter-rouge">AuthMechanisms</code> option. For example, on this site:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># grep -r TrustAuthMech /etc/mail/
/etc/mail/sendmail.cf:C{TrustAuthMech}LOGIN PLAIN
/etc/mail/sendmail.cf:R$* $| $={TrustAuthMech}  $# RELAY
/etc/mail/submit.cf:R$* $| $={TrustAuthMech}    $# RELAY
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># grep -r TRUST_AUTH_MECH /etc/mail/
/etc/mail/sendmail.mc:TRUST_AUTH_MECH(`LOGIN PLAIN')dnl
</code></pre></div></div>

<p>Here, <em>sendmail</em> will authenticate using LOGIN and PLAIN mechanism, and 
that authentication (if successful) will provide an authorization to relay.</p>

<h3 id="the-authoptions-option">The AuthOptions Option</h3>

<p>The <code class="language-plaintext highlighter-rouge">AuthOptions</code> is used to specify how authentication should be handled
by your server (or client).  For example:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># grep -r AUTH_OPTIONS /etc/mail/
/etc/mail/sendmail.mc:define(`confAUTH_OPTIONS', `A p y')dnl
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># grep -r AuthOptions /etc/mail/ | grep -v \#
/etc/mail/sendmail.cf:O AuthOptions=A p y
</code></pre></div></div>

<p>Each character sets a single tuning parameter.  If more than one
character is listed, each character must be separated from the next 
by a space.</p>

<p>The <code class="language-plaintext highlighter-rouge">A</code> character:  Use the <code class="language-plaintext highlighter-rouge">AUTH=</code> parameter from the <code class="language-plaintext highlighter-rouge">MAIL From:</code>
command only when authentication succeeds.  This character can be
specified as a workaround for broken mail transfer agents (MTAs) that
do not correctly implement RFC2554. (Client only)</p>

<p>The <code class="language-plaintext highlighter-rouge">p</code> character:  Don’t permit mechanisms to be used if they are
susceptible to simple passive attack (that is, disallow use of PLAIN and
LOGIN), unless a security layer is already active (as, for example,
provided by STARTTLS). (Server only)</p>

<p>The <code class="language-plaintext highlighter-rouge">y</code> character:  Don’t permit the use of any mechanism that allows
anonymous login. (Server only)</p>

<h3 id="daemonportoptions">DaemonPortOptions</h3>

<p>The <em>sendmail</em> program can run in two connection modes: as a <strong>daemon</strong>, <em>accepting connections</em>; or as a <strong>client</strong>, <em>making connections</em>.
<em>Each mode</em> can connect to a <strong>port</strong> to do its work.
The options for the <em>client port</em> are set by the <strong><code class="language-plaintext highlighter-rouge">ClientPortOptions</code></strong> option.
The options for the <em>daemon</em> are set by the <strong><code class="language-plaintext highlighter-rouge">DaemonPortOptions</code></strong> option.</p>

<p>This <code class="language-plaintext highlighter-rouge">DaemonPortOptions</code> option is used to customize the daemon’s SMTP service.
The form for this option is as follows:</p>

<p><code class="language-plaintext highlighter-rouge">O DaemonPortOptions=pair,pair,pair</code>              &lt;- configuration file (V8.7 and later)<br />
<code class="language-plaintext highlighter-rouge">-ODaemonPortOptions=pair,pair,pair</code>              &lt;- command line (V8.7 and later)<br />
<code class="language-plaintext highlighter-rouge">define(`confDAEMON_OPTIONS',``pair,pair,pair'')</code> &lt;- mc configuration (V8.7 and later)<br />
<code class="language-plaintext highlighter-rouge">DAEMON_OPTIONS(``pair,pair,pair'')</code>              &lt;- mc configuration (V8.11 and later)<br />
<code class="language-plaintext highlighter-rouge">OOpair,pair,pair</code>                                &lt;- configuration file (deprecated)<br />
<code class="language-plaintext highlighter-rouge">-oOpair,pair,pair</code>                               &lt;- command line (deprecated)</p>

<p>The <code class="language-plaintext highlighter-rouge">DaemonPortOptions</code> option is set to a comma-separated list of pairs,
where each pair is of the form:</p>

<p><code class="language-plaintext highlighter-rouge">key=value</code></p>

<p><strong>Note:</strong> When the argument to an m4 define command contains one or more 
commas, that argument should be enclosed in two single quotes.</p>

<p>As of V8.14.1, all keys are case-sensitive. <strong><sup><a href="#footnotes">[1]</a></sup></strong></p>

<p>That is, <code class="language-plaintext highlighter-rouge">Children</code> differs from <code class="language-plaintext highlighter-rouge">children</code>.  Prior to V8.7, an unknown 
key was silently ignored.</p>

<p>With V8.8 and later, an unknown key is still ignored but now causes the 
following error to be printed:</p>

<p><code class="language-plaintext highlighter-rouge">DaemonPortOptions unknown parameter "key"</code></p>

<p>Beginning with V8.10, you can declare multiple <code class="language-plaintext highlighter-rouge">DaemonPortOptions</code> options,
where each causes the single listening daemon to accept connections over
multiple sockets.</p>

<p>The list of some keys (DaemonPortOptions option keywords):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>+--------+---------------------------+-------------------------------------------------+
| Key    |                           | Meaning                                         |
+--------+---------------------------+-------------------------------------------------+
| Addr   | DaemonPortOptions=Addr=   | The network to accept connection from           |
+--------+---------------------------+-------------------------------------------------+
| Name   | DaemonPortOptions=Name=   | User-definable name for the daemon              | 
+--------+---------------------------+-------------------------------------------------+
| Port   | DaemonPortOptions=Port=   | The port number on which sendmail should listen |
+--------+---------------------------+-------------------------------------------------+
| Modify | DaemonPortOptions=Modify= | Modify selected characteristics of the port     |
+--------+---------------------------+-------------------------------------------------+
</code></pre></div></div>

<p>Only the first character in each key is recognized so a succinct 
declaration such as the following can be used to change the port 
used by the daemon:</p>

<p><code class="language-plaintext highlighter-rouge">O DaemonPortOptions=P=26,A=our-addr  # Only listen for local mail on nonstandard port 26</code></p>

<h3 id="daemonportoptionsmodify">DaemonPortOptions=Modify=</h3>

<p>Beginning with V8.10 <em>sendmail</em>, you can modify selected characteristics
of the port.  Modification is done by listing selected letters following
the <code class="language-plaintext highlighter-rouge">Modify=</code> (or <code class="language-plaintext highlighter-rouge">M=</code>).</p>

<p>Some <code class="language-plaintext highlighter-rouge">Modify=</code> port option letters are listed in the tabel below.</p>

<p>Note that the letters are case-sensitive.  Also note only <code class="language-plaintext highlighter-rouge">h</code>, <code class="language-plaintext highlighter-rouge">S</code>, and
<code class="language-plaintext highlighter-rouge">A</code> are valid for the <code class="language-plaintext highlighter-rouge">ClientPortOptions</code> option.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>+--------+-----------------------------------------------------------------------------------+
| Letter | Meaning                                                                           |
+--------+-----------------------------------------------------------------------------------+
| a      | Require authentication with the AUTH ESMTP keyword before continuing with         | 
|        | the connection.  Do not use this setting on a public MTA that listens on port 25! |
+--------+-----------------------------------------------------------------------------------+
| s      | Use SMTP over SSL                                                                 | 
+--------+-----------------------------------------------------------------------------------+ 
| A      | Disable authentication - overrides the a modifier above.                          |
+--------+-----------------------------------------------------------------------------------+ 
| E      | Disallow use of the ETRN command as per RFC2476.                                  |
+--------+-----------------------------------------------------------------------------------+ 
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">DaemonPortOptions</code> option is not safe.  If specified from the command
line, it can cause sendmail to relinquish its special privileges.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># grep -r DaemonPortOptions /etc/mail/ 
/etc/mail/sendmail.cf:O DaemonPortOptions=Name=MTA, M=A
/etc/mail/sendmail.cf:O DaemonPortOptions=Port=465, Name=MTASSL, M=s a
/etc/mail/sendmail.cf:O DaemonPortOptions=Port=587, Name=MSA, M=a
/etc/mail/sendmail.cf:O DaemonPortOptions=Addr=127.0.0.1, Port=10026
/etc/mail/submit.cf:O DaemonPortOptions=Name=NoMTA, Addr=127.0.0.1, M=E
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">M=a</code> for the <code class="language-plaintext highlighter-rouge">DaemonPortOptions</code> option determines whether the 
connection must be authenticated for all connections, or whether only
a sender that tries to relay must be authenticated.  With a lowercase <code class="language-plaintext highlighter-rouge">a</code>,
that is <code class="language-plaintext highlighter-rouge">M=a</code>, <em>sendmail</em> requires connection authentication for all inbound
connections to the server.  To turn that off and only require the sender
to authenticate, use <code class="language-plaintext highlighter-rouge">M=A</code>.</p>

<p>With the <code class="language-plaintext highlighter-rouge">M=A</code> setting, you can screen individual users for relaying
permission using rule sets.  If your server receives mail from the
Internet, you must use <code class="language-plaintext highlighter-rouge">M=A</code> instead of <code class="language-plaintext highlighter-rouge">M=a</code>.</p>

<h3 id="daemonportoptionsname">DaemonPortOptions=Name=</h3>

<p>Because <em>sendmail</em> can listen on different ports simultaneously, and can 
bind to specific interfaces, it is desirable that each such instance be 
given a distinctive name.  When listening on port 25 for inbound mail,
<em>sendmail</em> is functioning as an MTA.  When listening on port 587 for
locally submitted mail, <em>sendmail</em> is functioning as an MSA.</p>

<p>This <code class="language-plaintext highlighter-rouge">DaemonPortOptions=Name=</code> is used to set the name that will be
reported with the <code class="language-plaintext highlighter-rouge">daemon=</code> syslog equate (<a href="#daemon-syslog-equate">daemon=</a>)
and that is placed into a <code class="language-plaintext highlighter-rouge">${daemon_name}</code> (<a href="#daemon_name-macro">daemon_name macro</a>)
or <code class="language-plaintext highlighter-rouge">${client_name}</code> (<a href="#client_name-macro">client_name macro</a>).</p>

<p>Many errors in connections now produce error messages that include
the expression:</p>

<p><code class="language-plaintext highlighter-rouge">daemon name</code></p>

<p>to help clarify which port and role ran into a problem.</p>

<p>Instruct daemon not to listen on port 587 for local MSA:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># grep -B1 DAEMON_OPTIONS /etc/mail/sendmail.mc
FEATURE(`no_default_msa')dnl
DAEMON_OPTIONS(`Name=MTA, M=A')dnl
DAEMON_OPTIONS(`Port=465, Name=MTASSL, M=s a')dnl
DAEMON_OPTIONS(`Port=587, Name=MSA, M=a')dnl
DAEMON_OPTIONS(`Addr=127.0.0.1, Port=10026')dnl
</code></pre></div></div>

<h3 id="daemonportoptionsport">DaemonPortOptions=Port=</h3>

<p>The <code class="language-plaintext highlighter-rouge">Port</code> key is used to specify the service port on which the daemon
should listen.  This is normally the port called <code class="language-plaintext highlighter-rouge">smtp</code>, as defined in
the <em>/etc/services</em> file.  The value can be either a services string
(such as <code class="language-plaintext highlighter-rouge">smtp</code>) or a number (such as 25).  This key is useful inside
domains that are protected by a firewall.  By specifying a nonstandard
port, the firewall can communicate in a more secure manner with the
internal network while still accepting mail on the normal port from
the outside world:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>O DaemonPortOptions=Port=26
</code></pre></div></div>

<p>If this pair is missing, the port defaults to <code class="language-plaintext highlighter-rouge">smtp</code>.</p>

<p>As of V8.10, <em>sendmail</em> also obeys RFC2476 and (by default) listens on
port 587 for the local submission of mail (unless turned off with the
<code class="language-plaintext highlighter-rouge">FEATURE(no_default_msa)</code>).</p>

<h2 id="sasl-and-rule-sets">SASL and Rule Sets</h2>

<p>The SMTP <code class="language-plaintext highlighter-rouge">AUTH</code> extension, enabled by SASL, allows client machines to
relay mail through the authentication-checking server.  This mechanism is
especially useful for roaming users whose laptops seldom have a constant
IP number or hostname assigned.  A special rule set called <code class="language-plaintext highlighter-rouge">trust_auth</code>, 
found inside the <em>sendmail</em> configuration file, does the actual checking.
This rule set decides whether the client’s authentication identifier
(<code class="language-plaintext highlighter-rouge">authid</code>) is trusted to act as (proxy for) the requested authorization
identity (<code class="language-plaintext highlighter-rouge">userid</code>).  It allows <code class="language-plaintext highlighter-rouge">authid</code> to act for <code class="language-plaintext highlighter-rouge">userid</code> if both are
recognized, and disallows that action if the authentication fails.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># grep -r trust_auth /etc/mail/ | grep -v \#
/etc/mail/sendmail.cf:SLocal_trust_auth
/etc/mail/sendmail.cf:Strust_auth
/etc/mail/sendmail.cf:R$* $| $*         $: $1 $| $&gt;"Local_trust_auth" $2
/etc/mail/submit.cf:SLocal_trust_auth
/etc/mail/submit.cf:Strust_auth
/etc/mail/submit.cf:R$* $| $*           $: $1 $| $&gt;"Local_trust_auth" $2
</code></pre></div></div>

<p>Another rule set, called <code class="language-plaintext highlighter-rouge">Local_trust_auth</code>, is available if you wish to
supplement the basic test provided by <code class="language-plaintext highlighter-rouge">trust_auth</code>.  The <code class="language-plaintext highlighter-rouge">Local_trust_auth</code>
rule set can return the <code class="language-plaintext highlighter-rouge">#error</code> delivery agent to disallow proxying, or it
can return OK to allow proxying.</p>

<p>Within the <code class="language-plaintext highlighter-rouge">Local_trust_auth</code> rule set you can use three <em>sendmail</em> macros
(in addition to the other normal sendmail macros). They are:</p>

<p><code class="language-plaintext highlighter-rouge">{auth_authen}</code>: The client’s authentication credentials as determined by
the authentication process.</p>

<p><code class="language-plaintext highlighter-rouge">{auth_author}</code>: The authorization identity as set by issuance of the
<code class="language-plaintext highlighter-rouge">SMTP AUTH=</code> parameter.  This could be either a <em>username</em> or a
<em>user@host.domain</em> address.</p>

<p><code class="language-plaintext highlighter-rouge">{auth_type}</code>: The mechanism used for authentication, such as LOGIN and PLAIN.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># grep -r auth_authen /etc/mail/ | grep -v \#
/etc/mail/sendmail.cf:O Milter.macros.envfrom=i, {auth_type}, {auth_authen}, {auth_ssf}, {auth_author}, {mail_mailer}, {mail_host}, {mail_addr}
/etc/mail/sendmail.cf:R$* $| $&amp;{auth_authen}            $@ identical
/etc/mail/sendmail.cf:R$* $| &lt;$&amp;{auth_authen}&gt;  $@ identical
/etc/mail/submit.cf:R$* $| $&amp;{auth_authen}              $@ identical
/etc/mail/submit.cf:R$* $| &lt;$&amp;{auth_authen}&gt;    $@ identical
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># grep -r auth_author /etc/mail/ | grep -v \#
/etc/mail/sendmail.cf:O Milter.macros.envfrom=i, {auth_type}, {auth_authen}, {auth_ssf}, {auth_author}, {mail_mailer}, {mail_host}, {mail_addr}
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># grep -r auth_type /etc/mail/ | grep -v \#
/etc/mail/sendmail.cf:O Milter.macros.envfrom=i, {auth_type}, {auth_authen}, {auth_ssf}, {auth_author}, {mail_mailer}, {mail_host}, {mail_addr}
/etc/mail/sendmail.cf:  $.$?{auth_type}(authenticated$?{auth_ssf} bits=${auth_ssf}$.)
/etc/mail/sendmail.cf:R$*                       $: $1 $| $&gt;"Local_Relay_Auth" $&amp;{auth_type}
/etc/mail/sendmail.cf:R$* $| $*         $: $1 $| $&amp;{auth_type}
/etc/mail/sendmail.cf:R$*                       $: $&amp;{auth_type} $| $1
/etc/mail/submit.cf:    $.$?{auth_type}(authenticated$?{auth_ssf} bits=${auth_ssf}$.)
/etc/mail/submit.cf:R$*                 $: $1 $| $&gt;"Local_Relay_Auth" $&amp;{auth_type}
/etc/mail/submit.cf:R$* $| $*           $: $1 $| $&amp;{auth_type}
/etc/mail/submit.cf:R$*                 $: $&amp;{auth_type} $| $1
</code></pre></div></div>

<h2 id="daemon-syslog-equate">daemon Syslog Equate</h2>

<p><strong>daemon=</strong></p>

<p>The name of the sender’s daemon syslog equate</p>

<p>When <em>sendmail</em> logs the sender of a message it includes a <em>syslog</em> equate
that shows the name of the daemon that handled the transaction.
Daemons are named with the <code class="language-plaintext highlighter-rouge">DaemonPortOptions</code> option’s <code class="language-plaintext highlighter-rouge">Name</code> pair
(<code class="language-plaintext highlighter-rouge">DaemonPortOptions=Name=</code>).</p>

<p>For example:</p>

<p><code class="language-plaintext highlighter-rouge">O DaemonPortOptions=Name=MTA</code></p>

<p>Whenever <em>sendmail</em> logs the sender of a message (with <code class="language-plaintext highlighter-rouge">from=</code>) and when
the message was handled by a daemon (not standard input), this <code class="language-plaintext highlighter-rouge">daemon=</code>
<em>syslog</em> equate will show the daemon’s name.</p>

<h2 id="daemon_name-macro">daemon_name Macro</h2>

<p><strong>${daemon_name}</strong></p>

<p>Listening daemon’s name</p>

<p>The <code class="language-plaintext highlighter-rouge">${daemon_name}</code> macro contains the value of the
<code class="language-plaintext highlighter-rouge">DaemonPortOptions=Name</code> option (<code class="language-plaintext highlighter-rouge">DaemonPortOptions=Name=</code>) whenever an
inbound connection is accepted.  The names assigned in the default
configuration file are MTA (for the daemon that listens on port 25) and
MSA (for the MSP daemon that listens on port 587).</p>

<p>As distributed, this <code class="language-plaintext highlighter-rouge">${daemon_name}</code> macro is not used in the
configuration file.  It is, however, available to you for use in designing
your own particular rule sets.  Note that a <code class="language-plaintext highlighter-rouge">$&amp;</code> prefix is necessary when
you reference this macro in rules (that is, use <code class="language-plaintext highlighter-rouge">$&amp;{daemon_name}</code>,
not <code class="language-plaintext highlighter-rouge">${daemon_name}</code>).</p>

<p><code class="language-plaintext highlighter-rouge">${daemon_name}</code> is transient.  If it is defined in the configuration file
or in the command line, that definition can be ignored by <em>sendmail</em>.</p>

<h2 id="client_name-macro">client_name Macro</h2>

<p><strong>${client_name}</strong></p>

<p>The connecting host’s canonical name.</p>

<p>The <code class="language-plaintext highlighter-rouge">${client_name}</code> macro is assigned its value when a host connects to
the running daemon.  This macro holds as its value the canonical hostname
of that connecting host, which is the same as the hostname stored in the
<code class="language-plaintext highlighter-rouge">$_</code> macro.</p>

<p>The <code class="language-plaintext highlighter-rouge">${client_name}</code> macro is useful in the <code class="language-plaintext highlighter-rouge">Local_check_rcpt</code>
(<a href="#local_check_rcpt-and-check_rcpt-rule-sets">Local_check_rcpt</a>),
<code class="language-plaintext highlighter-rouge">Local_check_mail</code> (<a href="#local_check_mail-and-check_mail-rule-sets">Local_check_mail</a>),
and <code class="language-plaintext highlighter-rouge">Local_check_relay</code> (<a href="#local_check_relay-and-check_relay-rule-sets">Local_check_relay and check_relay </a>)
rule sets.</p>

<h2 id="local_check_rcpt-and-check_rcpt-rule-sets">Local_check_rcpt and check_rcpt Rule Sets</h2>

<p><strong>Local_check_rcpt</strong> and <strong>check_rcpt</strong></p>

<p>The <code class="language-plaintext highlighter-rouge">Local_check_rcpt</code> rule set provides a hook into the <code class="language-plaintext highlighter-rouge">check_rcpt</code>
rule set, which is used to validate the recipient-sender address given in
the <code class="language-plaintext highlighter-rouge">RCPT To:</code> command in the SMTP dialog:</p>

<p><code class="language-plaintext highlighter-rouge">RCPT To:&lt;recipient@host.domain&gt;</code></p>

<p>The <code class="language-plaintext highlighter-rouge">check_rcpt</code> rule set is called immediately after the <code class="language-plaintext highlighter-rouge">RCPT To:</code>
command is read.  The workspace that is passed to <code class="language-plaintext highlighter-rouge">check_rcpt</code> is the
address following the colon.  The envelope-recipient address might or
might not be surrounded by angle brackets and might or might not have
other RFC2822 comments associated with it.</p>

<p>The <code class="language-plaintext highlighter-rouge">check_rcpt</code> rule set has default rules that do the following:</p>

<ul>
  <li>Reject empty envelope-recipient addresses, such as <code class="language-plaintext highlighter-rouge">&lt; &gt;</code>, and those
which have nothing following the <code class="language-plaintext highlighter-rouge">RCPT To:</code>.</li>
  <li>Ensure that the envelope-recipient address is either local, or one that
is allowed to be relayed.</li>
  <li>If the <em>access</em> database (<a href="#the-access-database">The access Database</a>)
is used, look up the envelope-recipient’s host in that database and
reject, accept, or defer the message based on the returned lookup value.
If the <code class="language-plaintext highlighter-rouge">FEATURE(blacklist_recipients)</code> is declared, they also look up
the envelope recipient in that database.</li>
</ul>

<h2 id="local_check_mail-and-check_mail-rule-sets">Local_check_mail and check_mail Rule Sets</h2>

<p><strong>Local_check_mail</strong> and <strong>check_mail</strong></p>

<p>The <code class="language-plaintext highlighter-rouge">Local_check_mail</code> rule set provides a hook into the <code class="language-plaintext highlighter-rouge">check_mail</code>
rule set, which is used to validate the envelope-sender address given in
the <code class="language-plaintext highlighter-rouge">MAIL From:</code> command of the SMTP dialog:</p>

<p><code class="language-plaintext highlighter-rouge">MAIL From:&lt;sender@host.domain&gt;</code></p>

<p>The <code class="language-plaintext highlighter-rouge">check_mail</code> rule set is called immediately after the <code class="language-plaintext highlighter-rouge">MAIL From:</code>
command is read.  The workspace passed to <code class="language-plaintext highlighter-rouge">check_mail</code> is the address
following the colon in the <code class="language-plaintext highlighter-rouge">MAIL From:</code> command.  That envelope-sender
address might or might not be surrounded by angle braces.</p>

<p>If <em>sendmail</em>’s delivery mode is anything other than 
deferred (<code class="language-plaintext highlighter-rouge">-bd</code>) (<a href="#-bd-command-line-switch">-bd Command-Line Switch</a>),
the <code class="language-plaintext highlighter-rouge">check_mail</code> rule set performs the following default actions:</p>

<ul>
  <li>Calls the <em>tls_client</em> rule set to perform TLS verification, if needed</li>
  <li>Accepts all envelope-sender addresses of the form <code class="language-plaintext highlighter-rouge">&lt; &gt;</code></li>
  <li>Makes certain that the host and domain part of the envelope-sender
address exists</li>
  <li>If the <em>access</em> database is used, looks up the envelope-sender in that
database and rejects, accepts, or defers the message based on the
returned lookup value</li>
</ul>

<p>The <code class="language-plaintext highlighter-rouge">Local_check_mail</code> rule set provides a hook into <code class="language-plaintext highlighter-rouge">check_mail</code> before
the preceding checks are made, and provides a place for you to insert your
own rules.</p>

<h2 id="local_check_relay-and-check_relay-rule-sets">Local_check_relay and check_relay Rule Sets</h2>

<p><strong>Local_check_relay</strong> and <strong>check_relay</strong></p>

<p>Sendmail supports three mechanisms for screening incoming SMTP connections:</p>

<ul>
  <li>the <em>libwrap.a</em> mechanism</li>
  <li>the <code class="language-plaintext highlighter-rouge">check_relay</code> rule set</li>
  <li>the <em>access</em> database mechanism</li>
</ul>

<p>The <code class="language-plaintext highlighter-rouge">Local_check_relay</code> rule set provides a hook into the <code class="language-plaintext highlighter-rouge">check_relay</code>
rule set, which is used to screen incoming network connections and accept
or reject them based on the hostname, domain, or IP address.  It is called
just before the <em>libwrap.a</em> code and can be used even if that code was
omitted from your release of <em>sendmail</em>.  Note that the <code class="language-plaintext highlighter-rouge">check_relay</code> rule
set is not called if <em>sendmail</em> was run with the <code class="language-plaintext highlighter-rouge">-bs</code> command-line switch
(<a href="#-bs-command-line-switch">-bs Command-Line Switch</a>).</p>

<h2 id="-bd-command-line-switch">-bd Command-Line Switch</h2>

<p><strong>-bd</strong></p>

<p>Run as a daemon</p>

<p>The <code class="language-plaintext highlighter-rouge">-bd</code> command-line switch causes <em>sendmail</em> to become a daemon,
running in the background, listening for and handling incoming SMTP
connections. (In its classic invocation, <code class="language-plaintext highlighter-rouge">-bd</code> is usually combined
with a <code class="language-plaintext highlighter-rouge">-q1h</code>.)</p>

<p>To become a daemon, <em>sendmail</em> first performs a <em>fork(2)</em>.  The parent
then exits, and the child becomes the daemon by disconnecting itself from
its controlling terminal.  The <code class="language-plaintext highlighter-rouge">-bD</code> command-line switch can be used to
prevent the <em>fork(2)</em> and the detachment and allows the <em>sendmail</em>
program’s behavior to be observed while it runs in daemon mode.</p>

<p>As a daemon, <em>sendmail</em> does a <em>listen(2)</em> on TCP port 25 by default for
incoming SMTP messages. (Beginning with V8.10, <em>sendmail</em> also listens on
port 587 for message submissions via MUAs.  This default behavior can be
turned off with the <code class="language-plaintext highlighter-rouge">FEATURE(no_default_msa)</code>.)  When another site connects
to the listening daemon, the daemon performs a <em>fork(2)</em>, and the child
handles receipt of the incoming mail message.</p>

<h2 id="-bs-command-line-switch">-bs Command-Line Switch</h2>

<p><strong>-bs</strong></p>

<p>Run SMTP on standard input</p>

<p>The <em>-bs</em> command-line switch causes <em>sendmail</em> to run a single SMTP
session in the foreground over its standard input and output, and then exit.
The SMTP session is exactly like a network SMTP session.  Usually, one or
more messages are submitted to <em>sendmail</em> for delivery.</p>

<p>This mode is intended for use at sites that wish to run <em>sendmail</em> with
the <em>inetd(8)</em> daemon.  To implement this, place an entry such as the
following in your <em>inetd.conf(5)</em> file, and then restart <em>inetd(8)</em> by
killing it with a SIGHUP signal:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>smtp   stream  tcp   nowait  root /usr/sbin/sendmail sendmail -bs
</code></pre></div></div>

<p>With this scheme it is important to either use <em>cron(3)</em> to run <em>sendmail</em>
periodically to process its queue:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0 * * * * /usr/sbin/sendmail -q
</code></pre></div></div>

<p>or run <em>sendmail</em> in the background to process the queue periodically by
specifying an interval to the <code class="language-plaintext highlighter-rouge">-q</code> command-line switch’s interval:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/usr/sbin/sendmail -q1h
</code></pre></div></div>

<p>In general, the <em>inetd(8)</em> approach should be used only on lightly loaded
machines that receive few SMTP connections.</p>

<p>The <code class="language-plaintext highlighter-rouge">-bs</code> switch is also useful for MUAs that prefer to use SMTP rather
than a pipe to transfer a mail message to <em>sendmail</em>.
Depending on how it is configured, <em>mh(1)</em> can use this feature.</p>

<h2 id="-bt-command-line-switch-with-debug-options">-bt Command-Line Switch (with Debug Options)</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># sendmail -bt -d21.12 -d60 -d38
[ . . . ]
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">-d21.12</code> debug switch is for tracing <em>sendmail</em> rules and rule sets. <br />
The <code class="language-plaintext highlighter-rouge">-d38</code> debug switch is for showing <em>sendmail</em> database map opens and failures.  <br />
The <code class="language-plaintext highlighter-rouge">-d60</code> debug switch is for tracing <em>sendmail</em> database map lookups.</p>

<h2 id="sendmail-debug-lookups">Sendmail Debug Lookups</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sendmail -d60.5 -bt &lt;&lt; END
 /tryflags E
 /try relay dusko@yourdomain.com
 END
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-d60.5 - trace map lookups (including genericstable lookups)
-d21.12 - trace R lines processing, use it when genericstable is not
consulted at all

/tryflags flags:
hs - header sender (genericstable rewrites only it by default)
hr - header recipient
es - evelope sender ("MAIL FROM:" in SMTP session) 
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sendmail -d21.12 -bt 
ADDRESS TEST MODE (ruleset 3 NOT automatically invoked)
Enter &lt;ruleset&gt; &lt;address&gt;
&gt; /tryflags hs
&gt; /try esmtp dusko
</code></pre></div></div>

<p><a href="https://groups.google.com/g/comp.mail.sendmail/c/Muk7q_7qnUs/m/U4epocS9fEIJ">access map rule for eliminate dnsbl lookup</a></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ echo 'A &lt;16.19.2.333&gt;&lt;default&gt;&lt;+Connect&gt;&lt;passthru&gt;' | sendmail -d60.5 -bt
ADDRESS TEST MODE (ruleset 3 NOT automatically invoked)
Enter &lt;ruleset&gt; &lt;address&gt;
&gt; A                  input: &lt; 16 . 19 . 2 . 333 &gt; &lt; default &gt; &lt; + Connect &gt; &lt; passthru &gt;
A                  input: &lt; 16 . 19 . 2 &gt; &lt; default &gt; &lt; + Connect &gt; &lt; passthru &gt;
A                  input: &lt; 16 . 19 &gt; &lt; default &gt; &lt; + Connect &gt; &lt; passthru &gt;
A                  input: &lt; 16 &gt; &lt; default &gt; &lt; + Connect &gt; &lt; passthru &gt;
A                returns: &lt; default &gt; &lt; passthru &gt;
A                returns: &lt; default &gt; &lt; passthru &gt;
A                returns: &lt; default &gt; &lt; passthru &gt;
A                returns: &lt; default &gt; &lt; passthru &gt;
&gt; $ 
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ echo 'A &lt;16.19.2.333&gt;&lt;default&gt;&lt;+Connect&gt;&lt;passthru&gt;' | sendmail -d60.5 -bt | tail -2 
A                returns: &lt; default &gt; &lt; passthru &gt;
&gt; $ 
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ echo 'A &lt;16.1.2.333&gt;&lt;default&gt;&lt;+Connect&gt;&lt;passthru&gt;' | sendmail -d60.5 -bt | tail -2 
A                returns: &lt; default &gt; &lt; passthru &gt;
&gt; $ 
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sendmail -d38.20 -v -oi &lt;&lt;END 
To: dusko@fbsd1.yourprovider.com
Subject: hello

Testing.
END
openmap()       dequote:dequote NULL: valid
Recipient names must be specified
closemaps: closing dequote (NULL)
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo sendmail -d38.20 -Ac -v -i -t &lt;&lt; END
To: dusko@yourprovider.com
Subject: Test

Testing.
END
openmap()       dequote:dequote NULL: valid
openmap()       host:host NULL: valid
getcanonname(yourprovider.com), trying dns
getcanonname(yourprovider.com), found, ad=0
dusko@yourprovider.com... Connecting to [127.0.0.1] port 1465 via smartrelay...
220 mailx.yourprovider.com ESMTP mailer ready at Wed, 7 Dec 2022 12:17:13 -0800
&gt;&gt;&gt; EHLO fbsd1.yourisp.com
250-mailx.yourprovider.com Hello fbsd1.yourisp.com [123.45.67.89], pleased to meet you
250-ENHANCEDSTATUSCODES
250-8BITMIME
250-SIZE 52428800
250-AUTH LOGIN PLAIN
250-DELIVERBY
250 HELP
hash_map_open(authinfo, /etc/mail/authinfo, 0)
openmap()       hash:authinfo /etc/mail/authinfo: valid
db_map_lookup(authinfo, AuthInfo:[127.0.0.1])
&gt;&gt;&gt; AUTH LOGIN
334 VXNlcm5hbWU6
&gt;&gt;&gt; ZABcd12=
334 UGFzc3dvcmQ6
&gt;&gt;&gt; TABcDE1fGHIjKLmnOPQ2rS==
235 2.0.0 OK Authenticated
&gt;&gt;&gt; MAIL From:&lt;dusko@fbsd1.yourisp.com&gt; SIZE=46 AUTH=dusko@yourisp.com
250 2.1.0 &lt;dusko@fbsd1.yourisp.com&gt;... Sender ok
&gt;&gt;&gt; RCPT To:&lt;dusko@yourprovider.com&gt;
250 2.1.5 &lt;dusko@yourprovider.com&gt;... Recipient ok
&gt;&gt;&gt; DATA
354 Enter mail, end with "." on a line by itself
&gt;&gt;&gt; .
250 2.0.0 2B7KHDhI015382 Message accepted for delivery
dusko@yourprovider.com... Sent (2B7KHDhI015382 Message accepted for delivery)
Closing connection to [127.0.0.1]
&gt;&gt;&gt; QUIT
221 2.0.0 mailx.yourprovider.com closing connection
closemaps: closing authinfo (/etc/mail/authinfo)
db_map_close(authinfo, /etc/mail/authinfo, 1000121)
closemaps: closing host (NULL)
closemaps: closing dequote (NULL)
</code></pre></div></div>

<h2 id="no_default_msa-feature">no_default_msa FEATURE</h2>

<p><strong>FEATURE(no_default_msa)</strong></p>

<p>Disable automatic listening on MSA port 587</p>

<p>From V8.10, when <em>sendmail</em> starts up in <em>daemon</em> mode, it listens both on
the normal port 25 for incoming SMTP connections, and on port 587 for the
local submission of mail.  This later role is that of an MSA (documented
in RFC2476).</p>

<p>If you prefer to disable this service, you can do it with the FEATURE(no_default_msa):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>FEATURE(`no_default_msa')
</code></pre></div></div>

<p>Since there is no way to directly change the settings of the MSA in your
<em>mc</em> configuration file, you can use the following trick if you need to
change, say, the <code class="language-plaintext highlighter-rouge">M=</code> equate from <code class="language-plaintext highlighter-rouge">M=E</code> to <code class="language-plaintext highlighter-rouge">M=Ea</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>FEATURE(`no_default_msa')
DAEMON_OPTIONS(`Port=587,Name=MSA,M=Ea')
</code></pre></div></div>

<p>Here, this feature prevents the automatic creation of an <em>mc</em> configuration
entry for an MSA.  You then insert your own declaration, with your new settings.</p>

<p>Be aware, however, that this feature also disables the listening daemon on
port 25.  If you use this feature, be certain to redeclare a port 25 daemon
if you need one:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>FEATURE(`no_default_msa')
DAEMON_OPTIONS(`Port=587,Name=MSA,M=Ea')
DAEMON_OPTIONS(`Port=smtp, Name=MTA')
</code></pre></div></div>

<h2 id="starttls">STARTTLS</h2>

<p>Encryption can improve the security of <em>sendmail</em>.  Ordinarily, mail is
sent between two machines in the clear.  That is, if you were to watch
the transmission of bytes over the network (with for example <em>tcpdump</em>
utility) you would see what is actually being sent or received.
This includes passwords, which are also sent in the clear.</p>

<p>To reduce the likelihood that someone watching the network will find something that can harm you, you can encrypt the stream of data. Three forms of encryption are available:</p>

<ul>
  <li>
    <p>SSL <br />
SSL is a method for encrypting a single connection over which network
traffic can flow. <br />
One implementation of SSL is available from
<a href="http://www.openssl.org/">http://www.openssl.org/</a>.</p>
  </li>
  <li>
    <p>TLS  <br />
Transport Layer Security, defined by RFC2246, is the successor to SSL that
provides further means of connection encryption.  It, too, is available from 
<a href="http://www.openssl.org/">http://www.openssl.org/</a>.</p>
  </li>
  <li>
    <p>SMTP <code class="language-plaintext highlighter-rouge">AUTH=</code>  <br />
The DIGEST-MD5 and GSSAPI mechanisms, among others, for the <code class="language-plaintext highlighter-rouge">AUTH=</code> extension
to SMTP, also provide stream encryption.</p>
  </li>
</ul>

<h3 id="todo--starttls-and-the-access-database">[TODO]:  STARTTLS and the access Database</h3>

<p>Four prefixes in the <em>access</em> database are available for use with
STARTTLS connection encryption.</p>

<p><code class="language-plaintext highlighter-rouge">CERTISSUER:</code> and <code class="language-plaintext highlighter-rouge">CERTSUBJECT:</code> are for use with the <code class="language-plaintext highlighter-rouge">Local_Relay_Auth</code>
rule set.  <code class="language-plaintext highlighter-rouge">TLS_Srv:</code> and <code class="language-plaintext highlighter-rouge">TLS_Clt:</code> are for use with the <code class="language-plaintext highlighter-rouge">tls_server</code>
and <code class="language-plaintext highlighter-rouge">tls_client</code> rule sets.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># grep -n CERTISSUER /etc/mail/sendmail.cf
1774:R$+                        $: $(access CERTISSUER:$1 $)
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># grep -n CERTSUBJECT /etc/mail/sendmail.cf
1777:R&lt;@&gt; $+                    $: &lt;@&gt; $(access CERTSUBJECT:$1 $)
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># sed -n 1762,1779p /etc/mail/sendmail.cf
######################################################################
###  RelayTLS: allow relaying based on TLS authentication
###
###     Parameters:
###             none
######################################################################
SRelayTLS
# authenticated?
R$*                     $: &lt;?&gt; $&amp;{verify}
R&lt;?&gt; OK                 $: OK           authenticated: continue
R&lt;?&gt; $*                 $@ NO           not authenticated
R$*                     $: $&amp;{cert_issuer}
R$+                     $: $(access CERTISSUER:$1 $)
RRELAY                  $# RELAY
RSUBJECT                $: &lt;@&gt; $&amp;{cert_subject}
R&lt;@&gt; $+                 $: &lt;@&gt; $(access CERTSUBJECT:$1 $)
R&lt;@&gt; RELAY              $# RELAY
R$*                     $: NO
</code></pre></div></div>

<h3 id="the-access-database-with-tls_server-and-tls_client">The access database with tls_server and tls_client</h3>

<p>The <code class="language-plaintext highlighter-rouge">tls_server</code> rule set is called after the local <em>sendmail</em> issued
(or should have issued) the STARTTLS SMTP command. This rule set handles outbound connections.</p>

<p>The <code class="language-plaintext highlighter-rouge">tls_client</code> rule set is called at two possible points: just after the
connecting host’s STARTTLS SMTP command is offered; and from the
<code class="language-plaintext highlighter-rouge">check_mail</code> rule set (which is called just after the connecting host
issues the <code class="language-plaintext highlighter-rouge">MAIL From:</code> command).  This <code class="language-plaintext highlighter-rouge">tls_client</code> rule set handles inbound connections.</p>

<p>Both rule sets are given the value of the <code class="language-plaintext highlighter-rouge">${verify}</code> <em>sendmail</em> macro in
their workspaces.  The <code class="language-plaintext highlighter-rouge">tls_client</code> rule set is given that value, followed
by a <code class="language-plaintext highlighter-rouge">$|</code> operator, and a literal string that is MAIL when <code class="language-plaintext highlighter-rouge">tls_client</code> is
called from the <code class="language-plaintext highlighter-rouge">check_mail</code> rule set, or STARTTLS otherwise.</p>

<p>If the <em>access</em> database is not used, the connection is allowed in all
cases, both inbound and outbound, unless the value in <code class="language-plaintext highlighter-rouge">${verify}</code> is
SOFTWARE, in which case the connection is not allowed.</p>

<p>If the <em>access</em> database is used, the <code class="language-plaintext highlighter-rouge">tls_server</code> rule set looks up the
hostname of the destination host in the <em>access</em> database using the
<code class="language-plaintext highlighter-rouge">TLS_Srv:</code> prefix.  For example, if the local <em>sendmail</em> connected to the
server <em>insecure.host.domain</em>, and if the negotiation for the TLS
connection was good, the following lookup is performed:</p>

<p><code class="language-plaintext highlighter-rouge">TLS_Srv:insecure.host.domain</code></p>

<p>The <code class="language-plaintext highlighter-rouge">tls_client</code> rule set looks up the hostname of the inbound connecting
host in the <em>access</em> database using the <code class="language-plaintext highlighter-rouge">TLS_Clt:</code> prefix.  For example,
if the local <em>sendmail</em> accepts a connection from <em>ssl.host.domain</em>, and
if the negotiation for TLS connection was good, the following lookup is performed:</p>

<p><code class="language-plaintext highlighter-rouge">TLS_Clt:ssl.host.domain</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># grep -n TLS_Srv /etc/mail/sendmail.cf
1679:R$*                $: $1 $| $&gt;D &lt;$&amp;{server_name}&gt; &lt;?&gt; &lt;! "TLS_Srv"&gt; &lt;&gt;
1680:R$* $| &lt;?&gt;$*       $: $1 $| $&gt;A &lt;$&amp;{server_addr}&gt; &lt;?&gt; &lt;! "TLS_Srv"&gt; &lt;&gt;
1681:R$* $| &lt;?&gt;$*       $: $1 $| &lt;$(access "TLS_Srv": $: ? $)&gt;

# grep -n TLS_Clt /etc/mail/sendmail.cf
1450:SDelay_TLS_Clt
1457:SDelay_TLS_Clt2
1471:R$+ $| $#$*                $@ $&gt;"Delay_TLS_Clt" $2
1664:R$* $| $*  $: $1 $| $&gt;D &lt;$&amp;{client_name}&gt; &lt;?&gt; &lt;! "TLS_Clt"&gt; &lt;&gt;
1665:R$* $| &lt;?&gt;$*       $: $1 $| $&gt;A &lt;$&amp;{client_addr}&gt; &lt;?&gt; &lt;! "TLS_Clt"&gt; &lt;&gt;
1666:R$* $| &lt;?&gt;$*       $: $1 $| &lt;$(access "TLS_Clt": $: ? $)&gt;
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># grep -r -n TLS_Srv /etc/mail | grep -v 'sendmail.cf' 

# grep -r -n TLS_Clt /etc/mail | grep -v 'sendmail.cf' 
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># sed -n 1450,1462p /etc/mail/sendmail.cf
SDelay_TLS_Clt
# authenticated?
R$*                     $: $1 $| $&gt;"tls_client" $&amp;{verify} $| MAIL
R$* $| $#$+             $#$2
R$* $| $*               $# $1
R$*                     $# $1

SDelay_TLS_Clt2
# authenticated?
R$*                     $: $1 $| $&gt;"tls_client" $&amp;{verify} $| MAIL
R$* $| $#$+             $#$2
R$* $| $*               $@ $1
R$*                     $@ $1
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># sed -n 1655,1683p /etc/mail/sendmail.cf
######################################################################
###  tls_client: is connection with client "good" enough?
###     (done in server)
###
###     Parameters:
###             ${verify} $| (MAIL|STARTTLS)
######################################################################
Stls_client
R$*             $: $(macro {TLS_Name} $@ $&amp;{client_name} $) $1
R$* $| $*       $: $1 $| $&gt;D &lt;$&amp;{client_name}&gt; &lt;?&gt; &lt;! "TLS_Clt"&gt; &lt;&gt;
R$* $| &lt;?&gt;$*    $: $1 $| $&gt;A &lt;$&amp;{client_addr}&gt; &lt;?&gt; &lt;! "TLS_Clt"&gt; &lt;&gt;
R$* $| &lt;?&gt;$*    $: $1 $| &lt;$(access "TLS_Clt": $: ? $)&gt;
R$* $| &lt;$* &lt;TMPF&gt;&gt;    $#error $@ 4.3.0 $: "451 Temporary system failure. Please try again later."
R$*             $@ $&gt;"TLS_connection" $1

######################################################################
###  tls_server: is connection with server "good" enough?
###     (done in client)
###
###     Parameter:
###             ${verify}
######################################################################
Stls_server
R$*             $: $(macro {TLS_Name} $@ $&amp;{server_name} $) $1
R$*             $: $1 $| $&gt;D &lt;$&amp;{server_name}&gt; &lt;?&gt; &lt;! "TLS_Srv"&gt; &lt;&gt;
R$* $| &lt;?&gt;$*    $: $1 $| $&gt;A &lt;$&amp;{server_addr}&gt; &lt;?&gt; &lt;! "TLS_Srv"&gt; &lt;&gt;
R$* $| &lt;?&gt;$*    $: $1 $| &lt;$(access "TLS_Srv": $: ? $)&gt;
R$* $| &lt;$* &lt;TMPF&gt;&gt;    $#error $@ 4.3.0 $: "451 Temporary system failure. Please try again later."
R$*             $@ $&gt;"TLS_connection" $1
</code></pre></div></div>

<h2 id="the-access-database">The access Database</h2>

<p>The <em>access</em> database provides a single, central database with rules to
accept, reject, and discard messages based on the sender name, address,
or IP address.  It is enabled with the <code class="language-plaintext highlighter-rouge">FEATURE(access_db)</code>.
(<strong>Note:</strong> Another feature, <code class="language-plaintext highlighter-rouge">FEATURE(blacklist_recipients)</code>, allows
 recipients to also be rejected.  Yet another, <code class="language-plaintext highlighter-rouge">FEATURE(delay_checks)</code>,
 allows even finer tuning based on the desire of individual recipients.)</p>

<p>For example, consider an access database with the following contents:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>From:postmaster@spam.com   OK
From:spam.com              REJECT
</code></pre></div></div>

<p>Here, mail from <em>postmaster</em> at the site <em>spam.com</em> is accepted, whereas
mail from any other sender at that site is rejected.</p>

<h2 id="sendmail-command-line-arguments">Sendmail Command-Line Arguments</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% sendmail -i -v -d35.9,21.12 dusko
[ . . . ]
</code></pre></div></div>

<h2 id="references">References</h2>

<p><a href="https://explained-from-first-principles.com/email/">Email explained from first principles</a></p>

<p><a href="http://novosial.org/sendmail/index.html">Sendmail overview diagram - Email flow</a></p>

<p><a href="https://docs.oracle.com/cd/E19253-01/816-4555/fvbrb/index.html">Support for Running SMTP With TLS in Version 8.13 of sendmail</a></p>
<blockquote>
  <p>Security Considerations Related to Running SMTP With TLS</p>

  <p>As a standard mail protocol that defines mailers that run over the
Internet, SMTP is not an end-to-end mechanism.  Because of this protocol
limitation, TLS security through SMTP does not include mail user agents.
Mail user agents act as an interface between users and a mail transfer
agent (MTA) such as sendmail.</p>

  <p>Also, mail might be routed through multiple servers.  For complete SMTP
security the entire chain of SMTP connections must have TLS support.</p>

  <p>[ . . . ]</p>

  <p><strong>Note -</strong>  <br />
The implementation of TLS is based on the Secure Sockets Layer (SSL) protocol.</p>

  <p><code class="language-plaintext highlighter-rouge">STARTTLS</code> is the SMTP keyword that initiates a secure SMTP connection
by using TLS.  This secure connection might be between two servers or
between a server and a client.  A secure connection is defined as follows:</p>
  <ul>
    <li>The source email address and the destination address are encrypted.</li>
    <li>The content of the email message is encrypted.</li>
  </ul>

  <p>When the client issues the <code class="language-plaintext highlighter-rouge">STARTTLS</code> command, the server responds with
one of the following:</p>
  <ul>
    <li><code class="language-plaintext highlighter-rouge">220 Ready to start TLS</code></li>
    <li><code class="language-plaintext highlighter-rouge">501 Syntax error (no parameters allowed)</code></li>
    <li><code class="language-plaintext highlighter-rouge">454 TLS not available due to temporary reason</code></li>
  </ul>

  <p>The <code class="language-plaintext highlighter-rouge">220</code> response requires the client to start the TLS negotiation.
The <code class="language-plaintext highlighter-rouge">501</code> response notes that the client incorrectly issued the <code class="language-plaintext highlighter-rouge">STARTTLS</code>
command.  STARTTLS is issued with no parameters.  The <code class="language-plaintext highlighter-rouge">454</code> response
necessitates that the client apply rule set values to determine whether
to accept or maintain the connection.</p>

  <p>Note that to maintain the Internet’s SMTP infrastructure, publicly used
servers must not require a TLS negotiation.  However, a server that is
used privately might require the client to perform a TLS negotiation.
In such instances, the server returns this response:</p>

  <p><code class="language-plaintext highlighter-rouge">530 Must issue a STARTTLS command first</code></p>

  <p>The <code class="language-plaintext highlighter-rouge">530</code> response instructs the client to issue the <code class="language-plaintext highlighter-rouge">STARTTLS</code> command
to establish a connection.</p>

  <p>The server or client can refuse a connection if the level of
authentication and privacy is not satisfactory.  Alternately, because
most SMTP connections are not secure, the server and client might
maintain an unsecure connection.  Whether to maintain or refuse
a connection is determined by the configuration of the server and the client.</p>

  <p>Support for running SMTP with TLS is not enabled by default.  TLS is
enabled when the SMTP client issues the STARTTLS command.  Before the
SMTP client can issue this command, you must set up the certificates that
enable <em>sendmail</em> to use TLS.</p>
</blockquote>

<p><a href="https://bsd-box.net/~mikeg/blog/index.php?/archives/35-Lets-talk-about-sex.....html">Secure mail server - IMAPS (Secure IMAP over SSL), SMTP AUTH plus either SMTP+STARTTLS (over Port 25) or SMTPS (over port 465)</a> – or: <a href="https://web.archive.org/web/20221030182616/https://bsd-box.net/~mikeg/blog/index.php?/archives/35-Lets-talk-about-sex.....html%2A">https://web.archive.org/web/20221030182616/https://bsd-box.net/~mikeg/blog/index.php?/archives/35-Lets-talk-about-sex…..html%2A</a></p>

<p><a href="http://www.whoopis.com/howtos/sendmail-auth-howto.html">Secure SMTP AUTH over SSL/STARTTLS with Sendmail and Cyrus SASL, and secure IMAP server Howto</a></p>

<p><a href="https://raysnotebook.info/computing/email-smtp.html">Observing SMTP</a></p>

<p><a href="http://novosial.org/openssl/tls-name/index.html">SSL versus TLS versus STARTTLS</a></p>

<p><a href="https://www.fastmail.help/hc/en-us/articles/360058753834-SSL-TLS-and-STARTTLS">SSL, TLS, and STARTTLS</a></p>

<p><a href="https://www.madboa.com/geek/openssl/">OpenSSL Command-Line HOWTO</a></p>

<p><a href="https://sendgrid.com/blog/whats-the-difference-between-ports-465-and-587/">What’s the Difference Between Ports 465 and 587?</a></p>

<p><a href="https://sendgrid.com/blog/what-is-starttls/">What is StartTLS?</a> – or: <a href="https://sendgrid.com/blog/what-is-starttls/#:~:text=StartTLS%20is%20a%20protocol%20command,different%20command%20for%20encryption%2C%20STLS.">https://sendgrid.com/blog/what-is-starttls/#:~:text=StartTLS%20is%20a%20protocol%20command,different%20command%20for%20encryption%2C%20STLS.</a></p>

<p><a href="https://lists.w3.org/Archives/Public/ietf-tls/1997JanMar/0079.html">The proposal for a standard to submit SMTP messages with encryption - Published in early 1997 - SMTPS - Port 465</a></p>

<p><a href="https://tools.ietf.org/html/rfc8314#section-7.3">The IETF issued a one-time amendment to reinstate port 465 for message submission over TLS protocol - RFC 8314 - Use of TLS for Email Submission/Access - January 2018</a></p>
<blockquote>
  <p>This is a one-time procedural exception to the rules in [RFC6335].
This requires explicit IESG approval and does not set a precedent.
Note: Since the purpose of this alternate usage assignment is to
align with widespread existing practice and there is no known usage
of UDP port 465 for Message Submission over TLS, IANA has not
assigned an alternate usage of UDP port 465.</p>

  <p>Historically, port 465 was briefly registered as the “smtps” port.
This registration made no sense, as the SMTP transport MX
infrastructure has no way to specify a port, so port 25 is always
used.  As a result, the registration was revoked and was subsequently
reassigned to a different service.  In hindsight, the “smtps”
registration should have been renamed or reserved rather than
revoked.  Unfortunately, some widely deployed mail software
interpreted “smtps” as “submissions” [RFC6409] and used that port for
email submission by default when an end user requested security
during account setup.  If a new port is assigned for the submissions
service, either (a) email software will continue with unregistered
use of port 465 (leaving the port registry inaccurate relative to
de facto practice and wasting a well-known port) or (b) confusion
between the de facto and registered ports will cause harmful
interoperability problems that will deter the use of TLS for Message
Submission.  The authors of this document believe that both of these
outcomes are less desirable than a “wart” in the registry documenting
real-world usage of a port for two purposes.  Although STARTTLS on
port 587 has been deployed, it has not replaced the deployed use of
Implicit TLS submission on port 465.</p>
</blockquote>

<p><a href="https://qmail.jms1.net/tls-auth.shtml">Issues with SSL/TLS and AUTH</a></p>

<p><a href="https://aput.net/~jheiss/sendmail/tlsandrelay.shtml">Configuring Sendmail’s STARTTLS (SSL) and Relaying</a></p>
<blockquote>
  <p>This page documents how to compile and configure Sendmail to support
STARTTLS.  STARTTLS is the SMTP command to “Start Transport Layer
Security”; or, in other words, to turn on SSL.</p>

  <p>Using SSL with SMTP isn’t terribly useful for protecting the contents
of messages.  Email generally goes through multiple hops between the
sender and the recipient and the sender has no way to ensure they every
one of those hops will use SSL.</p>

  <p>However, it it very useful when authenticating senders.  You can either
use SSL to protect a plain text login (SMTP AUTH), or use SSL
certificates to do authentication directly.  SMTP authentication is
useful for allowing remote users to relay mail through the external
company mail server.  Claus Aßmann has some documentation but I found
it a bit hard to follow so hopefully this is a little clearer.</p>
</blockquote>

<p><a href="https://docs.iredmail.org/enable.smtps.html">Enable SMTPS service (SMTP over SSL, port 465)</a></p>

<p><a href="https://www.rfc-editor.org/rfc/rfc3207">SMTP Service Extension for Secure SMTP over Transport Layer Security (TLS) - Explicit TLS (implemented with an extension called STARTTLS Command ) - RFC3207</a></p>
<blockquote>
  <p>A publicly-referenced SMTP server MUST NOT require use of the
STARTTLS extension in order to deliver mail locally.  This rule
prevents the STARTTLS extension from damaging the interoperability of
the Internet’s SMTP infrastructure.  <br />
A publicly-referenced SMTP server is an SMTP server which runs on 
port 25 of an Internet host listed in the MX record (or A record if an
MX record is not present) for the domain name on the right hand side of
an Internet mail address.</p>
</blockquote>

<p><a href="https://cromwell-intl.com/open-source/sendmail-ssl.html">Configure Sendmail for SMTP over TLS</a></p>

<p><a href="https://cromwell-intl.com/cybersecurity/ssl-tls.html">SSL/TLS Background</a></p>

<p><a href="https://devcoops.com/telnet-must-issue-starttls-command-first/">How to fix Telnet SMTP ‘must issue STARTTLS command first’ error</a></p>

<p><a href="https://qmail.jms1.net/test-auth.shtml">Testing SMTP AUTH connections</a></p>

<p><a href="http://scratching.psybermonkey.net/2011/01/freebsd-how-to-make-changes-to-sendmail.html">FreeBSD - How to make changes to sendmail, FreeBSD styled</a></p>

<p><a href="https://www.akadia.com/services/sendmail_tips.html">Sendmail Guide and Sendmail Tips</a></p>

<p><a href="https://www.akadia.com/download/documents/sendmail_survival.pdf">Sendmail Survival Guide</a></p>

<p><a href="https://rimuhosting.com/support/settingupemail.jsp">Setting Up Email: A Sendmail HOWTO</a></p>

<p><a href="https://www.akadia.com/services/sendmail_relay.html">How to setup an E-Mail Relay Host with Sendmail?</a></p>

<p><a href="https://raysnotebook.info/computing/email-outgoing.html">Outgoing Email - MTAs in Fedora</a></p>

<p><a href="http://www.harker.com/sendmail/index.html">Sendmail Tips and Tricks</a></p>

<p><a href="https://wiki.archlinux.org/title/sendmail">Sendmail - ArchLinux Wiki</a></p>

<p><a href="https://wiki.zimbra.com/wiki/Simple_Troubleshooting_For_SMTP_Via_Telnet_And_Openssl">Simple Troubleshooting For SMTP Via Telnet And Openssl</a></p>

<p><a href="https://halon.io/blog/how-to-test-smtp-servers-using-the-command-line">How to test SMTP servers using the command-line</a></p>

<p><a href="https://community.letsencrypt.org/t/tutorial-testing-mail-protocols-with-ssl-tls/43211/9">Tutorial - Testing Mail Protocols with SSL/TLS - Let’s Encrypt</a></p>

<p><a href="http://www.elandsys.com/resources/sendmail/">Installing and Configuring Sendmail</a></p>

<p><a href="http://billauer.co.il/blog/2019/03/smtp-helo-ehlo-mail-from/">SMTP tidbits for the to-be postmaster</a></p>

<p><a href="https://wiki.xdroop.com/space/sendmail">Virtual Dave - Wiki - sendmail section</a></p>

<p><a href="http://www.linuxweblog.com/blog-tags/linux/sendmail">Sendmail tips and debugging</a></p>

<p><a href="http://novosial.org/sendmail/client/index.html">Sendmail client configuration</a></p>

<p><a href="http://hiredavidbank.com/sendmail.mc">Sample sendmail.mc configuration file</a></p>

<p><a href="http://hiredavidbank.com/prac-send.html">Practical Modern sendmail Configuration</a></p>

<p><a href="http://hiredavidbank.com/AntiSPAM.html">Defense In Depth: Anti-SPAM for sendmail Environments</a></p>

<p><a href="http://hiredavidbank.com/DavidBank-TechnicalWritingSample.pdf">Mail Relay Server Operations Guide [PDF]</a></p>
<blockquote>
  <p>“An operations guide for a Linux-based mail relay server.  This is 
a version of the original document, redacted to maintain the security of
the original environment.”</p>
</blockquote>

<p><a href="http://www.puresimplicity.net/~hemi/freebsd/ports-sendmail.html">Switching to Ports-installed sendmail in FreeBSD</a></p>

<p><a href="https://weldon.whipple.org/sendmail/freebsdsendmailfaqs.html">FreeBSD sendmail Frequently Asked Questions</a></p>

<p><a href="http://www.puresimplicity.net/~hemi/freebsd/sendmail.html">FreeBSD as a Secure Mail Server Using sendmail and imap-uw</a></p>

<p><a href="http://www.puresimplicity.net/~hemi/freebsd/procmail.html">Installing and Using procmail as the LDA for sendmail under FreeBSD</a></p>

<p><a href="https://gist.github.com/drmalex07/d63348dc9d26d1349309">Configure sendmail</a></p>

<p><a href="https://rtcamp.com/tutorials/mail/server/testing/smtp/">SMTP Tests</a></p>

<p><a href="https://www.stevenrombauts.be/2018/12/test-smtp-with-telnet-or-openssl/">Test SMTP with telnet or openssl</a></p>

<p><a href="https://www.sendmail.org/~ca/email/chk-dbg.html">Debugging check_* in sendmail 8.8/8.9 and later</a></p>

<hr />

<ul>
  <li><a href="https://www.giac.org/paper/gsec/2496/secure-sendmail-based-dmz-corporate-email-environment/104359">A Secure Sendmail Based DMZ for the Corporate Email Environment</a></li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>FEATURE(`delay_checks')dnl
The "delay_checks" feature is useful when used in combination with the "dnsbl"
feature for SPAM control.  Without enabling this feature, the log entry for the
rejected email will not contain the destination users mail address.  Having the
destination address is very useful when troubleshooting; typically the person
calling your organizations support center is the person whom cannot receive the
email.  This feature will put the destination users address into the reject log
message allowing you to search the log for it directly.  In the other case, the
external entity can be asked whom they were trying to send to.  Otherwise, you
are stuck looking for origin SMTP servers, not a straight forward as it might
seem.  For example, the sender works for company abc.com but is sending you
email from their home cable modem.
</code></pre></div></div>

<ul>
  <li><a href="https://deer-run.com/users/hal/dns-sendmail/Demystifying-Sendmail.pdf">Demystifying Sendmail - Hal Pomeranz, Deer Run Associates</a></li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>In addition to the "access_db" declaration, however, you also want to add the
"delay_checks" feature.  Normally, the access DB and other anti-spam checks would
be consulted as soon as the remote server issues the "mail from:" command to set the
message sender.  The "delay_checks" feature tells Sendmail to wait until both the
sender and recipient addresses have been sent before deciding whether or not the message
is spam.  This is how you make sure that your "abuse@sysiphus.com" address
receives an unfiltered email stream while protecting all of your other users from spam.
</code></pre></div></div>

<ul>
  <li><a href="https://unix.stackexchange.com/questions/230575/sendmail-issues-530-authentication-required-error-message-when-authinfo-is-sup">Sendmail issues “530 Authentication required” error message when authinfo is supplied</a>:</li>
</ul>

<blockquote>
  <p>As root [on your mail server] send a test message with tracking
map (authinfo) lookups</p>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#!/bin/sh
# -d60.5 turn on traking map lookups
/usr/sbin/sendmail -d60.5 -v -i -fsender_email -- receiver_email  &lt;&lt;END
subject: test

test
END
</code></pre></div></div>

<ul>
  <li>
    <p><a href="https://www.linuxquestions.org/questions/linux-server-73/sendmail-allow-authenticated-sender-with-dnsbl-698305/">sendmail allow authenticated sender with dnsbl</a></p>
  </li>
  <li>
    <p><a href="https://www.linuxquestions.org/questions/linux-server-73/sendmail-dnsbl-blocking-authenticating-users-786503/">Sendmail DNSBL blocking authenticating users</a></p>
  </li>
  <li>
    <p><a href="http://answers.google.com/answers/threadview?id=398644">Subject: Re: Logging of sendmail authenticated user</a></p>
  </li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Sendmail.mc file approach:

Add the following definition to /etc/mail/sendmail.mc

define(`confLOG_LEVEL', `14')dnl

Rebuild /etc/mail/sendmail.cf

m4 sendmail.mc &gt; sendmail.cf

Sendmail.cf file approach:

Change the following definition in /etc/mail/sendmail.cf

O LogLevel=14

After you have changed the logging level, restart the sendmail daemon.
 Syslog will now log any successful authentications to
/var/log/maillog.  Of interest to you are the following fields in each
authentication log entry:

authid= and relay=

authid will display the login that was used for the authentication,
and relay will display the remote IP address that was added as the
temporary relay.  If you don't recognize the relay, then it is most
likely the spammer entry.
</code></pre></div></div>

<ul>
  <li><a href="https://superuser.com/questions/286677/creating-a-multipart-email-and-sending-it-in-linux">Creating a multipart email and sending it in Linux</a></li>
</ul>

<blockquote>
  <p>Create a message of type multipart/alternative as documented in 
<a href="https://www.rfc-editor.org/rfc/rfc2046#section-5.1.4">RFC 2046</a>:</p>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>From: Example Company &lt;news@example.com&gt;
To: Joe User &lt;joe.u@example.net&gt;
Date: Sat, 21 May 2011 17:40:11 +0300
Subject: Multipart message example
MIME-Version: 1.0
Content-Type: multipart/alternative; boundary=asdfghjkl

--asdfghjkl
Content-Type: text/plain; charset=utf-8

Hello everyone!

--asdfghjkl
Content-Type: text/html; charset=utf-8

&lt;!DOCTYPE html&gt;
&lt;body&gt;
&lt;p&gt;Hello everyone!&lt;/p&gt;
&lt;/body&gt;

--asdfghjkl--
</code></pre></div></div>

<blockquote>
  <p>See <a href="https://www.rfc-editor.org/rfc/rfc2046">RFC 2046</a> and 
<a href="https://www.rfc-editor.org/rfc/rfc5322">RFC 5322</a> for the exact syntax.</p>
</blockquote>

<ul>
  <li><a href="http://novosial.org/openssl/tls-name/index.html">SSL versus TLS versus STARTTLS</a></li>
</ul>

<blockquote>
  <p>The following example shows how a SMTP client negotiates an encrypted 
connection with STARTTLS.  First, the Mail Exchange (MX) for the domain 
(example.org) must be looked up, then the smtp port on the MX at 
smtp.example.org connected to.  Then the SMTP verbs EHLO and STARTTLS are 
used to begin negotiating an encrypted dialog.</p>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ host -t mx example.org
example.org mail is handled by 10 smtp.example.org.

$ telnet smtp.example.org 25
Trying 192.0.2.1...
Connected to smtp.example.org.
Escape character is '^]'.
220 smtp.example.org ESMTP Sendmail 8.13.2/8.13.2
EHLO client.example.org
250-smtp.example.org Hello client.example.org [192.0.2.7], pleased to meet you
250-ENHANCEDSTATUSCODES
250-PIPELINING
250-8BITMIME
250-SIZE 16180340
250-DSN
250-STARTTLS
250-DELIVERBY
250 HELP
STARTTLS
220 2.0.0 Ready to start TLS
...
</code></pre></div></div>

<blockquote>
  <p>The <a href="https://www.openssl.org/">OpenSSL</a> library ships with the <code class="language-plaintext highlighter-rouge">openssl</code> 
utility, which has a <code class="language-plaintext highlighter-rouge">s_client</code> mode to test encrypted connections. 
More recent versions of the <code class="language-plaintext highlighter-rouge">openssl</code> utility support STARTTLS for 
protocols such as <code class="language-plaintext highlighter-rouge">smtp</code> and <code class="language-plaintext highlighter-rouge">pop3</code>.  The <code class="language-plaintext highlighter-rouge">openssl</code> invocations below 
show how to connect via https to www.example.org and pop3 with STARTTLS 
to mail.example.org.  Once connected, the protocol in question can then be used.</p>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ openssl s_client -connect www.example.org:443 -showcerts
...
GET / HTTP/1.0

HTTP/1.1 200 OK
...
$ openssl s_client -connect mail.example.org:110 -showcerts -starttls pop3
... 
+OK POP3 mail.example.org v2003.83 server ready
quit
+OK Sayonara
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ openssl s_client -verify 2 -quiet -connect mx.youremailprovider.com:465
---- snip ----
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ openssl s_client -verify 2 -quiet -connect mx.youremailprovider.com:465 2&gt;/dev/null || exit 75
---- snip ----
</code></pre></div></div>

<ul>
  <li>
    <p><a href="https://workaround.org/ispmail/stretch/relaying-smtp-authentication">Relaying with SMTP authentication</a></p>
  </li>
  <li>
    <p><a href="https://dr0.ch/docs/linux-guide-10ed.pdf">Linux Guide</a></p>
  </li>
  <li>
    <p><a href="http://www.ifost.org.au/Documents/sendmail.pdf">Sendmail - The Institute for Open Systems Technologies, Release 2.0, 22nd March 2004</a></p>
  </li>
  <li>
    <p><a href="https://ameblo-jp.translate.goog/ypsilondelta/entry-12628745736.html?_x_tr_sl=ja&amp;_x_tr_tl=en&amp;_x_tr_hl=en&amp;_x_tr_pto=sc">SMART_HOST in FreeBSD12R default sendmail</a></p>
  </li>
  <li>
    <p><a href="https://nasa.cs.nycu.edu.tw/nm/2005/slide/SendMail.pdf">Sendmail Presentation - NCTU CSCC/NYMCTU, Computer Network Management Course (2005 syllabus)</a></p>
  </li>
  <li>
    <p><a href="https://people.cs.nctu.edu.tw/~chwong/course/netadm-2007/slide/07_SendMail.pdf">Sendmail Presentation - Computer Center CS NCTU/NYMCTU</a></p>
  </li>
</ul>

<h2 id="bypass-filtering-for-authenitcated-users">Bypass Filtering for Authenitcated Users</h2>

<ul>
  <li><a href="http://web.archive.org/web/20220930003249/https://fam.tuwien.ac.at/~schamane/_/oldblog/141118_suppress_ip_of_authenticated_senders_in_sendmail.html">Suppress IP of authenticated senders in Sendmail</a></li>
</ul>

<blockquote>
  <p>So, in /etc/mail/sendmail.mc I added:</p>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dnl # suppress IP of authenticated sender
define(`confRECEIVED_HEADER',`$?{auth_type}from auth (localhost [127.0.0.1]) $|_REC_HDR_$.
	_REC_BY_
	_REC_TLS_
	_REC_END_')
</code></pre></div></div>

<p>Note: The leading spaces are actually 1 TAB!</p>

<p>From
<a href="https://www.joelw.id.au/GeneralNotes">General Notes - Joel’s Compendium of Total Knowledge</a>:</p>
<blockquote>
  <p>With sendmail, obscure Received: headers when relaying</p>

  <p>I noticed that an email I had sent someone was marked as spam because 
my dynamic IP address was on some blacklist.  I use my own authenticated 
SMTP relay, so there’s really no reason I’d want people to know my 
IP address.  After some fiddling I came up with the following macro, 
which you may add to your sendmail.mc:</p>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>define(`confRECEIVED_HEADER', `$?{auth_type}(from $j) by $j ($v/$Z)$|$?sfrom $s $.$?_($?s$|from $.$_)
$.$?{auth_type}(authenticated$?{auth_ssf} bits=${auth_ssf}$.)
$.by $j ($v/$Z)$?r with $r$. id $i$?{tls_version}
(version=${tls_version} cipher=${cipher} bits=${cipher_bits} verify=${verify})$.$?u
for $u; $|;
$.$b$.')dnl
</code></pre></div></div>

<blockquote>
  <p>This looks horrible, but it’s a fairly simple modification of the default rule.
<code class="language-plaintext highlighter-rouge">sendmail.cf</code> uses <code class="language-plaintext highlighter-rouge">$?{variable} $| $.</code> as <code class="language-plaintext highlighter-rouge">if</code>, <code class="language-plaintext highlighter-rouge">else</code>, and <code class="language-plaintext highlighter-rouge">end if</code> operators respectively.
So here, if <code class="language-plaintext highlighter-rouge">auth_type</code> is defined (which <strong>only</strong> occurs if an <strong>authenticated user</strong> is <em>relaying</em> through the server, which will only be <em>local users</em>), then show a simple “(from hostname) by hostname (8.14.3/8.14.3/Debian-9.2)”, which is based on some other non-descript headers I managed to generate by invoking sendmail on the server from mutt.
Otherwise, it proceeds with the default rule (<code class="language-plaintext highlighter-rouge">from $?sfrom $s ...</code>).</p>
</blockquote>

<p>Also, the same page (<a href="http://web.archive.org/web/20220930003249/https://fam.tuwien.ac.at/~schamane/_/oldblog/141118_suppress_ip_of_authenticated_senders_in_sendmail.html">Suppress IP of authenticated senders in Sendmail</a>) points to the following post as an inspiration:
<a href="https://archive.ph/w7LRF">Removing Sender’s IP Address From Email’s Received: From Header</a></p>

<blockquote>
  <p>Anyway, what I did find was, for instance, <a href="https://archive.ph/w7LRF">Removing Sender’s IP Address From Email’s Received: From Header</a>.
This page popped up frequently when I searched for how to suppress headers, and it seems to be one of very few indeed.
It even addresses my main problem.
The author’s approach is totally valid, and s/he explains things well and gives pointers.
However, I did not feel comfortable with completely removing the “from” part, and with redefining <code class="language-plaintext highlighter-rouge">confRECEIVED_HEADER</code> without honoring the defaults.
I was also afraid that this might even break some other things (like our own spam filter rules).</p>

  <p>Another solution that I could find about 2 times goes 1 big step furhter:
It suggested to remove the <code class="language-plaintext highlighter-rouge">HReceived</code> line(s) from <code class="language-plaintext highlighter-rouge">submit.cf</code> altogether.
This does work, and it does make some sense for <code class="language-plaintext highlighter-rouge">submit.cf</code>, however, <strong>only</strong> if 2 <em>sendmail</em> daemons are used where 1 is running with the <code class="language-plaintext highlighter-rouge">submit.cf</code> and listens to <em>port 587</em>.
But, my server is a Debian box with <em>only 1 daemon</em>, and I thought there should be no need for a 2nd.</p>

  <p><code class="language-plaintext highlighter-rouge">$?{auth_type}$|...$.</code></p>

  <p><a href="http://web.archive.org/web/20221102231352/https://joelw.id.au/GeneralNotes">Joel’s Compendium of Total Knowledge</a> (search for <code class="language-plaintext highlighter-rouge">Received:</code>) is the only page I found that suggests what I thought was reasonable, i.e. introduce an <strong>if-then</strong> <code class="language-plaintext highlighter-rouge">($?…$|…$.)</code> evaluating the <em>variable</em> <code class="language-plaintext highlighter-rouge">{auth_type}</code> to check whether the client has been <em>authenticated</em>:</p>

  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>define(`confRECEIVED_HEADER', `$?{auth_type}...
</code></pre></div>  </div>

  <p>[ . . . ]</p>

  <p><strong>Discussion</strong></p>

  <p>Andreas Schamanek, 2014-11-18 22:46</p>

  <p>By means of this approach we are suppressing an IP that might indeed be abused by the authenticated client.
However, I don’t think that this is of any concern.
In such cases, the relaying mail server will be blacklisted anyway.
I’ll get notified, and I’ll be able to stop the abuse.
Besides, I have hourly and daily limits set for outgoing mail.</p>
</blockquote>

<h2 id="with-sendmail-and-spamass-milter-dont-check-outgoing-messages">With sendmail and spamass-milter, Don’t Check Outgoing Messages</h2>

<p>From
<a href="https://www.joelw.id.au/GeneralNotes">General Notes - Joel’s Compendium of Total Knowledge</a>:</p>
<blockquote>
  <p>Now that I’ve set up a secure mail relay, I can happily send mail from all manner of 3G and wireless connections.
All of them are listed in RBLs, which makes me angry because SpamAssassin on my mail relay is marking my own messages as spam.
Fortunately, Debian/Ubuntu’s version of spamass-milter has a <code class="language-plaintext highlighter-rouge">-I</code> option that <strong>skips checks for authenticated users</strong>.
This seems to work even with my dodgy hack above.</p>
</blockquote>

<hr />

<p><a href="https://www.proofpoint.com/us/threat-reference/sendmail">What is Sendmail? - Proofpoint</a></p>

<p><a href="https://www.computerhope.com/unix/usendmai.htm">Test and Use Sendmail from the Command Line - Sendmail Command Help and Examples</a></p>

<hr />

<h2 id="documentation-readme-faq-help-and-other-files-distributed-with-sendmail-on-freebsd-13">Documentation, README, FAQ, Help and Other Files Distributed with Sendmail On FreeBSD 13</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ diff /usr/src/contrib/sendmail/cf/README /usr/local/share/sendmail/cf/README | wc -l
     106
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ wc -l /usr/src/contrib/sendmail/src/README /usr/local/share/sendmail/cf/README 
    1869 /usr/src/contrib/sendmail/src/README
    4831 /usr/local/share/sendmail/cf/README
    6700 total
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ls -lh /usr/src/contrib/sendmail/src/ | grep -v '\.c' | grep -v '\.h'
total 1332
-rw-r--r--  1 root  wheel   1.4K Oct 21 17:58 aliases
-rw-r--r--  1 root  wheel   3.1K Oct 21 17:58 aliases.5
-rw-r--r--  1 root  wheel   5.5K Oct 21 17:58 helpfile
-rw-r--r--  1 root  wheel   3.5K Oct 21 17:58 mailq.1
-rw-r--r--  1 root  wheel   347B Oct 21 17:58 Makefile
-rw-r--r--  1 root  wheel   4.4K Oct 21 17:58 Makefile.m4
-rw-r--r--  1 root  wheel   1.3K Oct 21 17:58 newaliases.1
-rw-r--r--  1 root  wheel    82K Oct 21 17:58 README
-rw-r--r--  1 root  wheel   7.5K Oct 21 17:58 SECURITY
-rw-r--r--  1 root  wheel    17K Oct 21 17:58 sendmail.8
-rw-r--r--  1 root  wheel   3.1K Oct 21 17:58 TRACEFLAGS
-rw-r--r--  1 root  wheel    10K Oct 21 17:58 TUNING
</code></pre></div></div>

<p>Possible mailers are listed in this directory:<br />
<code class="language-plaintext highlighter-rouge">/usr/local/share/sendmail/cf/mailer/</code></p>

<p>and (if you’ve obtained <em>sendmail</em> source):</p>

<p><code class="language-plaintext highlighter-rouge">/usr/src/contrib/sendmail/cf/mailer/</code></p>

<p>Patches and 
some useful <em>sendmail</em> tools (e.g. <code class="language-plaintext highlighter-rouge">movemail.pl</code>, <code class="language-plaintext highlighter-rouge">qtool.pl</code>, 
<code class="language-plaintext highlighter-rouge">re-mqueue.pl</code>) are located here: <br />
<code class="language-plaintext highlighter-rouge">/usr/src/contrib/sendmail/contrib/</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ cat /usr/src/contrib/sendmail/FAQ
The FAQ is no longer maintained with the sendmail release.  It is
available at http://www.sendmail.org/faq/ .

$Revision: 8.25 $, Last updated $Date: 2014-01-27 12:49:52 $
</code></pre></div></div>

<p>As of Oct 22, 2022, the Sendmail <strong>FAQ</strong> is at<br />
<a href="https://www.proofpoint.com/us/sendmail/faq">https://www.proofpoint.com/us/sendmail/faq</a></p>

<p>On FreeBSD 13.1-RELEASE-p2, as of Oct 22, 2022, the package-provided
<em>sendmail</em> version is 8.17.1:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ /usr/local/sbin/sendmail -d0.1 &lt; /dev/null | head -1
Version 8.17.1
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ pkg search --regex ^sendmail-
sendmail-8.17.1_6              Reliable, highly configurable mail 
  transfer agent with utilities
sendmail-devel-8.17.1.22       Reliable, highly configurable mail
  transfer agent with utilities
</code></pre></div></div>

<p>while <em>sendmail</em> shipped with FreeBSD 13 is V8.16.1:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ /usr/libexec/sendmail/sendmail -d0.1 &lt; /dev/null | head -1
Version 8.16.1
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ cat /usr/src/contrib/sendmail/FREEBSD-upgrade
$FreeBSD$

sendmail 8.16.1
        originals can be found at: ftp://ftp.sendmail.org/pub/sendmail/

For the import of sendmail, the following directories were renamed:

        sendmail -&gt; src

Imported using the instructions at:

http://www.freebsd.org/doc/en_US.ISO8859-1/articles/committers-guide/subversion-primer.html

Then merged using:

% set FSVN=svn+ssh://repo.freebsd.org/base
% svn checkout $FSVN/head/contrib/sendmail head
% cd head
### Replace XXXXXX with import revision number in next command:
% svn merge -c rXXXXXX --accept=postpone '^/vendor/sendmail/dist' .
% svn resolve --accept working cf/cf/Build \
    cf/cf/generic-{bsd4.4,hpux{9,10},linux,mpeix,nextstep3.3,osf1,solaris,sunos4.1,ultrix4}.cf \
    devtools doc/op/op.ps editmap/editmap.0 mail.local/mail.local.0 mailstats/mailstats.0 \
    makemap/makemap.0 praliases/praliases.0 rmail/rmail.0 smrsh/smrsh.0 \
    src/{aliases,mailq,newaliases,sendmail}.0 vacation/vacation.0
% svn propset -R svn:keywords FreeBSD=%H .
% svn propdel svn:keywords libmilter/docs/*.jpg
% svn diff --no-diff-deleted --old=$FSVN/vendor/sendmail/dist --new=.
% svn status
% svn diff
% svn commit

After importing, bump the version of src/etc/sendmail/freebsd*mc
so mergemaster will merge /etc/mail/freebsd*cf by making a minor
change and committing.

To make local changes to sendmail, simply patch and commit to the head.
Never make local changes in the vendor area (/vendor/sendmail/).

All local changes should be submitted to the Sendmail Consortium
&lt;sendmail@sendmail.org&gt; for inclusion in the next vendor release.

The following files make up the sendmail build/install/runtime
infrastructure in FreeBSD:

        Makefile.inc1
        bin/Makefile
        bin/rmail/Makefile
        contrib/sendmail/
        etc/Makefile
        etc/defaults/make.conf (obsolete)
        etc/defaults/periodic.conf
        etc/defaults/rc.conf
        etc/mail/Makefile
        etc/mail/README
        etc/mail/access.sample
        etc/mail/aliases
        etc/mail/mailer.conf
        etc/mail/mailertable.sample
        etc/mail/virtusertable.sample
        etc/mtree/BSD.include.dist
        etc/mtree/BSD.sendmail.dist
        etc/mtree/BSD.usr.dist
        etc/mtree/BSD.var.dist
        etc/periodic/daily/440.status-mailq
        etc/periodic/daily/500.queuerun
        etc/rc
        etc/rc.sendmail
        etc/sendmail/Makefile
        etc/sendmail/freebsd.mc
        etc/sendmail/freebsd.submit.mc
        etc/sendmail/freefall.mc
        lib/Makefile
        lib/libmilter/Makefile
        lib/libsm/Makefile
        lib/libsmdb/Makefile
        lib/libsmutil/Makefile
        libexec/Makefile
        libexec/mail.local/Makefile
        libexec/smrsh/Makefile
        share/Makefile
        share/doc/smm/Makefile
        share/doc/smm/08.sendmailop/Makefile
        share/examples/etc/make.conf
        share/man/man5/make.conf.5
        share/man/man5/periodic.conf.5
        share/man/man5/rc.conf.5
        share/man/man7/hier.7
        share/man/man8/Makefile
        share/man/man8/rc.sendmail.8
        share/mk/bsd.libnames.mk
        share/sendmail/Makefile
        tools/build/mk/OptionalObsoleteFiles.inc
        usr.bin/Makefile
        usr.bin/vacation/Makefile
        usr.sbin/Makefile
        usr.sbin/editmap/Makefile
        usr.sbin/mailstats/Makefile
        usr.sbin/makemap/Makefile
        usr.sbin/praliases/Makefile
        usr.sbin/sendmail/Makefile
        usr.sbin/mailwrapper/Makefile

gshapiro@FreeBSD.org
15-July-2020
</code></pre></div></div>

<p>These files are located relative to <code class="language-plaintext highlighter-rouge">/usr/src/</code> directory; for example,
<code class="language-plaintext highlighter-rouge">libexec/smrsh/Makefile</code> is at <code class="language-plaintext highlighter-rouge">/usr/src/libexec/smrsh/Makefile</code>.</p>

<h3 id="sendmail-related-manual-pages-in-freebsd-13">Sendmail Related Manual Pages in FreeBSD 13</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% man -k sendmail | wc -l
      11
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% man -k sendmail
aliases(5) - aliases file for sendmail
aliases(5) - aliases file for sendmail
editmap(8) - query and edit single records in database maps for sendmail
editmap(8) - query and edit single records in database maps for sendmail
makemap(8) - create database maps for sendmail
makemap(8) - create database maps for sendmail
rc.sendmail(8) - sendmail 8 startup script
sendmail(8) - an electronic mail transport agent
sendmail, hoststat, purgestat(8) - an electronic mail transport agent
smrsh(8) - restricted shell for sendmail
smrsh(8) - restricted shell for sendmail
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% manpath
/usr/share/man:/usr/local/share/man:/usr/local/man:/usr/share/openssl/man:/usr/local/lib/perl5/site_perl/man:/usr/local/lib/perl5/5.32/perl/man
</code></pre></div></div>

<h2 id="sendmail-default-variables-in-etcdefaultsrcconf">Sendmail Default Variables in /etc/defaults/rc.conf</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% head -20 /etc/defaults/rc.conf
#!/bin/sh

# This is rc.conf - a file full of useful variables that you can set
# to change the default startup behavior of your system.  You should
# not edit this file!  Put any overrides into one of the ${rc_conf_files}
# instead and you will be able to update these defaults later without
# spamming your local configuration information.
#
# The ${rc_conf_files} files should only contain values which override
# values set in this file.  This eases the upgrade path when defaults
# are changed and new features are added.
#
# All arguments must be in double or single quotes.
#
# For a more detailed explanation of all the rc.conf variables, please
# refer to the rc.conf(5) manual page.
#
# $FreeBSD$

##############################################################
</code></pre></div></div>

<p>Also, from the man page for <code class="language-plaintext highlighter-rouge">rc.conf(5)</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rc_conf_files
            (str) This option is used to specify a list of files that
            will override the settings in /etc/defaults/rc.conf.  The
            files will be read in the order in which they are specified
            and should include the full path to the file.  By default,
            the files specified are /etc/rc.conf and /etc/rc.conf.local
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% grep -n sendmail /etc/defaults/rc.conf | wc -l
      16
 
% grep -n -i sendmail /etc/defaults/rc.conf | wc -l
      16
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% grep sendmail /etc/defaults/rc.conf
mta_start_script="/etc/rc.sendmail"
# Settings for /etc/rc.sendmail and /etc/rc.d/sendmail:
sendmail_enable="NO"    # Run the sendmail inbound daemon (YES/NO).
sendmail_pidfile="/var/run/sendmail.pid"        # sendmail pid file
sendmail_procname="/usr/sbin/sendmail"          # sendmail process name
sendmail_flags="-L sm-mta -bd -q30m" # Flags to sendmail (as a server)
sendmail_cert_create="YES"      # Create a server certificate if none (YES/NO)
#sendmail_cert_cn="CN"          # CN of the generate certificate
sendmail_submit_enable="YES"    # Start a localhost-only MTA for mail submission
sendmail_submit_flags="-L sm-mta -bd -q30m -ODaemonPortOptions=Addr=localhost"
sendmail_outbound_enable="YES"  # Dequeue stuck mail (YES/NO).
sendmail_outbound_flags="-L sm-queue -q30m" # Flags to sendmail (outbound only)
sendmail_msp_queue_enable="YES" # Dequeue stuck clientmqueue mail (YES/NO).
sendmail_msp_queue_flags="-L sm-msp-queue -Ac -q30m"
                                # Flags for sendmail_msp_queue daemon.
sendmail_rebuild_aliases="NO"   # Run newaliases if necessary (YES/NO).
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% grep sendmail /etc/defaults/rc.conf | grep flags
sendmail_flags="-L sm-mta -bd -q30m" # Flags to sendmail (as a server)
sendmail_submit_flags="-L sm-mta -bd -q30m -ODaemonPortOptions=Addr=localhost"
sendmail_outbound_flags="-L sm-queue -q30m" # Flags to sendmail (outbound only)
sendmail_msp_queue_flags="-L sm-msp-queue -Ac -q30m"
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% grep sendmail /etc/defaults/rc.conf | grep submit
sendmail_submit_enable="YES"    # Start a localhost-only MTA for mail submission
sendmail_submit_flags="-L sm-mta -bd -q30m -ODaemonPortOptions=Addr=localhost"
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% grep sendmail /etc/defaults/rc.conf | grep msp
sendmail_msp_queue_enable="YES" # Dequeue stuck clientmqueue mail (YES/NO).
sendmail_msp_queue_flags="-L sm-msp-queue -Ac -q30m"
                                # Flags for sendmail_msp_queue daemon.
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% sudo grep -r -w sendmail_submit /etc/
/etc/rc.d/sendmail:     name="sendmail_submit"
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% sudo grep -r sendmail_submit_flags /etc/
/etc/defaults/rc.conf:sendmail_submit_flags="-L sm-mta -bd -q30m -ODaemonPortOptions=Addr=localhost"
/etc/rc.sendmail:                       ${sendmail_program} ${sendmail_submit_flags}
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% sudo grep -r -w sendmail_submit_enable /etc/
/etc/rc.d/sendmail:     sendmail_submit_enable="NO"
/etc/rc.d/sendmail:     sendmail_submit_enable="NO"
/etc/rc.d/sendmail:# If sendmail_submit_enable=yes, don't need outbound daemon
/etc/rc.d/sendmail:if checkyesno sendmail_submit_enable; then
/etc/rc.d/sendmail:if checkyesno sendmail_submit_enable; then
/etc/rc.d/sendmail:     rcvar="sendmail_submit_enable"
/etc/mail/README:can be disabled using the sendmail_submit_enable rc.conf option.  However,
/etc/mail/README:if both sendmail_enable and sendmail_submit_enable are set to "NO", you
/etc/defaults/rc.conf:sendmail_submit_enable="YES"      # Start a localhost-only MTA for mail submission
/etc/rc.sendmail:               case ${sendmail_submit_enable} in
/etc/rc.sendmail:               case ${sendmail_submit_enable} in
/etc/rc.sendmail:               case ${sendmail_submit_enable} in
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% sudo grep -r -n mta_start_script /etc/
/etc/rc.d/othermta:15:if [ -n "${mta_start_script}" ]; then
/etc/rc.d/othermta:16:  [ "${mta_start_script}" != "/etc/rc.sendmail" ] &amp;&amp; \
/etc/rc.d/othermta:17:      sh ${mta_start_script} "$1"
/etc/defaults/rc.conf:592:mta_start_script="/etc/rc.sendmail"
/etc/rc.sendmail:34:# MTAs.  It is only called by /etc/rc if the rc.conf mta_start_script is
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% cat /etc/rc.d/othermta
#!/bin/sh
#
# $FreeBSD$
#

# PROVIDE: mail
# REQUIRE: LOGIN

# XXX - TEMPORARY SCRIPT UNTIL YOU WRITE YOUR OWN REPLACEMENT.
#
. /etc/rc.subr

load_rc_config

if [ -n "${mta_start_script}" ]; then
        [ "${mta_start_script}" != "/etc/rc.sendmail" ] &amp;&amp; \
            sh ${mta_start_script} "$1"
fi
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% ls -lh /etc/rc.sendmail
-rw-r--r--  1 root  wheel   5.6K Apr  8  2021 /etc/rc.sendmail
 
% file /etc/rc.sendmail
/etc/rc.sendmail: POSIX shell script, ASCII text executable
 
% wc -l /etc/rc.sendmail
     277 /etc/rc.sendmail
</code></pre></div></div>

<p><strong>NOTE:</strong> <br />
The <code class="language-plaintext highlighter-rouge">/etc/rc.sendmail</code> startup script is used at <strong>boot time</strong>: <br />
“This script is used by <code class="language-plaintext highlighter-rouge">/etc/rc</code> at <strong>boot time</strong> to start <em>sendmail</em>.”</p>

<p>In addition, this script is used by <strong><code class="language-plaintext highlighter-rouge">/etc/mail/Makefile</code></strong>:</p>

<p>“The script is also used by <code class="language-plaintext highlighter-rouge">/etc/mail/Makefile</code> to enable the
<strong>start/stop/restart</strong> targets.”</p>

<p>That is:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% cd /etc/mail
% sudo su
# make start    # (Or make stop, or make restart) 
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% cat /etc/rc.sendmail
#!/bin/sh

#
# Copyright (c) 2002  Gregory Neil Shapiro.  All Rights Reserved.
# Copyright (c) 2000, 2002  The FreeBSD Project

[ . . . ]

# This script is used by /etc/rc at boot time to start sendmail.  It
# is meant to be sendmail specific and not a generic script for all
# MTAs.  It is only called by /etc/rc if the rc.conf mta_start_script is
# set to /etc/rc.sendmail.  This provides the opportunity for other MTAs
# to provide their own startup script.

# The script is also used by /etc/mail/Makefile to enable the
# start/stop/restart targets.

# The source for the script can be found in src/etc/sendmail/rc.sendmail.
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% ls -lh /etc/rc.d/sendmail
-r-xr-xr-x  1 root  wheel   6.4K Apr  8  2021 /etc/rc.d/sendmail
 
% file /etc/rc.d/sendmail
/etc/rc.d/sendmail: POSIX shell script, ASCII text executable
 
% wc -l /etc/rc.d/sendmail
     229 /etc/rc.d/sendmail
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% cat /etc/rc.d/sendmail
#!/bin/sh
#
# $FreeBSD$
#

# PROVIDE: mail
# REQUIRE: LOGIN FILESYSTEMS
#       we make mail start late, so that things like .forward's are not
#       processed until the system is fully operational
# KEYWORD: shutdown

# XXX - Get together with sendmail mantainer to figure out how to
#       better handle SENDMAIL_ENABLE and 3rd party MTAs.
#
. /etc/rc.subr

name="sendmail"
desc="Electronic mail transport agent"
rcvar="sendmail_enable"
required_files="/etc/mail/${name}.cf"
start_precmd="sendmail_precmd"

load_rc_config $name
command=${sendmail_program:-/usr/sbin/${name}}
pidfile=${sendmail_pidfile:-/var/run/${name}.pid}
procname=${sendmail_procname:-/usr/sbin/${name}}

CERTDIR=/etc/mail/certs

case ${sendmail_enable} in
[Nn][Oo][Nn][Ee])
        sendmail_enable="NO"
        sendmail_submit_enable="NO"
        sendmail_outbound_enable="NO"
        sendmail_msp_queue_enable="NO"
        ;;
esac

# If sendmail_enable=yes, don't need submit or outbound daemon
if checkyesno sendmail_enable; then
        sendmail_submit_enable="NO"
        sendmail_outbound_enable="NO"
fi

# If sendmail_submit_enable=yes, don't need outbound daemon
if checkyesno sendmail_submit_enable; then
        sendmail_outbound_enable="NO"
fi

[ . . . ]

required_files=

if checkyesno sendmail_submit_enable; then
        name="sendmail_submit"
        rcvar="sendmail_submit_enable"
        _rc_restart_done=false
        run_rc_command "$1"
fi

if checkyesno sendmail_outbound_enable; then
        name="sendmail_outbound"
        rcvar="sendmail_outbound_enable"
        _rc_restart_done=false
        run_rc_command "$1"
fi

name="sendmail_msp_queue"
rcvar="sendmail_msp_queue_enable"
pidfile="${sendmail_msp_queue_pidfile:-/var/spool/clientmqueue/sm-client.pid}"
required_files="/etc/mail/submit.cf"
_rc_restart_done=false
run_rc_command "$1"
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% grep -n msp /etc/rc.d/sendmail
35:     sendmail_msp_queue_enable="NO"
224:name="sendmail_msp_queue"
225:rcvar="sendmail_msp_queue_enable"
226:pidfile="${sendmail_msp_queue_pidfile:-/var/spool/clientmqueue/sm-client.pid}"
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% grep -n -i queue /etc/rc.d/sendmail
35:     sendmail_msp_queue_enable="NO"
224:name="sendmail_msp_queue"
225:rcvar="sendmail_msp_queue_enable"
226:pidfile="${sendmail_msp_queue_pidfile:-/var/spool/clientmqueue/sm-client.pid}"
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% grep -n '\-L' /etc/rc.d/sendmail
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% grep -n msp /etc/rc.sendmail 
55:sendmail_mspq_pidfile=${sendmail_mspq_pidfile:-/var/spool/clientmqueue/sm-client.pid}
152:start_mspq()
159:                    case ${sendmail_msp_queue_enable} in
162:                            ${sendmail_program} ${sendmail_msp_queue_flags}
170:stop_mspq()
179:                    case ${sendmail_msp_queue_enable} in
190:    if [ -r ${sendmail_mspq_pidfile} ]; then
192:            kill -TERM `head -1 ${sendmail_mspq_pidfile}`
194:            echo "$0: stop-mspq: ${sendmail_mspq_pidfile} not found"
198:restart_mspq()
207:                    case ${sendmail_msp_queue_enable} in
218:    if [ -r ${sendmail_mspq_pidfile} ]; then
220:            kill -HUP `head -1 ${sendmail_mspq_pidfile}`
222:            echo "$0: restart-mspq: ${sendmail_mspq_pidfile} not found"
232:    start_mspq
237:    stop_mspq
242:    restart_mspq
257:start-mspq)
258:    start_mspq
261:stop-mspq)
262:    stop_mspq
265:restart-mspq)
266:    restart_mspq
272:    echo "       `basename $0` {start-mspq|stop-mspq|restart-mspq}" &gt;&amp;2
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% grep -n queue /etc/rc.sendmail 
55:sendmail_mspq_pidfile=${sendmail_mspq_pidfile:-/var/spool/clientmqueue/sm-client.pid}
159:                    case ${sendmail_msp_queue_enable} in
161:                            echo -n ' sendmail-clientmqueue'
162:                            ${sendmail_program} ${sendmail_msp_queue_flags}
172:    # Check to make sure we are configured to start an MSP queue runner
179:                    case ${sendmail_msp_queue_enable} in
191:            echo -n ' sendmail-clientmqueue'
200:    # Check to make sure we are configured to start an MSP queue runner
207:                    case ${sendmail_msp_queue_enable} in
219:            echo -n ' sendmail-clientmqueue'
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% grep -n '\-L' /etc/rc.sendmail 
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% sudo grep -r sendmail_outbound_enable /etc/
/etc/rc.d/sendmail:     sendmail_outbound_enable="NO"
/etc/rc.d/sendmail:     sendmail_outbound_enable="NO"
/etc/rc.d/sendmail:     sendmail_outbound_enable="NO"
/etc/rc.d/sendmail:if checkyesno sendmail_outbound_enable; then
/etc/rc.d/sendmail:     rcvar="sendmail_outbound_enable"
/etc/defaults/rc.conf:sendmail_outbound_enable="YES"    # Dequeue stuck mail (YES/NO).
/etc/rc.sendmail:                       case ${sendmail_outbound_enable} in
/etc/rc.sendmail:                       case ${sendmail_outbound_enable} in
/etc/rc.sendmail:                       case ${sendmail_outbound_enable} in
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% sudo grep -n sendmail_outbound_enable /etc/defaults/rc.conf 
604:sendmail_outbound_enable="YES"      # Dequeue stuck mail (YES/NO).
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% sudo grep -n sendmail_outbound /etc/defaults/rc.conf
604:sendmail_outbound_enable="YES"      # Dequeue stuck mail (YES/NO).
605:sendmail_outbound_flags="-L sm-queue -q30m" # Flags to sendmail (outbound only)
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% sudo grep -n sm /etc/defaults/rc.conf | grep queue
605:sendmail_outbound_flags="-L sm-queue -q30m" # Flags to sendmail (outbound only)
607:sendmail_msp_queue_flags="-L sm-msp-queue -Ac -q30m"
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% sudo grep -n msp /etc/defaults/rc.conf 
606:sendmail_msp_queue_enable="YES"     # Dequeue stuck clientmqueue mail (YES/NO).
607:sendmail_msp_queue_flags="-L sm-msp-queue -Ac -q30m"
608:                            # Flags for sendmail_msp_queue daemon.
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% sed -n 605,610p /etc/defaults/rc.conf
sendmail_outbound_flags="-L sm-queue -q30m" # Flags to sendmail (outbound only)
sendmail_msp_queue_enable="YES" # Dequeue stuck clientmqueue mail (YES/NO).
sendmail_msp_queue_flags="-L sm-msp-queue -Ac -q30m"
                                # Flags for sendmail_msp_queue daemon.
sendmail_rebuild_aliases="NO"   # Run newaliases if necessary (YES/NO).
 
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% grep -n '\-L' /etc/defaults/rc.conf
598:sendmail_flags="-L sm-mta -bd -q30m" # Flags to sendmail (as a server)
602:sendmail_submit_flags="-L sm-mta -bd -q30m -ODaemonPortOptions=Addr=localhost"
605:sendmail_outbound_flags="-L sm-queue -q30m" # Flags to sendmail (outbound only)
607:sendmail_msp_queue_flags="-L sm-msp-queue -Ac -q30m"
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% grep -n -i msp /etc/defaults/rc.conf
606:sendmail_msp_queue_enable="YES"     # Dequeue stuck clientmqueue mail (YES/NO).
607:sendmail_msp_queue_flags="-L sm-msp-queue -Ac -q30m"
608:                            # Flags for sendmail_msp_queue daemon.
</code></pre></div></div>

<h2 id="security-file-msp-message-submission-program-submitcf-file">SECURITY File: MSP (Message Submission Program), submit.cf File</h2>

<p>On FreeBSD 13:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sed -n 11,172p /usr/src/contrib/sendmail/src/SECURITY 
This file gives some hints how to configure and run sendmail for
people who are very security conscious (you should be...).

Even though sendmail goes through great lengths to assure that it
can't be compromised even if the system it is running on is
incorrectly or insecurely configured, it can't work around everything.
This has been demonstrated by recent OS problems which have
subsequently been used to compromise the root account using sendmail
as a vector.  One way to minimize the possibility of such problems
is to install sendmail without set-user-ID root, which avoids local
exploits.  This configuration, which is the default starting with
8.12, is described in the first section of this security guide.


*****************************************************
** sendmail configuration without set-user-ID root **
*****************************************************

sendmail needs to run as root for several purposes:

- bind to port 25
- call the local delivery agent (LDA) as root (or other user) if the LDA
  isn't set-user-ID root (unless some other method of storing e-mail in
  local mailboxes is used).
- read .forward files
- write e-mail submitted via the command line to the queue directory.

Only the last item requires a set-user-ID/set-group-ID program to
avoid problems with a world-writable directory.  It is however
sufficient to have a set-group-ID program and a group-writable
queue directory.  The other requirements listed above can be
fulfilled by a sendmail daemon that is started by root.  Hence this
section explains how to use two sendmail configurations to accomplish
the goal to have a sendmail binary that is not set-user-ID root,
and hence is not open to system configuration/OS problems or at
least less problematic in presence of those.

The default configuration starting with sendmail 8.12 uses one
sendmail binary which acts differently based on operation mode and
supplied options.

sendmail must be a set-group-ID (default group: smmsp, recommended
gid: 25) program to allow for queueing mail in a group-writable
directory.  Two .cf files are required:  sendmail.cf for the daemon
and submit.cf for the submission program.  The following permissions
should be used:

-r-xr-sr-x      root   smmsp    ... /PATH/TO/sendmail
drwxrwx---      smmsp  smmsp    ... /var/spool/clientmqueue
drwx------      root   wheel    ... /var/spool/mqueue
-r--r--r--      root   wheel    ... /etc/mail/sendmail.cf
-r--r--r--      root   wheel    ... /etc/mail/submit.cf

[Notice: On some OS "wheel" is not used but "bin" or "root" instead,
however, this is not important here.]

That is, the owner of sendmail is root, the group is smmsp, and
the binary is set-group-ID.  The client mail queue is owned by
smmsp with group smmsp and is group writable.  The client mail
queue directory must be writable by smmsp, but it must not be
accessible for others. That is, do not use world read or execute
permissions.  In submit.cf the option UseMSP must be set, and
QueueFileMode must be set to 0660.  submit.cf is available in
cf/cf/, which has been built from cf/cf/submit.mc.  The file can
be used as-is, if you want to add more options, use cf/cf/submit.mc
as starting point and read cf/README:  MESSAGE SUBMISSION PROGRAM
carefully.

The .cf file is chosen based on the operation mode.  For -bm (default),
-bs, and -t it is submit.cf (if it exists) for all others it is
sendmail.cf.  This selection can be changed by -Ac or -Am (alternative
.cf file: client or mta).

The daemon must be started by root as usual, e.g.,

/PATH/TO/sendmail -L sm-mta -bd -q1h

(replace /PATH/TO with the right path for your OS, e.g.,
/usr/sbin or /usr/lib).

Notice: if you run sendmail from inetd (which in general is not a
good idea), you must specify -Am in addition to -bs.

Mail will end up in the client queue if the daemon doesn't accept
connections or if an address is temporarily not resolvable.  The
latter problem can be minimized by using

        FEATURE(`nocanonify', `canonify_hosts')
        define(`confDIRECT_SUBMISSION_MODIFIERS', `C')

which, however, may have undesired side effects.  See cf/README for
a discussion.  In general it is necessary to clean the queue either
via a cronjob or by running a daemon, e.g.,

/PATH/TO/sendmail -L sm-msp-queue -Ac -q30m

If the option UseMSP is not set, sendmail will complain during
queue runs about bogus file permission.  If you want a queue runner
for the client queue, you probably have to change OS specific
scripts to accomplish this (check the man pages of your OS for more
information.)  You can start this program as root, it will change
its user id to RunAsUser (smmsp by default, recommended uid: 25).
This way smmsp does not need a valid shell.

Summary
-------

This is a brief summary how the two configuration files are used:

sendmail.cf     For the MTA (mail transmission agent)
        The MTA is started by root as daemon:

                /PATH/TO/sendmail -L sm-mta -bd -q1h

        it accepts SMTP connections (on ports 25 and 587 by default);
        it runs the main queue (/var/spool/mqueue by default).

submit.cf       For the MSP (mail submission program)
        The MSP is used to submit e-mails, hence it is invoked
        by programs (and maybe users); it does not run as SMTP
        daemon; it uses /var/spool/clientmqueue by default; it
        can be started to run that queue periodically:

                /PATH/TO/sendmail -L sm-msp-queue -Ac -q30m


Hints and Troubleshooting
-------------------------

RunAsUser: FEATURE(`msp') sets the option RunAsUser to smmsp.
This user must have the group smmsp, i.e., the same group as the
clientmqueue directory.  If you specify a user whose primary group
is not the same as that of the clientmqueue directory, then you
should explicitly set the group, e.g.,

        FEATURE(`msp')
        define(`confRUN_AS_USER', `mailmsp:smmsp')

STARTTLS: If sendmail is compiled with STARTTLS support on a platform
that does not have HASURANDOMDEV defined, you either need to specify
the RandFile option (as for the MTA), or you have to turn off
STARTTLS in the MSP, e.g.,

        DAEMON_OPTIONS(`Name=NoMTA, Addr=127.0.0.1, M=S')
        FEATURE(`msp')
        CLIENT_OPTIONS(`Family=inet, Address=0.0.0.0, M=S')

The first option is used to turn off STARTTLS when the MSP is
invoked with -bs as some MUAs do.


What doesn't work anymore
-------------------------

Normal users can't use mailq anymore to see the MTA mail queue.
There are several ways around it, e.g., changing QueueFileMode
or giving users access via a program like sudo.

sendmail -bv may give misleading output for normal users since it
may not be able to access certain files, e.g., .forward files of
other users.
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ls /usr/local/share/sendmail/cf/cf/submit*
/usr/local/share/sendmail/cf/cf/submit.cf
/usr/local/share/sendmail/cf/cf/submit.mc
</code></pre></div></div>

<h3 id="good-information-about-the-submitcf-submitmc">Good Information about the submit.cf (submit.mc)</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ wc -l /usr/local/share/sendmail/cf/feature/msp.m4
      78 /usr/local/share/sendmail/cf/feature/msp.m4
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ cat /usr/local/share/sendmail/cf/feature/msp.m4
divert(-1)
#
# Copyright (c) 2000-2002, 2004 Proofpoint, Inc. and its suppliers.
#       All rights reserved.
#
# By using this file, you agree to the terms and conditions set
# forth in the LICENSE file which can be found at the top level of
# the sendmail distribution.
#
#

divert(0)dnl
VERSIONID(`$Id: msp.m4,v 1.34 2013-11-22 20:51:11 ca Exp $')
divert(-1)
undefine(`ALIAS_FILE')
define(`confDELIVERY_MODE', `i')
define(`confUSE_MSP', `True')
define(`confFORWARD_PATH', `')
define(`confPRIVACY_FLAGS', `goaway,noetrn,restrictqrun')
define(`confDONT_PROBE_INTERFACES', `True')
dnl ---------------------------------------------
dnl run as this user (even if called by root)
ifdef(`confRUN_AS_USER',,`define(`confRUN_AS_USER', `smmsp')')
ifdef(`confTRUSTED_USER',,`define(`confTRUSTED_USER',
`ifelse(index(confRUN_AS_USER,`:'), -1, `confRUN_AS_USER',
`substr(confRUN_AS_USER,0,index(confRUN_AS_USER,`:'))')')')
dnl ---------------------------------------------
dnl This queue directory must have the same group
dnl as sendmail and it must be group-writable.
dnl notice: do not test for QUEUE_DIR, it is set in some ostype/*.m4 files
ifdef(`MSP_QUEUE_DIR',
`define(`QUEUE_DIR', `MSP_QUEUE_DIR')',
`define(`QUEUE_DIR', `/var/spool/clientmqueue')')
define(`_MTA_HOST_', ifelse(defn(`_ARG_'), `', `[localhost]', `_ARG_'))
define(`_MSP_FQHN_',`dnl used to qualify addresses
ifdef(`MASQUERADE_NAME', ifdef(`_MASQUERADE_ENVELOPE_', `$M', `$j'), `$j')')
ifelse(_ARG2_, `MSA', `define(`RELAY_MAILER_ARGS', `TCP $h 587')')
dnl ---------------------------------------------
ifdef(`confPID_FILE', `dnl',
`define(`confPID_FILE', QUEUE_DIR`/sm-client.pid')')
define(`confQUEUE_FILE_MODE', `0660')dnl
ifdef(`STATUS_FILE',
`define(`_F_',
`define(`_b_', index(STATUS_FILE, `sendmail.st'))ifelse(_b_, `-1', `STATUS_FILE', `substr(STATUS_FILE, 0, _b_)sm-client.st')')
define(`STATUS_FILE', _F_)
undefine(`_b_') undefine(`_F_')',
`define(`STATUS_FILE', QUEUE_DIR`/sm-client.st')')
FEATURE(`no_default_msa')dnl
ifelse(defn(`_DPO_'), `',
`DAEMON_OPTIONS(`Name=NoMTA, Addr=127.0.0.1, M=E')dnl')
define(`_DEF_LOCAL_MAILER_FLAGS', `')dnl
define(`_DEF_LOCAL_SHELL_FLAGS', `')dnl
define(`LOCAL_MAILER_PATH', `[IPC]')dnl
define(`LOCAL_MAILER_FLAGS', `lmDFMuXkw5')dnl
define(`LOCAL_MAILER_ARGS', `TCP $h')dnl
define(`LOCAL_MAILER_DSN_DIAGNOSTIC_CODE', `SMTP')dnl
define(`LOCAL_SHELL_PATH', `[IPC]')dnl
define(`LOCAL_SHELL_FLAGS', `lmDFMuXk5')dnl
define(`LOCAL_SHELL_ARGS', `TCP $h')dnl
MODIFY_MAILER_FLAGS(`SMTP', `+k5')dnl
MODIFY_MAILER_FLAGS(`ESMTP', `+k5')dnl
MODIFY_MAILER_FLAGS(`DSMTP', `+k5')dnl
MODIFY_MAILER_FLAGS(`SMTP8', `+k5')dnl
MODIFY_MAILER_FLAGS(`RELAY', `+k')dnl
MAILER(`local')dnl
MAILER(`smtp')dnl

LOCAL_CONFIG
D{MTAHost}_MTA_HOST_

LOCAL_RULESETS
SLocal_localaddr
R$+                     $: $&gt;ParseRecipient $1
R$* &lt; @ $+ &gt; $*         $#relay $@ ${MTAHost} $: $1 &lt; @ $2 &gt; $3
ifdef(`_USE_DECNET_SYNTAX_',
`# DECnet
R$+ :: $+               $#relay $@ ${MTAHost} $: $1 :: $2', `dnl')
R$*                     $#relay $@ ${MTAHost} $: $1 &lt; @ _MSP_FQHN_ &gt;
</code></pre></div></div>

<p>An example:</p>

<p><a href="https://groups.google.com/g/comp.mail.sendmail/c/vKQ1dm3Od5Q/m/oJxSQikeBQAJ">Force sendmail to connect to itself - Sendmail newsgroup</a></p>

<h3 id="submitcf---flow">submit.cf - Flow</h3>

<p><a href="https://www.ibm.com/docs/en/aix/7.2?topic=files-sendmailcf-submitcf-file">sendmail.cf and submit.cf File - IBM Documentation - AIX Sendmail</a>:</p>

<blockquote>
  <p>The <strong>sendmail</strong> command uses the <code class="language-plaintext highlighter-rouge">submit.cf</code> configuration file
<strong>by default</strong>. The <code class="language-plaintext highlighter-rouge">sendmail.cf</code> file exists for compatibility with
earlier versions of the <strong>sendmail</strong> command.  The following information
is valid for both <code class="language-plaintext highlighter-rouge">sendmail.cf</code> and <code class="language-plaintext highlighter-rouge">submit.cf</code> configuration files.</p>
</blockquote>

<p><a href="https://www.ibm.com/docs/en/zos/2.1.0?topic=sendmail-creating-message-submission-program-file-submitcf">Creating the Message Submission Program file submit.cf - NOTE that this is for z/OS:</a>:</p>

<blockquote>
  <p><em>Sendmail</em> needs to run as root for several reasons.  The Message
Submission Program (MSP) configuration file <code class="language-plaintext highlighter-rouge">submit.cf</code> eliminates the
need for <em>sendmail</em> to run as root to write email that is <strong>submitted from
the command line</strong> to the <strong>queue directory</strong>.</p>

  <p>MSP requires a set-user-ID/set-group-ID program to avoid problems with
a world-writable directory.  It is, however, sufficient to have a
set-group-ID program and a group-writable queue directory.  This can be
fulfilled by a <em>sendmail</em> daemon that is started by root.  This topic
explains how to use two <em>sendmail</em> configurations to accomplish the goal
of having a <em>sendmail</em> binary file that is not set-user-ID root, and thus
is less problematic in the presence of system configuration and OS problems.</p>

  <p>The default configuration, starting with sendmail 8.12, uses one
<em>sendmail</em> binary file that acts <strong>differently</strong> based on
<strong>operation mode</strong> and <strong>supplied options</strong>.  When running in a program
control environment, two binary files are used, <code class="language-plaintext highlighter-rouge">/usr/sbin/sendmail</code> and
<code class="language-plaintext highlighter-rouge">/bin/sendmail</code>.</p>

  <p>[ . . . ]</p>

  <p><strong>Sendmail</strong> must be a set-group-ID (default group: smmspgrp, recommended
gid: 25) program to allow for queueing mail in a group-writable directory.
Two <code class="language-plaintext highlighter-rouge">.cf</code> files are required, <code class="language-plaintext highlighter-rouge">sendmail.cf</code> for the <strong>daemon</strong> and
<code class="language-plaintext highlighter-rouge">submit.cf</code> for the <strong>submission program</strong>.</p>

  <p>[ . . . ]</p>

  <p>That is, the owner of <em>sendmail</em> is root, the group is smmspgrp, and the
binary file is set-group-ID.  The client mail queue is owned by smmsp
with group smmspgrp and is group writable.  The client mail queue
directory must be writable by smmspgrp, but it must not be accessible
for others.  That is, do not use world read or execute permissions.
In <code class="language-plaintext highlighter-rouge">submit.cf</code>, the option <code class="language-plaintext highlighter-rouge">UseMSP</code> must be set, and <code class="language-plaintext highlighter-rouge">QueueFileMode</code>
must be set to 0660.</p>

  <p>[ . . . ]</p>

  <p>Some features are not intended to work with the MSP.  These include
features that influence the delivery process (for example, mailertable,
aliases), or those that are important only for an SMTP server (for
example, virtusertable, DaemonPortOptions, multiple queues).  Moreover,
relaxing certain restrictions (RestrictQueueRun, permissions on queue
directory) or adding features (for example, enabling prog/file mailer)
can cause security problems.</p>

  <p>Other things do not work well with the MSP and require tweaking or
workarounds.  For example, to allow for client authentication, it is not
sufficient to just provide a client certificate and the corresponding
key, but it is also necessary to make the key group (smmsp) readable and
tell sendmail not to complain about it as follows:</p>

  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>define(`confDONT_BLAME_SENDMAIL', `GroupReadableKeyFile')
</code></pre></div>  </div>

  <p>When <strong>FEATURE(`msp’)</strong> is coded, the <em>sendmail</em> <strong>client</strong> will send
<strong>all mail to the local mail server</strong>. <br />
<strong>If</strong> using the <em>sendmail</em> server as the <strong>local mail server</strong>, review
the <strong>RELAY_DOMAIN()</strong> for the <em>sendmail</em> <strong>server</strong>.  If needed, the
<em>sendmail</em> <strong>client</strong> can be configured to send mail to a different
server with this feature.</p>

  <p>The <code class="language-plaintext highlighter-rouge">feature/msp.m4</code> (on FreeBSD 13, in:
<code class="language-plaintext highlighter-rouge">/usr/local/share/sendmail/cf/feature/msp.m4</code>) defines almost all
settings for the MSP.  Most of these should not be changed at all.
Some of the features and options can be overridden if really necessary.
It is a bit tricky to do this, because it depends on the actual way the
option is defined in <code class="language-plaintext highlighter-rouge">feature/msp.m4</code>.  If it is directly defined [that
is, with define()], the modified value must be defined after the following
line:</p>

  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>FEATURE(`msp')
</code></pre></div>  </div>

  <p>If it is conditionally defined [that is, with ifdef()], the wanted value
must be defined before the FEATURE line in the <code class="language-plaintext highlighter-rouge">.mc</code> file.  To see how
the options are defined, read <code class="language-plaintext highlighter-rouge">feature/msp.m4</code>.</p>

  <p>The <code class="language-plaintext highlighter-rouge">.cf</code> file (<code class="language-plaintext highlighter-rouge">sendmail.cf</code> <strong>or</strong> <code class="language-plaintext highlighter-rouge">submit.cf</code>) is <strong>chosen</strong> based on the
<strong>operation mode</strong>.  For <code class="language-plaintext highlighter-rouge">-bm</code> (<strong>default</strong>), <code class="language-plaintext highlighter-rouge">-bs</code>, and <code class="language-plaintext highlighter-rouge">-t</code>, it is
<code class="language-plaintext highlighter-rouge">submit.cf</code>, if it exists.  For <strong>all others</strong>, it is <code class="language-plaintext highlighter-rouge">sendmail.cf</code>.
This selection <strong>can be changed</strong> by <code class="language-plaintext highlighter-rouge">-Ac</code> (to use <code class="language-plaintext highlighter-rouge">submit.cf</code>) <strong>or</strong>
<code class="language-plaintext highlighter-rouge">-Am</code> (to use <code class="language-plaintext highlighter-rouge">sendmail.cf</code>).</p>

  <p>The <em>daemon</em> <strong>must</strong> be started by <strong>root</strong> as usual, for example:</p>

  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/usr/sbin/sendmail -L sm-mta -bd -q1h
</code></pre></div>  </div>
</blockquote>

<p><a href="https://serverfault.com/questions/266326/make-usr-lib-sendmail-deliver-local-mail-locally-submit-cf-vs-sendmail-cf">Make /usr/lib/sendmail deliver local mail locally (submit.cf vs sendmail.cf)</a>:</p>

<blockquote>
  <p>You can start sendmail with the <code class="language-plaintext highlighter-rouge">-Am</code> switch and not use <code class="language-plaintext highlighter-rouge">submit.cf</code> at all.
Or you can have a <em>sendmail</em> daemon listen in some other port and then
tweak <code class="language-plaintext highlighter-rouge">submit.cf</code> to deliver there instead of port 25.</p>
</blockquote>

<h3 id="the-etcrcsendmail---flow">The <code class="language-plaintext highlighter-rouge">/etc/rc.sendmail</code> - Flow</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ grep sendmail /etc/defaults/rc.conf
mta_start_script="/etc/rc.sendmail"
# Settings for /etc/rc.sendmail and /etc/rc.d/sendmail:
sendmail_enable="NO"    # Run the sendmail inbound daemon (YES/NO).
sendmail_pidfile="/var/run/sendmail.pid"        # sendmail pid file
sendmail_procname="/usr/sbin/sendmail"          # sendmail process name
sendmail_flags="-L sm-mta -bd -q30m" # Flags to sendmail (as a server)
sendmail_cert_create="YES"      # Create a server certificate if none (YES/NO)
#sendmail_cert_cn="CN"          # CN of the generate certificate
sendmail_submit_enable="YES"    # Start a localhost-only MTA for mail submission
sendmail_submit_flags="-L sm-mta -bd -q30m -ODaemonPortOptions=Addr=localhost"
sendmail_outbound_enable="YES"  # Dequeue stuck mail (YES/NO).
sendmail_outbound_flags="-L sm-queue -q30m" # Flags to sendmail (outbound only)
sendmail_msp_queue_enable="YES" # Dequeue stuck clientmqueue mail (YES/NO).
sendmail_msp_queue_flags="-L sm-msp-queue -Ac -q30m"
                                # Flags for sendmail_msp_queue daemon.
sendmail_rebuild_aliases="NO"   # Run newaliases if necessary (YES/NO).
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># The sendmail binary
sendmail_program=${sendmail_program:-/usr/sbin/sendmail}
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ /usr/sbin/sendmail -bt -d0 &lt; /dev/null 
Version 8.17.1
 Compiled with: DANE DNSMAP IPV6_FULL LOG MAP_REGEX MATCHGECOS MILTER
                MIME7TO8 MIME8TO7 NAMED_BIND NETINET NETINET6 NETUNIX NEWDB NIS
                PICKY_HELO_CHECK PIPELINING SASLv2 SCANF STARTTLS TCPWRAPPERS
                TLS_EC TLS_VRFY_PER_CTX USERDB XDEBUG
[ . . . ]
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># The pid is used to stop and restart the running daemon(s).
sendmail_pidfile=${sendmail_pidfile:-/var/run/sendmail.pid}
sendmail_mspq_pidfile=${sendmail_mspq_pidfile:-/var/spool/clientmqueue/sm-client.pid}
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo service sendmail status
Password:
sendmail is running as pid 45131.
sendmail_msp_queue is running as pid 45134.
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo cat /var/run/sendmail.pid
45131
/usr/sbin/sendmail -L sm-mta -bd -q30m
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo cat /var/spool/clientmqueue/sm-client.pid
45134
/usr/sbin/sendmail -L sm-msp-queue -Ac -q30m
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>start_mta()
{
  case ${sendmail_enable} in
    [Yy][Ee][Ss])
      echo -n ' sendmail'
        ${sendmail_program} ${sendmail_flags}

[ . . . ] 
  case ${sendmail_outbound_enable} in
    [Yy][Ee][Ss])
      echo -n ' sendmail-outbound'

[ . . . ]
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ grep sendmail_flags /etc/defaults/rc.conf
sendmail_flags="-L sm-mta -bd -q30m" # Flags to sendmail (as a server)
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ grep sendmail_outbound_flags /etc/defaults/rc.conf
sendmail_outbound_flags="-L sm-queue -q30m" # Flags to sendmail (outbound only)
</code></pre></div></div>

<p>results in:</p>

<p><code class="language-plaintext highlighter-rouge">echo -n ' sendmail' /usr/sbin/sendmail -L sm-mta -bd -q30m</code></p>

<p><code class="language-plaintext highlighter-rouge">echo -n ' sendmail-outbound' /usr/sbin/sendmail -L sm-queue -q30m</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>start_mspq()

  case ${sendmail_enable} in
    [Nn][Oo][Nn][Ee])
      ;;
  *)
    if [ -r /etc/mail/submit.cf ]; then
      case ${sendmail_msp_queue_enable} in
        [Yy][Ee][Ss])
          echo -n ' sendmail-clientmqueue'
            ${sendmail_program} ${sendmail_msp_queue_flags}
            ;;
        esac
    fi
    ;;
  esac
}
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ grep sendmail_msp_queue_flags /etc/defaults/rc.conf
sendmail_msp_queue_flags="-L sm-msp-queue -Ac -q30m"
</code></pre></div></div>

<p>results in:</p>

<p><code class="language-plaintext highlighter-rouge">echo -n ' sendmail' /usr/sbin/sendmail -L sm-msp-queue -Ac -q30m</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># If no argument is given, assume we are being called at boot time.
_action=${1:-start}

case ${_action} in
start)
        start_mta
        start_mspq
        ;;

[ . . . ]
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  echo "usage: `basename $0` {start|stop|restart}" &gt;&amp;2
  echo "       `basename $0` {start-mta|stop-mta|restart-mta}" &gt;&amp;2
  echo "       `basename $0` {start-mspq|stop-mspq|restart-mspq}" &gt;&amp;2
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ls -lh /etc/rc.sendmail
-rw-r--r--  1 root  wheel   5.6K Aug 17  2021 /etc/rc.sendmail
 
$ /etc/rc.sendmail
/etc/rc.sendmail: Permission denied.
 
$ sudo /etc/rc.sendmail
sudo: /etc/rc.sendmail: command not found
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo sh /etc/rc.sendmail
 sendmail sendmail-clientmqueue$ 
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo sh /etc/rc.sendmail status
usage: rc.sendmail {start|stop|restart}
       rc.sendmail {start-mta|stop-mta|restart-mta}
       rc.sendmail {start-mspq|stop-mspq|restart-mspq}
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo service sendmail stop
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ps aux | grep -v grep | grep sendmail
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo service sendmail start
Starting sendmail.
Starting sendmail_msp_queue.
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ps aux | grep -v grep | grep sendmail
root      495   0.0  0.0    18976    8264  -  Ss   11:41        0:00.00 sendmail: accepting connections (sendmail)
smmsp     499   0.0  0.0    18316    7276  -  Is   11:41        0:00.00 sendmail: Queue runner@00:30:00 for /var/spool/clientmqueue (sendmail)
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ date
Thu 24 Nov 2022 11:41:33 PST
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ls -lh /var/run/sendmail.pid 
-rw-------  1 root  wheel    43B Nov 24 11:41 /var/run/sendmail.pid
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo cat /var/run/sendmail.pid
495
/usr/sbin/sendmail -L sm-mta -bd -q30m
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo ls -lh /var/spool/clientmqueue/sm-client.pid
-rw-------  1 smmsp  smmsp    49B Nov 24 11:41 /var/spool/clientmqueue/sm-client.pid
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo cat /var/spool/clientmqueue/sm-client.pid
499
/usr/sbin/sendmail -L sm-msp-queue -Ac -q30m
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ tail /var/log/maillog
[ . . . ]
Nov 24 11:41:28 fbsd1 sm-mta[495]: starting daemon (8.17.1): SMTP+queueing@00:30:00
[ . . . ]
Nov 24 11:41:28 fbsd1 sm-mta[495]: STARTTLS=server, init=1
Nov 24 11:41:28 fbsd1 sm-mta[495]: started as: /usr/sbin/sendmail -L sm-mta -bd -q30m
Nov 24 11:41:28 fbsd1 sm-msp-queue[499]: starting daemon (8.17.1): queueing@00:30:00
Nov 24 11:41:28 fbsd1 sm-msp-queue[499]: started as: /usr/sbin/sendmail -L sm-msp-queue -Ac -q30m
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo service sendmail stop
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ date
Thu 24 Nov 2022 12:07:11 PST
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ tail /var/log/maillog
[ . . . ]
Nov 24 12:07:02 fbsd1 sm-mta[495]: NOQUEUE: stopping daemon, reason=signal
Nov 24 12:07:02 fbsd1 sm-msp-queue[499]: 2AOJfSZ7000498: stopping daemon, reason=signal
</code></pre></div></div>

<h3 id="the-etcrcdsendmail---flow">The <code class="language-plaintext highlighter-rouge">/etc/rc.d/sendmail</code> - Flow</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ls -lh /etc/rc.d/sendmail
-r-xr-xr-x  1 root  wheel   6.4K Aug 17  2021 /etc/rc.d/sendmail
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ /etc/rc.d/sendmail
Usage: /etc/rc.d/sendmail [fast|force|one|quiet](start|stop|restart|rcvar|enable|disable|delete|enabled|describe|extracommands|status|poll)
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ /etc/rc.d/sendmail status
sendmail is not running.
sendmail_msp_queue is not running.
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ /etc/rc.d/sendmail describe
Electronic mail transport agent
Electronic mail transport agent
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ /etc/rc.d/sendmail start
Starting sendmail.
limits: setrlimit datasize: Operation not permitted
/etc/rc.d/sendmail: WARNING: failed to start sendmail
Starting sendmail_msp_queue.
limits: setrlimit datasize: Operation not permitted
/etc/rc.d/sendmail: WARNING: failed to start sendmail_msp_queue
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo /etc/rc.d/sendmail start
Password:
Starting sendmail.
Starting sendmail_msp_queue.
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo /etc/rc.d/sendmail status
sendmail is running as pid 3527.
sendmail_msp_queue is running as pid 3531.
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ date
Thu 24 Nov 2022 12:36:18 PST
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ps aux | grep -v grep | grep sendmail
root     3527   0.0  0.0    18976    8268  -  Ss   12:36        0:00.00 sendmail: accepting connections (sendmail)
smmsp    3531   0.0  0.0    18316    7284  -  Is   12:36        0:00.00 sendmail: Queue runner@00:30:00 for /var/spool/clientmqueue (sendmail)
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ls -lh /var/run/sendmail.pid
-rw-------  1 root  wheel    44B Nov 24 12:36 /var/run/sendmail.pid
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo cat /var/run/sendmail.pid
3527
/usr/sbin/sendmail -L sm-mta -bd -q30m
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo ls -lh /var/spool/clientmqueue/sm-client.pid
-rw-------  1 smmsp  smmsp    50B Nov 24 12:36 /var/spool/clientmqueue/sm-client.pid
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo cat /var/spool/clientmqueue/sm-client.pid
3531
/usr/sbin/sendmail -L sm-msp-queue -Ac -q30m
</code></pre></div></div>

<h3 id="trace-the-flow-with-dtrace1">Trace the Flow with <code class="language-plaintext highlighter-rouge">dtrace(1)</code></h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ command -v dtrace ; type dtrace ; which dtrace ; whereis dtrace
/usr/sbin/dtrace
dtrace is /usr/sbin/dtrace
/usr/sbin/dtrace
dtrace: /usr/sbin/dtrace /usr/share/man/man1/dtrace.1.gz
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ pkg info --regex dtrace
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ pkg search --regex ^dtrace
dtrace-toolkit-1.0_7           Collection of useful scripts for DTrace
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo pkg install dtrace-toolkit  
[ . . . ]
=====
Message from dtrace-toolkit-1.0_7:

--
Many of the DTraceToolkit scripts do not work on FreeBSD at the moment,
usually because:
- They are using Solaris-specific features
- They use probes which are not supported yet on FreeBSD

Some popular scripts are installed at:

    /usr/local/bin

The rest of the scripts and other toolkit files can be found in:

    /usr/local/share/dtrace-toolkit

To view the manual pages in the "1m" manual section,
the section has to be specified explicitly, e.g.:

    man -s 1m fddist
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ find /usr/local/bin/ -name '*dtrace*'
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ find /usr/local/bin/ -lname '*dtrace*'
/usr/local/bin/opensnoop
/usr/local/bin/dtruss
/usr/local/bin/hotkernel
/usr/local/bin/procsystime
/usr/local/bin/shellsnoop
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ stat -f "%N: %HT%SY" /usr/local/bin/* | grep dtrace
/usr/local/bin/dtruss: Symbolic Link -&gt; ../share/dtrace-toolkit/dtruss
/usr/local/bin/hotkernel: Symbolic Link -&gt; ../share/dtrace-toolkit/hotkernel
/usr/local/bin/opensnoop: Symbolic Link -&gt; ../share/dtrace-toolkit/opensnoop
/usr/local/bin/procsystime: Symbolic Link -&gt; ../share/dtrace-toolkit/procsystime
/usr/local/bin/shellsnoop: Symbolic Link -&gt; ../share/dtrace-toolkit/Apps/shellsnoop
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ls -F /usr/local/share/dtrace-toolkit/
Apps/           errinfo*        iosnoop*        Notes/          rwtop*
Bin/            Examples/       iotop*          opensnoop*      Shell/
CDDL@           execsnoop*      Java/           Perl/           Snippits/
Code/           FS/             JavaScript/     Php/            statsnoop*
Cpu/            Guide           Kernel/         Proc/           System/
dexplorer*      hotkernel*      Locks/          procsystime*    Tcl/
Disk/           hotuser*        Man/            Python/         User/
Docs/           Include/        Mem/            README.md       Version
dtruss*         install*        Misc/           Ruby/           Zones/
dvmstat*        iopattern*      Net/            rwsnoop*
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo /usr/local/share/dtrace-toolkit/FS/vfssnoop.d &gt; /tmp/vfssnoopout.txt
</code></pre></div></div>

<p><strong>NOTE:</strong><br />
Instead of the <code class="language-plaintext highlighter-rouge">vfssnoop.d</code> script, you could use this command with similar effect:</p>

<p><code class="language-plaintext highlighter-rouge"># dtrace -n 'syscall::open*:entry { printf("%s %s", execname, copyinstr(arg0)); }'</code></p>

<p>From another shell instance:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ printf %s\\n "Testing." | mail -v -s "Test" dusko
dusko... Connecting to [127.0.0.1] via relay...
220 fbsd1.home.arpa ESMTP Sendmail 8.17.1/8.17.1; Thu, 24 Nov 2022 20:27:30 -0800 (PST)
&gt;&gt;&gt; EHLO fbsd1.home.arpa
250-fbsd1.home.arpa Hello localhost [127.0.0.1], pleased to meet you
250-ENHANCEDSTATUSCODES
250-PIPELINING
250-8BITMIME
250-SIZE
250-DSN
250-STARTTLS
250-DELIVERBY
250 HELP
&gt;&gt;&gt; STARTTLS
220 2.0.0 Ready to start TLS
&gt;&gt;&gt; EHLO fbsd1.home.arpa
250-fbsd1.home.arpa Hello localhost [127.0.0.1], pleased to meet you
250-ENHANCEDSTATUSCODES
250-PIPELINING
250-8BITMIME
250-SIZE
250-DSN
250-DELIVERBY
250 HELP
&gt;&gt;&gt; MAIL From:&lt;dusko@fbsd1.home.arpa&gt; SIZE=34
250 2.1.0 &lt;dusko@fbsd1.home.arpa&gt;... Sender ok
&gt;&gt;&gt; RCPT To:&lt;dusko@fbsd1.home.arpa&gt;
&gt;&gt;&gt; DATA
250 2.1.5 &lt;dusko@fbsd1.home.arpa&gt;... Recipient ok
354 Enter mail, end with "." on a line by itself
&gt;&gt;&gt; .
250 2.0.0 2AP4RUKS027991 Message accepted for delivery
dusko... Sent (2AP4RUKS027991 Message accepted for delivery)
Closing connection to [127.0.0.1]
&gt;&gt;&gt; QUIT
221 2.0.0 fbsd1.home.arpa closing connection
</code></pre></div></div>

<p>Use the <strong>Ctrl+C</strong> key combination to stop the process.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo /usr/local/share/dtrace-toolkit/FS/vfssnoop.d &gt; /tmp/vfssnoopout.txt
^C
</code></pre></div></div>

<p>FORMAT:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>TIMESTAMP           UID    PID PROCESS          CALL             SIZE PATH/FILE
</code></pre></div></div>

<p><strong>NOTE:</strong> Removed <strong>TIMESTAMP</strong> column.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> UID    PID PROCESS       CALL             SIZE PATH/FILE

1001  27989 tcsh          vop_open         - /usr/bin/mail
1001  27989 mail          vop_close        - /usr/bin/mail

1001  27989 mail          vop_open         - /etc/mail.rc
1001  27989 mail          vop_read        4K /etc/mail.rc
1001  27989 mail          vop_close        - /etc/mail.rc

1001  27989 mail          vop_open         - /usr/home/dusko/.mailrc
1001  27989 mail          vop_open         - /usr/home/dusko/.mail_aliases
1001  27989 mail          vop_read        4K /usr/home/dusko/.mail_aliases
1001  27989 mail          vop_close        - /usr/home/dusko/.mail_aliases
1001  27989 mail          vop_close        - /usr/home/dusko/.mailrc

1001  27989 mail          vop_create       - /tmp/mail.RsH2UdGjzkoo
1001  27989 mail          vop_open         - /tmp/&lt;unknown&gt;
1001  27989 mail          vop_getattr      - /tmp/mail.RsH2UdGjzkoo
1001  27989 mail          vop_remove       - /tmp/mail.RsH2UdGjzkoo

1001  27989 mail          vop_create       - /tmp/mail.RstbRvvCU6oB
1001  27989 mail          vop_open         - /tmp/&lt;unknown&gt;
1001  27989 mail          vop_open         - /tmp/mail.RstbRvvCU6oB
1001  27989 mail          vop_remove       - /tmp/mail.RstbRvvCU6oB

1001  27990 mail          vop_open         - /usr/sbin/mailwrapper
1001  27990 mailwrapper   vop_close        - /usr/sbin/mailwrapper

1001  27990 mailwrapper   vop_open         - /usr/local/etc/mail/mailer.conf

1001  27990 mailwrapper   vop_open         - /usr/local/sbin/sendmail
1001  27990 sendmail      vop_close        - /usr/local/sbin/sendmail

1001  27990 sendmail      vop_open         - /etc/libmap.conf
1001  27990 sendmail      vop_getattr      - /etc/libmap.conf
1001  27990 sendmail      vop_read       47B /etc/libmap.conf
1001  27990 sendmail      vop_close        - /etc/libmap.conf

1001  27990 sendmail      vop_open         - /usr/local/etc/libmap.d
[...]
1001  27990 sendmail      vop_close        - /usr/local/etc/libmap.d

1001  27990 sendmail      vop_open         - /usr/local/etc/libmap.d/mesa.conf
[...]
1001  27990 sendmail      vop_close        - /usr/local/etc/libmap.d/mesa.conf

1001  27990 sendmail      vop_open         - /var/run/ld-elf.so.hints
[...]
1001  27990 sendmail      vop_close        - /var/run/ld-elf.so.hints

1001  27990 sendmail      vop_open         - /usr/lib/libwrap.so.6
[...]
1001  27990 sendmail      vop_close        - /usr/lib/libwrap.so.6

1001  27990 sendmail      vop_open         - /usr/local/lib/libsasl2.so.3.0.0
[...]
1001  27990 sendmail      vop_close        - /usr/local/lib/libsasl2.so.3.0.0

1001  27990 sendmail      vop_open         - /usr/lib/libblacklist.so.0
[...]
1001  27990 sendmail      vop_close        - /usr/lib/libblacklist.so.0

1001  27990 sendmail      vop_open         - /usr/lib/libssl.so.111
[...]
1001  27990 sendmail      vop_close        - /usr/lib/libssl.so.111

1001  27990 sendmail      vop_open         - /lib/libcrypto.so.111
[...]
1001  27990 sendmail      vop_close        - /lib/libcrypto.so.111

1001  27990 sendmail      vop_open         - /lib/libutil.so.9
[...] 
1001  27990 sendmail      vop_close        - /lib/libutil.so.9

1001  27990 sendmail      vop_open         - /lib/libc.so.7
[...]
1001  27990 sendmail      vop_close        - /lib/libc.so.7

1001  27990 sendmail      vop_open         - /usr/lib/libdl.so.1
[...]
1001  27990 sendmail      vop_close        - /usr/lib/libdl.so.1

1001  27990 sendmail      vop_open         - /lib/libthr.so.3
[...]
1001  27990 sendmail      vop_close        - /lib/libthr.so.3

1001  27990 sendmail      vop_getattr      - /tmp/&lt;unknown&gt;
1001  27990 sendmail      vop_getattr      - /dev/&lt;unknown&gt;

1001  27990 sendmail      vop_open         - /etc/nsswitch.conf
[...]

1001  27990 sendmail      vop_open         - /etc/pwd.db
[...]
1001  27990 sendmail      vop_close        - /etc/pwd.db

1001  27990 sendmail      vop_open         - /etc/resolv.conf
[...]
1001  27990 sendmail      vop_close        - /etc/resolv.conf

1001  27990 sendmail      vop_open         - /etc/hosts
[...]
1001  27990 sendmail      vop_close        - /etc/hosts

                                           - /etc/localtime 
                                           - /usr/share/zoneinfo/posixrules
                                           - /usr/share/zoneinfo/UTC

1001  27990 sendmail      vop_open         - /etc/mail/submit.cf

1001  27990 sendmail      vop_open         - /etc/pwd.db
[...]
1001  27990 sendmail      vop_close        - /etc/pwd.db

1001  27990 sendmail      vop_read       41K /etc/mail/submit.cf
1001  27990 sendmail      vop_close        - /etc/mail/submit.cf

1001  27990 sendmail      vop_getattr      - /var/spool/clientmqueue

1001  27990 sendmail      vop_close        - /lib/libcrypto.so.111

   0    974 syslogd       vop_write      97B /var/log/debug.log

1001  27990 sendmail      vop_read      260B /etc/pwd.db
[...]
1001  27990 sendmail      vop_close        - /etc/pwd.db

1001  27990 sendmail      vop_create       - /var/spool/clientmqueue/df2AP4RU3I027990

1001  27990 sendmail      vop_create       - /var/spool/clientmqueue/qf2AP4RU3I027990

1001  27990 sendmail      vop_open         - /etc/services
[...]
1001  27990 sendmail      vop_close        - /etc/services

1001  27990 sendmail      vop_open         - /etc/hosts
[...]
1001  27990 sendmail      vop_open         - /etc/hosts

0       974 syslogd       vop_write      90B /var/log/maillog

0     27991 sendmail      vop_getattr      - /etc/resolv.conf

0     27991 sendmail      vop_open         - /etc/hosts
0     27991 sendmail      vop_read        4K /etc/hosts
[...]
0     27991 sendmail      vop_close        - /etc/hosts

0     27991 sendmail      vop_open         - /etc/services
[...]
0     27991 sendmail      vop_close        - /etc/services

0       974 syslogd       vop_write      81B /var/log/maillog

0     27991 sendmail      vop_open         - /etc/hosts.allow
[...]
0     27991 sendmail      vop_close        - /etc/hosts.allow

0       974 syslogd       vop_write      78B /var/log/maillog
[...]
[...]

1001  27990 sendmail      vop_open         - /etc/ssl/openssl.cnf
[...]
1001  27990 sendmail      vop_close        - /etc/ssl/openssl.cnf

1001  27990 sendmail      vop_open         - /usr/lib/libssl.so.111
1001  27990 sendmail      vop_getattr      - /usr/lib/libssl.so.111
1001  27990 sendmail      vop_close        - /usr/lib/libssl.so.111

   0    974 syslogd       vop_write      63B /var/log/maillog

   0    974 syslogd       vop_write      97B /var/log/debug.log

   0  27991 sendmail      vop_open         - /var/log/sendmail.st
[...]
   0  27991 sendmail      vop_close        - /var/log/sendmail.st

   0  27991 sendmail      vop_open         - /etc/spwd.db
[...]
   0  27991 sendmail      vop_close        - /etc/spwd.db

   0    974 syslogd       vop_write     106B /var/log/maillog
[...]
[...]

   0  27991 sendmail      vop_open         - /etc/mail/aliases.db
[...]
[...]

   0  27991 sendmail      vop_open         - /etc/spwd.db
[...]
   0  27991 sendmail      vop_close        - /etc/spwd.db

   0  27991 sendmail      vop_open         - /etc/shells
[...]
   0  27991 sendmail      vop_close        - /etc/shells

   0    974 syslogd       vop_write     109B /var/log/maillog
[...]
[...]

1001  27990 sendmail      vop_read        4K /var/spool/clientmqueue/df2AP4RU3I027990

   0    974 syslogd       vop_write      75B /var/log/maillog
[...]
[...]

   0  27991 sendmail      vop_create       - /var/spool/mqueue/df2AP4RUKS027991
[...]
   0  27991 sendmail      vop_close        - /var/spool/mqueue/df2AP4RUKS027991

   0  27991 sendmail      vop_create       - /var/spool/mqueue/qf2AP4RUKS027991

   0  27991 sendmail      vop_close        - /etc/mail/aliases.db

1001  27990 sendmail      vop_close        - /var/spool/clientmqueue/sm-client.st

1001  27990 sendmail      vop_close        - /var/spool/clientmqueue/df2AP4RU3I027990
1001  27990 sendmail      vop_remove       - /var/spool/clientmqueue/df2AP4RU3I027990

1001  27990 sendmail      vop_remove       - /var/spool/clientmqueue/qf2AP4RU3I027990

   0    974 syslogd       vop_write      73B /var/log/maillog

   0  27991 sendmail      vop_open         - /var/spool/mqueue/qf2AP4RUKS027991

   0  27992 sendmail      vop_open         - /var/spool/mqueue/qf2AP4RUKS027991

   0  27991 sendmail      vop_open         - /var/log/sendmail.st
[...]
   0  27991 sendmail      vop_close        - /var/log/sendmail.st

   0  27992 sendmail      vop_open         - /etc/spwd.db
[...]
   0  27992 sendmail      vop_close        - /etc/spwd.db

   0  27992 sendmail      vop_read      260B /etc/mail/aliases.db
[...]
   0  27992 sendmail      vop_read       32K /etc/mail/aliases.db

   0  27992 sendmail      vop_open         - /etc/spwd.db
[...]
   0  27992 sendmail      vop_close        - /etc/spwd.db

   0  27992 sendmail      vop_open         - /etc/shells
[...]
   0  27992 sendmail      vop_close        - /etc/shells

   0  27992 sendmail      vop_open         - /etc/group
[...]
   0  27992 sendmail      vop_close        - /etc/group

 1001 27992 sendmail      vop_getattr      - /usr/home/dusko

   0  27992 sendmail      vop_open         - /etc/group
[...]
   0  27992 sendmail      vop_close        - /etc/group

   0  27992 sendmail      vop_read        4K /var/spool/mqueue/qf2AP4RUKS027991

   0  27992 sendmail      vop_open         - /var/spool/mqueue/df2AP4RUKS027991

   0  27992 sendmail      vop_create       - /var/spool/mqueue/tf2AP4RUKS027991

   0  27993 sendmail      vop_getattr      - /usr/local/libexec/mail.local
   0  27993 sendmail      vop_open         - /usr/local/libexec/mail.local

   0  27993 sendmail      vop_open         - /libexec/ld-elf.so.1

   0  27993 mail.local    vop_close        - /usr/local/libexec/mail.local

   0  27993 mail.local    vop_open         - /etc/libmap.conf
[...]
   0  27993 mail.local    vop_close        - /etc/libmap.conf

   0  27993 mail.local    vop_open         - /usr/local/etc/libmap.d/mesa.conf
[...]
   0  27993 mail.local    vop_close        - /usr/local/etc/libmap.d/mesa.conf

   0  27993 mail.local    vop_open         - /var/run/ld-elf.so.hints
[...]
   0  27993 mail.local    vop_close        - /var/run/ld-elf.so.hints

   0  27993 mail.local    vop_open         - /lib/libutil.so.9
[...]
   0  27993 mail.local    vop_close        - /var/run/ld-elf.so.hints

   0  27993 mail.local    vop_open         - /lib/libutil.so.9
[...]
   0  27993 mail.local    vop_close        - /lib/libutil.so.9

   0  27993 mail.local    vop_open         - /lib/libc.so.7
[...]
   0  27993 mail.local    vop_close        - /lib/libc.so.7

   0  27993 mail.local    vop_open         - /etc/nsswitch.conf
[...]
   0  27993 mail.local    vop_close        - /etc/nsswitch.conf

   0  27993 mail.local    vop_open         - /etc/services
[...]
   0  27993 mail.local    vop_close        - /etc/services

   0  27993 mail.local    vop_open         - /etc/resolv.conf
[...]
   0  27993 mail.local    vop_close        - /etc/resolv.conf

   0  27993 mail.local    vop_open         - /etc/hosts
[...]
   0  27993 mail.local    vop_close        - /etc/hosts

   0  27993 mail.local    vop_open         - /etc/spwd.db
[...]
   0  27993 mail.local    vop_close        - /etc/spwd.db

   0  27993 mail.local    vop_create       - /tmp/local.0p2YZe
[...]
   0  27993 mail.local    vop_remove       - /tmp/local.0p2YZe

   0  27993 mail.local    vop_open         - /etc/localtime
[...]
[...]

   0  27992 sendmail      vop_getattr      - /var/spool/mqueue/df2AP4RUKS027991
   0  27993 mail.local    vop_close        - /var/spool/mqueue/df2AP4RUKS027991

   0  27992 sendmail      vop_read        4K /var/spool/mqueue/df2AP4RUKS027991

   0  27993 mail.local    vop_read       40K /usr/share/zoneinfo/posixrules
[...]
   0  27993 mail.local    vop_close        - /usr/share/zoneinfo/posixrules

   0  27993 mail.local    vop_open         - /etc/spwd.db
[...]
   0  27993 mail.local    vop_close        - /etc/spwd.db

   0  27993 mail.local    vop_create       - /var/mail/dusko.lock

1001  27993 mail.local    vop_open         - /var/mail/dusko
[...]
1001  27993 mail.local    vop_write     761B /var/mail/dusko
[...]
1001  27993 mail.local    vop_close        - /var/mail/dusko

   0  27992 sendmail      vop_open         - /var/log/sendmail.st
[...]
   0  27992 sendmail      vop_close        - /var/log/sendmail.st

   0  27992 sendmail      vop_close        - /var/spool/mqueue/df2AP4RUKS027991
   0  27992 sendmail      vop_remove       - /var/spool/mqueue/df2AP4RUKS027991

   0  27992 sendmail      vop_remove       - /var/spool/mqueue/qf2AP4RUKS027991

   0  27992 sendmail      vop_close        - /&lt;unknown&gt;

   0    974 syslogd       vop_write      84B /var/log/
   0  27992 sendmail      vop_inactive     - /maillog
   0  27992 sendmail      vop_close        - /etc/mail/aliases.db
   0  27992 sendmail      vop_close        - /dev/&lt;unknown&gt;
   0  27992 sendmail      vop_close        - /dev/&lt;unknown&gt;
</code></pre></div></div>

<hr />

<p>From <br />
<a href="https://docs.oracle.com/cd/E37670_01/E37355/html/ol_examples_dtrace.html">dtrace - Display the names of commands that invoke the open() system call and the name of the file being opened</a></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># dtrace -q -n 'syscall::open:entry { printf("%-16s %-16s\n",execname,copyinstr(arg0)); }'
</code></pre></div></div>

<hr />

<h3 id="trace-the-flow-with-dtrace1-script">Trace the Flow with <code class="language-plaintext highlighter-rouge">dtrace(1)</code> Script</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># cat ip-tcp-udp-probes.d 
#!/usr/sbin/dtrace -s

#pragma D option quiet
#pragma D option switchrate=10Hz

dtrace:::BEGIN
{
    printf(" %30s %-6s %30s %-6s %-6s %s\n\n", "SADDR", "SPORT", "DADDR", "DPORT", "BYTES", "FLAGS");
}

tcp:::receive,
tcp:::send

{
    printf(" %30s %-6u %30s %-6u %-6u (%s%s%s%s%s%s\b)\n",
        args[2]-&gt;ip_saddr, args[4]-&gt;tcp_sport,
        args[2]-&gt;ip_daddr, args[4]-&gt;tcp_dport,
        args[2]-&gt;ip_plength - args[4]-&gt;tcp_offset,
        (args[4]-&gt;tcp_flags &amp; TH_FIN) ? "FIN|" : "",
        (args[4]-&gt;tcp_flags &amp; TH_SYN) ? "SYN|" : "",
        (args[4]-&gt;tcp_flags &amp; TH_RST) ? "RST|" : "",
        (args[4]-&gt;tcp_flags &amp; TH_PUSH) ? "PSH|" : "",
        (args[4]-&gt;tcp_flags &amp; TH_ACK) ? "ACK|" : "",
        (args[4]-&gt;tcp_flags &amp; TH_URG) ? "URG|" : "");
}
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># chmod 0744 ip-tcp-udp-probes.d 
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ./ip-tcp-udp-probes.d &gt; ipprobes.txt 
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ printf %s\\n "Hello" | mail -v -s "Test" dusko
</code></pre></div></div>

<p>Remove non-relevant lines from the <strong>ipprobes.txt</strong>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># cat ipprobes.txt
                          SADDR SPORT                           DADDR DPORT  BYTES  FLAGS

                      127.0.0.1 39446                       127.0.0.1 25     38     (SYN|)
                      127.0.0.1 39446                       127.0.0.1 25     38     (SYN|)
                      127.0.0.1 25                          127.0.0.1 39446  38     (SYN|ACK|)
                      127.0.0.1 25                          127.0.0.1 39446  38     (SYN|ACK|)
                      127.0.0.1 39446                       127.0.0.1 25     30     (ACK|)
                      127.0.0.1 39446                       127.0.0.1 25     30     (ACK|)
                      127.0.0.1 25                          127.0.0.1 39446  121    (PSH|ACK|)
                      127.0.0.1 25                          127.0.0.1 39446  121    (PSH|ACK|)
                      127.0.0.1 39446                       127.0.0.1 25     54     (PSH|ACK|)
                      127.0.0.1 39446                       127.0.0.1 25     54     (PSH|ACK|)
                      127.0.0.1 25                          127.0.0.1 39446  215    (PSH|ACK|)
                      127.0.0.1 25                          127.0.0.1 39446  215    (PSH|ACK|)
                      127.0.0.1 39446                       127.0.0.1 25     40     (PSH|ACK|)
                      127.0.0.1 39446                       127.0.0.1 25     40     (PSH|ACK|)
                      127.0.0.1 25                          127.0.0.1 39446  60     (PSH|ACK|)
                      127.0.0.1 25                          127.0.0.1 39446  60     (PSH|ACK|)
                      127.0.0.1 39446                       127.0.0.1 25     319    (PSH|ACK|)
                      127.0.0.1 39446                       127.0.0.1 25     319    (PSH|ACK|)
                      127.0.0.1 25                          127.0.0.1 39446  2677   (PSH|ACK|)
                      127.0.0.1 25                          127.0.0.1 39446  2677   (PSH|ACK|)
                      127.0.0.1 39446                       127.0.0.1 25     140    (PSH|ACK|)
                      127.0.0.1 39446                       127.0.0.1 25     140    (PSH|ACK|)
                      127.0.0.1 25                          127.0.0.1 39446  285    (PSH|ACK|)
                      127.0.0.1 25                          127.0.0.1 39446  285    (PSH|ACK|)
                      127.0.0.1 39446                       127.0.0.1 25     76     (PSH|ACK|)
                      127.0.0.1 39446                       127.0.0.1 25     76     (PSH|ACK|)
                      127.0.0.1 25                          127.0.0.1 39446  285    (PSH|ACK|)
                      127.0.0.1 25                          127.0.0.1 39446  285    (PSH|ACK|)
                      127.0.0.1 39446                       127.0.0.1 25     30     (ACK|)
                      127.0.0.1 39446                       127.0.0.1 25     30     (ACK|)
                      127.0.0.1 25                          127.0.0.1 39446  223    (PSH|ACK|)
                      127.0.0.1 25                          127.0.0.1 39446  223    (PSH|ACK|)
                      127.0.0.1 39446                       127.0.0.1 25     97     (PSH|ACK|)
                      127.0.0.1 39446                       127.0.0.1 25     97     (PSH|ACK|)
                      127.0.0.1 25                          127.0.0.1 39446  102    (PSH|ACK|)
                      127.0.0.1 25                          127.0.0.1 39446  102    (PSH|ACK|)
                      127.0.0.1 39446                       127.0.0.1 25     93     (PSH|ACK|)
                      127.0.0.1 39446                       127.0.0.1 25     93     (PSH|ACK|)
                      127.0.0.1 25                          127.0.0.1 39446  155    (PSH|ACK|)
                      127.0.0.1 25                          127.0.0.1 39446  155    (PSH|ACK|)
                      127.0.0.1 39446                       127.0.0.1 25     423    (PSH|ACK|)
                      127.0.0.1 39446                       127.0.0.1 25     423    (PSH|ACK|)
                      127.0.0.1 25                          127.0.0.1 39446  30     (ACK|)
                      127.0.0.1 25                          127.0.0.1 39446  30     (ACK|)
                      127.0.0.1 39446                       127.0.0.1 25     55     (PSH|ACK|)
                      127.0.0.1 39446                       127.0.0.1 25     55     (PSH|ACK|)
                      127.0.0.1 25                          127.0.0.1 39446  108    (PSH|ACK|)
                      127.0.0.1 25                          127.0.0.1 39446  108    (PSH|ACK|)
                      127.0.0.1 39446                       127.0.0.1 25     58     (PSH|ACK|)
                      127.0.0.1 39446                       127.0.0.1 25     58     (PSH|ACK|)
                      127.0.0.1 25                          127.0.0.1 39446  100    (PSH|ACK|)
                      127.0.0.1 25                          127.0.0.1 39446  100    (PSH|ACK|)
                      127.0.0.1 39446                       127.0.0.1 25     30     (FIN|ACK|)
                      127.0.0.1 39446                       127.0.0.1 25     30     (FIN|ACK|)
                      127.0.0.1 25                          127.0.0.1 39446  54     (PSH|ACK|)
                      127.0.0.1 25                          127.0.0.1 39446  54     (PSH|ACK|)
                      127.0.0.1 39446                       127.0.0.1 25     19     (RST|)
                      127.0.0.1 39446                       127.0.0.1 25     19     (RST|)
</code></pre></div></div>

<hr />

<ul>
  <li>Good <code class="language-plaintext highlighter-rouge">sendmail.cf</code> configuration file and good commands for 
debugging <em>sendmail</em>:  <br />
<a href="https://www.linuxquestions.org/questions/linux-server-73/sendmail-relay-server-no-longer-working-please-help-549437/">Sendmail Relay server no longer working. PLEASE HELP!</a></li>
</ul>

<p><a href="https://www.schmut.com/cheat-sheets/sendmail-hacks">Sendmail Hacks - Things i need to do with sendmail at work that i keep forgetting</a></p>

<p><a href="https://managing.blue/2006/09/06/configuring-sendmail-for-your-unix-desktop/">Configuring sendmail for your UNIX desktop</a></p>

<p><a href="https://managing.blue/2010/06/23/on-picking-an-mta/">On picking an MTA</a></p>

<p><a href="https://managing.blue/2009/08/21/poor-mans-milter-ahead/">Poor man’s milter-ahead</a> – Mentions: <a href="http://www.snertsoft.com/sendmail/milter-ahead/">milter-ahead</a></p>

<p><a href="https://sareport.darold.net/index.html">The Sendmail/Postfix log analyzer</a></p>

<p><a href="http://www.ranum.com/security/computer_security/archives/sendmail-and-firewalls.pdf">Introduction to Sendmail for Firewalls</a></p>

<p><a href="http://ibgwww.colorado.edu/~lessem/psyc5112/usail/mail/debugging/">Debugging sendmail problems</a></p>

<p><a href="https://docstore.mik.ua/orelly/networking_2ndEd/tcp/ch10_08.htm">Testing sendmail.cf - TCP/IP Network Administration, Third Edition</a></p>

<p><a href="https://lwn.net/Articles/866481/">STARTTLS considered harmful</a></p>

<h2 id="testing-your-server-for-tls-support">Testing Your Server for TLS Support</h2>

<p>SMTP/S or SMTP over TLS uses TCP port 465, rather than SMTP’s port 25.</p>

<h3 id="testing-starttls-support-within-smtp">Testing STARTTLS Support Within SMTP</h3>

<p>This first test will very likely fail if you are trying to test your work
server from home.  Many Internet service providers block TCP/25 traffic 
from customers, because almost all of that would be spam sent from infected
Windows computers in peoples’ homes and small businesses.</p>

<p>But within your organization, or on the server itself, you could try using
telnet to connect to TCP port 25 on the server.  Send over ehlo, the
“extended HELO”, and see if Authentication and STARTTLS are announced.
Look for something like the following, where you type the following lines:
<code class="language-plaintext highlighter-rouge">helo my.host.domain</code>, <code class="language-plaintext highlighter-rouge">ehlo my.host.domain</code>, <code class="language-plaintext highlighter-rouge">quit</code>.</p>

<p>This server supports STARTTLS (line: <code class="language-plaintext highlighter-rouge">250-STARTTLS</code>) but not AUTH over SMTP.</p>

<p>From a workstation within your organization:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ nc testmx.host.domain 25
220 testmx.host.domain ESMTP mailer ready at Sun, 30 Oct 2022 15:01:48 -0700
helo my.host.domain
250 testmx.host.domain ESMTP mailer ready at Sun, 30 Oct 2022 15:01:48 -0700
Hello my.host.domain [123.45.67.8], pleased to meet you
ehlo my.host.domain
250-testmx.host.domain Hello my.host.domain [123.45.67.8], pleased to meet you
250-ENHANCEDSTATUSCODES
250-8BITMIME
250-SIZE 52428800
250-STARTTLS
250-DELIVERBY
250 HELP
quit
221 2.0.0 testmx.host.domain closing connection
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ nc testmx.host.domain 25
220 testmx.host.domain ESMTP mailer ready at Sun, 30 Oct 2022 15:03:36 -0700
ehlo my.host.domain
250-testmx.host.domain Hello my.host.domain [123.45.67.8], pleased to meet you
250-ENHANCEDSTATUSCODES
250-8BITMIME
250-SIZE 52428800
250-STARTTLS
250-DELIVERBY
250 HELP
AUTH LOGIN
503 5.3.3 AUTH not available
AUTH PLAIN
503 5.3.3 AUTH not available
AUTH
503 5.3.3 AUTH not available

quit
221 2.0.0 testmx.host.domain closing connection
</code></pre></div></div>

<p>To start encrypting the connection first by using the STARTTLS command,
you can to use <code class="language-plaintext highlighter-rouge">openssl</code> command.  The <code class="language-plaintext highlighter-rouge">openssl</code> does the STARTTLS
handshake and you can to pick up the conversation from there (decrypted
automatically on the fly).</p>

<p>While still on a workstation within your organization, run the following
<em>openssl</em> command.</p>

<p><strong>Note:</strong> you type the following lines:</p>

<p><code class="language-plaintext highlighter-rouge">ehlo my.host.domain</code>, <br />
<code class="language-plaintext highlighter-rouge">MAIL From:&lt;dusko@my.host.domain&gt;</code>,  <br />
<code class="language-plaintext highlighter-rouge">RCPT To:&lt;dusko@testmx.host.domain&gt;</code>, <br />
<code class="language-plaintext highlighter-rouge">data</code>,</p>

<p>and:</p>

<p><code class="language-plaintext highlighter-rouge">From: Myname &lt;dusko@my.host.domain&gt;</code> <br />
<code class="language-plaintext highlighter-rouge">To: &lt;dusko@testmx.host.domain&gt; Firstname Lastname</code>  <br />
<code class="language-plaintext highlighter-rouge">Subject: Testing SMTP over TLS on port 25</code> <br />
<code class="language-plaintext highlighter-rouge">Press &lt;Enter&gt; key (for newline)</code> <br />
<code class="language-plaintext highlighter-rouge">Testing.</code>  <br />
<code class="language-plaintext highlighter-rouge">.</code></p>

<p>and:</p>

<p><code class="language-plaintext highlighter-rouge">QUIT</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ openssl s_client -starttls smtp -ign_eof -crlf -connect testmx.host.domain:25 
</code></pre></div></div>

<p>Output:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CONNECTED(00000003)
depth=2 C = BE, O = GlobalSign nv-sa, OU = Root CA, CN = GlobalSign Root CA
verify return:1
depth=1 C = BE, O = GlobalSign nv-sa, CN = AlphaSSL CA - SHA256 - G2
verify return:1
depth=0 CN = *.host.domain
verify return:1
---
Certificate chain
 0 s:CN = *.host.domain
   i:C = BE, O = GlobalSign nv-sa, CN = AlphaSSL CA - SHA256 - G2
 1 s:C = BE, O = GlobalSign nv-sa, CN = AlphaSSL CA - SHA256 - G2
   i:C = BE, O = GlobalSign nv-sa, OU = Root CA, CN = GlobalSign Root CA
---
Server certificate
-----BEGIN CERTIFICATE-----
MIIGOjCCBSKgAwIBAgIMMLyMRt1iOWV140T0MA0GCSqGSIb3DQEBCwUAMEwxCzAJ
[ . . . ]
YqHmWFAwYDjLKhyoU6w=
-----END CERTIFICATE-----
subject=CN = *.host.domain

issuer=C = BE, O = GlobalSign nv-sa, CN = AlphaSSL CA - SHA256 - G2

---
No client certificate CA names sent
Peer signing digest: SHA256
Peer signature type: RSA
Server Temp Key: DH, 1024 bits
---
SSL handshake has read 3992 bytes and written 542 bytes
Verification: OK
---
New, TLSv1.2, Cipher is DHE-RSA-AES256-GCM-SHA384
Server public key is 2048 bit
Secure Renegotiation IS supported
Compression: NONE
Expansion: NONE
No ALPN negotiated
SSL-Session:
    Protocol  : TLSv1.2
    Cipher    : DHE-RSA-AES256-GCM-SHA384
    Session-ID: E846518A07F0268F5A050119C0BE69CAA5D3FE6F2CE1027B5CA75AEF38BF4956
    Session-ID-ctx: 
    Master-Key: 769E3781160E13E[ . . . ]
    PSK identity: None
    PSK identity hint: None
    SRP username: None
    TLS session ticket lifetime hint: 1 (seconds)
    TLS session ticket:
    0000 - 7c ac ce 3e e4 ab d9 b1-fe 5f 1b c4 89 32 74 1d   |..&gt;....._...2t.
    0010 - [ . . . ]
    0020 - [ . . . ]
    0030 - [ . . . ]
    0040 - [ . . . ]
    0050 - [ . . . ]
    0060 - [ . . . ]
    0070 - [ . . . ]
    0080 - [ . . . ]
    0090 - [ . . . ]
    00a0 - [ . . . ]
    00b0 - [ . . . ]

    Start Time: 1667166567
    Timeout   : 7200 (sec)
    Verify return code: 0 (ok)
    Extended master secret: no
---
250 HELP
ehlo my.host.domain 
250-testmx.host.domain Hello my.host.domain [123.45.67.8], pleased to meet you
250-ENHANCEDSTATUSCODES
250-8BITMIME
250-SIZE 52428800
250-DELIVERBY
250 HELP
MAIL From:&lt;dusko@my.host.domain&gt;
250 2.1.0 &lt;dusko@my.host.domain&gt;... Sender ok
RCPT To:&lt;dusko@testmx.host.domain&gt; 
250 2.1.5 &lt;dusko@testmx.host.domain&gt;... Recipient ok 
data
354 Enter mail, end with "." on a line by itself
From: Myname &lt;dusko@my.host.domain&gt;
To: &lt;dusko@testmx.host.domain&gt; Firstname Lastname 
Subject: Testing SMTP over TLS on port 25

Testing.
.
250 2.0.0 29ULnMCa012594 Message accepted for delivery
QUIT
221 2.0.0 testmx.host.domain closing connection
closed
</code></pre></div></div>

<p><strong>Note:</strong> In <code class="language-plaintext highlighter-rouge">From: </code> and <code class="language-plaintext highlighter-rouge">To: </code> fields, you can reverse the order of the
name and email address.</p>

<p>Log into the mail server and check <em>sendmail</em> maillog:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># grep 29ULnMCa012594 /var/log/maillog 
Oct 30 17:00:48 testmx sendmail[30004]: 29ULnMCa012594: from=&lt;dusko@my.host.domain&gt;, size=110, class=0, nrcpts=1, msgid=&lt;202210302359.29ULnMCa012594@testmx.host.domain&gt;, proto=ESMTP, daemon=MTA, relay=my.host.domain [123.45.67.8]
Oct 30 17:00:49 testmx sendmail[30279]: 29ULnMCa012594: to=&lt;dusko@testmx.host.domain&gt;, delay=00:00:56, xdelay=00:00:01, mailer=local, pri=30490, dsn=2.0.0, stat=Sent
Oct 30 17:00:49 testmx sendmail[30279]: 29ULnMCa012594: done; delay=00:00:56, ntries=1
</code></pre></div></div>

<p>The envelope address (<code class="language-plaintext highlighter-rouge">MAIL From:</code>) check:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ openssl s_client -starttls smtp -ign_eof -crlf -connect testmx.host.domain:25 
[ . . . ]
[ . . . ]
---
250 HELP
ehlo ehlo my.host.domain  
250-testmx.host.domain Hello my.host.domain [123.45.67.8], pleased to meet you
250-ENHANCEDSTATUSCODES
250-8BITMIME
250-SIZE 52428800
250-DELIVERBY
250 HELP
MAIL From:&lt;dusko@non.existing.domain&gt;
250 2.1.0 &lt;dusko@non.existing.domain&gt;... Sender ok
RCPT To:&lt;dusko@testmx.host.domain&gt; 
553 5.1.8 &lt;dusko@testmx.host.domain&gt;... Domain of sender address dusko@non.existing.domain does not exist
QUIT
221 2.0.0 testmx.host.domain closing connection 
closed
</code></pre></div></div>

<h4 id="base64">Base64</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ perl -MMIME::Base64 -le 'print decode_base64("VXNlcm5hbWU6");'
Username:
 
$ perl -MMIME::Base64 -le 'print decode_base64("UGFzc3dvcmQ6");'
Password:
</code></pre></div></div>

<p>Username and password - For Auth PLAIN:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ perl -MMIME::Base64 -le 'print encode_base64("\000myusername\000MyPassword");'
AG15dXNlcm5hbWUATXlQYXNzd29yZA==
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ perl -MMIME::Base64 -le 'print decode_base64("AG15dXNlcm5hbWUATXlQYXNzd29yZA==");'
myusernameMyPassword
</code></pre></div></div>

<p>Username and password - For Auth LOGIN:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ perl -MMIME::Base64 -le 'print encode_base64("myusername");'
bXl1c2VybmFtZQ==

$ perl -MMIME::Base64 -le 'print encode_base64("MyPassword");'
TXlQYXNzd29yZA==
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ perl -MMIME::Base64 -le 'print decode_base64("bXl1c2VybmFtZQ==");'
myusername
 
$ perl -MMIME::Base64 -le 'print decode_base64("TXlQYXNzd29yZA==");'
MyPassword
</code></pre></div></div>

<h2 id="testing">Testing</h2>

<h3 id="testing-a-ruleset-with-sendmails-address-test-mode-sendmail--bt">Testing a Ruleset With Sendmail’s Address Test Mode, sendmail -bt</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@fbsd1:/etc/mail # sendmail -bt
ADDRESS TEST MODE (ruleset 3 NOT automatically invoked)
Enter &lt;ruleset&gt; &lt;address&gt;
</code></pre></div></div>

<p>To see a complete list of debugging commands available, type ?</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; ?
Help for test mode:
?                :this help message.
.Dmvalue         :define macro `m' to `value'.
.Ccvalue         :add `value' to class `c'.
=Sruleset        :dump the contents of the indicated ruleset.
=M               :display the known mailers.
-ddebug-spec     :equivalent to the command-line -d debug flag.
$m               :print the value of macro $m.
$=c              :print the contents of class $=c.
/mx host         :returns the MX records for `host'.
/parse address   :parse address, returning the value of crackaddr, and
                  the parsed address.
/try mailer addr :rewrite address into the form it will have when
                  presented to the indicated mailer.
/tryflags flags  :set flags used by parsing.  The flags can be `H' for
                  Header or `E' for Envelope, and `S' for Sender or `R'
                  for Recipient.  These can be combined, `HR' sets
                  flags for header recipients.
/canon hostname  :try to canonify hostname.
/map mapname key :look up `key' in the indicated `mapname'.
/quit            :quit address test mode.
rules addr       :run the indicated address through the named rules.
                  Rules can be a comma separated list of rules.
End of HELP info
</code></pre></div></div>

<p><strong>Reference:</strong></p>

<p><a href="http://www.harker.com/sendmail/rules-overview.html">Understanding Sendmail Address Rewriting Rules</a></p>

<h2 id="appendix">Appendix</h2>

<h3 id="brief-dtrace1-and-dwatch1-intro">Brief dtrace(1) and dwatch(1) Intro</h3>

<h3 id="--use-this-1-of-2--">—»&gt;  USE THIS 1 OF 2!  «&lt;—</h3>

<h4 id="dtrace1---system-calls">dtrace(1) - System Calls</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># dtrace -n 'syscall::open*:entry { printf("%s %s", execname, copyinstr(arg0)); }'
</code></pre></div></div>

<p>From  <br />
<a href="https://klarasystems.com/articles/freebsd-performance-observability/">FreeBSD Performance Observability - Learn what’s happening in your FreeBSD system and alter the way the system behaves in real time</a></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># dtrace -l | sed 1d | awk '{print $2}' | sort -u
</code></pre></div></div>

<p>Trace file opens with process and filename:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># dwatch -X open
[ . . . ]
</code></pre></div></div>

<p>Find the parent of a process calling a syscall</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dwatch -R syscall::read:entry
[ . . . ] 
</code></pre></div></div>

<p>Trace TCP accepted connections by remote IP address:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># dwatch -X tcp-accept-established
INFO Sourcing tcp-accept-established profile [found in /usr/libexec/dwatch]
INFO Watching 'tcp:::accept-established' ...
2022 Nov 26 15:16:50 0.0 intr[12]: 127.0.0.1:25 &lt;- 127.0.0.1:19231
^C
</code></pre></div></div>

<p>Trace TCP active opens by remote IP address:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># dwatch -X tcp-connect-established
INFO Sourcing tcp-connect-established profile [found in /usr/libexec/dwatch]
INFO Watching 'tcp:::connect-established' ...
2022 Nov 26 15:18:10 0.0 intr[12]: 127.0.0.1:13729 -&gt; 127.0.0.1:25
^C
</code></pre></div></div>

<p>Trace TCP sent messages by remote IP address:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># dwatch -X tcp-send
[ . . . ]
</code></pre></div></div>

<p>Trace TCP received messages by remote IP address:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># dwatch -X tcp-receive
[ . . . ]
</code></pre></div></div>

<p>Trace TCP activity while given nc command runs:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># dwatch -X tcp -- -c 'mail -v -s "Test" dusko'
[ . . . ]
</code></pre></div></div>

<h1 id="trace-vfs-lookup-events-by-path">Trace VFS lookup events by path:</h1>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># dwatch -X vop_lookup
INFO Sourcing vop_lookup profile [found in /usr/libexec/dwatch]
INFO Watching 'vfs:vop:vop_lookup:entry' ...
2022 Nov 26 19:02:44 1001.1001 mail[70112]: /tmp/mail.RsW228Y8ZvvR
2022 Nov 26 19:02:44 1001.1001 mail[70112]: /tmp/mail.RsW228Y8ZvvR
2022 Nov 26 19:02:44 1001.1001 mail[70112]: /tmp/mail.RsW228Y8ZvvR
2022 Nov 26 19:02:44 1001.1001 mail[70112]: /tmp/mail.RsylzXOLZtiD
2022 Nov 26 19:02:44 1001.1001 mail[70112]: /tmp/mail.RsylzXOLZtiD
2022 Nov 26 19:02:44 1001.1001 mail[70112]: /tmp/mail.RsylzXOLZtiD
2022 Nov 26 19:02:44 1001.25 sendmail[70113]: /var/spool/clientmqueue/
2022 Nov 26 19:02:44 1001.25 sendmail[70113]: /var/spool/clientmqueue/
2022 Nov 26 19:02:44 1001.25 sendmail[70113]: /var/spool/clientmqueue
2022 Nov 26 19:02:44 1001.25 sendmail[70113]: /var/spool/clientmqueue/.
2022 Nov 26 19:02:44 1001.25 sendmail[70113]: /var/spool/clientmqueue/ 
2022 Nov 26 19:02:44 1001.25 sendmail[70113]: /var/spool/clientmqueue/.
2022 Nov 26 19:02:44 1001.25 sendmail[70113]: /var/spool/clientmqueue/.
2022 Nov 26 19:02:44 1001.25 sendmail[70113]: /var/spool/clientmqueue/qf
2022 Nov 26 19:02:44 1001.25 sendmail[70113]: /var/spool/clientmqueue/df
2022 Nov 26 19:02:44 1001.25 sendmail[70113]: /var/spool/clientmqueue/xf
2022 Nov 26 19:02:44 1001.25 sendmail[70113]: /var/spool/clientmqueue/.
2022 Nov 26 19:02:44 1001.25 sendmail[70113]: /var/spool/clientmqueue/./xf2AR32ig9070113
2022 Nov 26 19:02:44 1001.25 sendmail[70113]: /var/spool/clientmqueue/xf2AR32ig9070113
2022 Nov 26 19:02:44 1001.25 sendmail[70113]: /var/spool/clientmqueue/.
2022 Nov 26 19:02:44 1001.25 sendmail[70113]: /var/spool/clientmqueue/./df2AR32ig9070113
2022 Nov 26 19:02:44 1001.25 sendmail[70113]: /var/spool/clientmqueue/df2AR32ig9070113
2022 Nov 26 19:02:44 1001.25 sendmail[70113]: /var/spool/clientmqueue/./df2AR32ig9070113
2022 Nov 26 19:02:44 1001.25 sendmail[70113]: /var/spool/clientmqueue/df2AR32ig9070113
2022 Nov 26 19:02:44 1001.25 sendmail[70113]: /var/spool/clientmqueue/./df2AR32ig9070113
2022 Nov 26 19:02:44 1001.25 sendmail[70113]: /var/spool/clientmqueue/df2AR32ig9070113
2022 Nov 26 19:02:44 1001.25 sendmail[70113]: /var/spool/clientmqueue/.
2022 Nov 26 19:02:44 1001.25 sendmail[70113]: /var/spool/clientmqueue/.
2022 Nov 26 19:02:44 1001.25 sendmail[70113]: /var/spool/clientmqueue/./df2AR32ig9070113
2022 Nov 26 19:02:44 1001.25 sendmail[70113]: /var/spool/clientmqueue/df2AR32ig9070113
2022 Nov 26 19:02:44 1001.25 sendmail[70113]: /var/spool/clientmqueue/./df2AR32ig9070113
2022 Nov 26 19:02:44 1001.25 sendmail[70113]: /var/spool/clientmqueue/df2AR32ig9070113
2022 Nov 26 19:02:44 1001.25 sendmail[70113]: /var/spool/clientmqueue/./qf2AR32ig9070113
2022 Nov 26 19:02:44 1001.25 sendmail[70113]: /var/spool/clientmqueue/qf2AR32ig9070113
2022 Nov 26 19:02:44 1001.25 sendmail[70113]: /dev/crypto
2022 Nov 26 19:02:44 1001.25 sendmail[70113]: /dev/crypto
2022 Nov 26 19:02:44 0.0 sendmail[70114]: /var/spool/mqueue/df2AR32ii1070114
2022 Nov 26 19:02:44 0.0 sendmail[70114]: /var/spool/mqueue/qf2AR32ii1070114
2022 Nov 26 19:02:44 0.0 sendmail[70114]: /var/spool/mqueue/xf2AR32ii1070114
2022 Nov 26 19:02:44 0.0 sendmail[70114]: /var/spool/mqueue/xf2AR32ii2070114
2022 Nov 26 19:02:44 0.0 sendmail[70114]: /var/spool/mqueue/df2AR32ii2070114
2022 Nov 26 19:02:44 0.0 sendmail[70114]: /var/spool/mqueue/df2AR32ii2070114
2022 Nov 26 19:02:44 0.0 sendmail[70114]: /var/spool/mqueue/df2AR32ii2070114
2022 Nov 26 19:02:44 0.0 sendmail[70114]: /var/spool/mqueue/qf2AR32ii2070114
2022 Nov 26 19:02:44 0.0 sendmail[70114]: /var/spool/mqueue/xf2AR32ii2070114
2022 Nov 26 19:02:44 1001.25 sendmail[70113]: /var/spool/clientmqueue/sm-client.st
2022 Nov 26 19:02:44 1001.25 sendmail[70113]: /var/spool/clientmqueue/sm-client.st
2022 Nov 26 19:02:44 1001.25 sendmail[70113]: /var/spool/clientmqueue/./df2AR32ig9070113
2022 Nov 26 19:02:44 0.0 sendmail[70115]: /dev/null
2022 Nov 26 19:02:44 1001.25 sendmail[70113]: /var/spool/clientmqueue/df2AR32ig9070113
2022 Nov 26 19:02:44 0.0 sendmail[70115]: /dev/null
2022 Nov 26 19:02:44 1001.25 sendmail[70113]: /var/spool/clientmqueue/./qf2AR32ig9070113
2022 Nov 26 19:02:44 0.0 sendmail[70115]: /dev/null
2022 Nov 26 19:02:44 1001.25 sendmail[70113]: /var/spool/clientmqueue/qf2AR32ig9070113
2022 Nov 26 19:02:44 0.0 sendmail[70115]: /dev/null
2022 Nov 26 19:02:44 1001.25 sendmail[70113]: /var/spool/clientmqueue/./xf2AR32ig9070113
2022 Nov 26 19:02:44 0.0 sendmail[70115]: /var/spool/mqueue/xf2AR32ii2070114
2022 Nov 26 19:02:44 1001.25 sendmail[70113]: /var/spool/clientmqueue/xf2AR32ig9070113
2022 Nov 26 19:02:44 0.0 sendmail[70115]: /var/spool/mqueue/qf2AR32ii2070114
2022 Nov 26 19:02:44 0.0 sendmail[70114]: /dev/null
2022 Nov 26 19:02:44 0.0 sendmail[70114]: /dev/null
2022 Nov 26 19:02:44 0.0 sendmail[70114]: /dev/null
2022 Nov 26 19:02:44 0.0 sendmail[70114]: /dev/null
2022 Nov 26 19:02:44 0.0 sendmail[70114]: /var/spool/mqueue/df2AR32ii3070114
2022 Nov 26 19:02:44 0.0 sendmail[70114]: /var/spool/mqueue/qf2AR32ii3070114
2022 Nov 26 19:02:44 0.0 sendmail[70114]: /var/spool/mqueue/xf2AR32ii3070114
2022 Nov 26 19:02:44 0.25 sendmail[70115]: /var/spool/mqueue/tf2AR32ii2070114
2022 Nov 26 19:02:44 0.25 sendmail[70115]: /var/spool/mqueue/tf2AR32ii2070114
2022 Nov 26 19:02:44 0.25 sendmail[70115]: /var/spool/mqueue/qf2AR32ii2070114
2022 Nov 26 19:02:44 0.0 mail.local[70116]: /tmp/local.HnQB1H
2022 Nov 26 19:02:44 0.0 mail.local[70116]: /tmp/local.HnQB1H
2022 Nov 26 19:02:44 0.0 mail.local[70116]: /var/mail/dusko.lock
2022 Nov 26 19:02:44 0.0 mail.local[70116]: /var/mail/dusko.lock
2022 Nov 26 19:02:44 0.25 sendmail[70115]: /var/spool/mqueue/df2AR32ii2070114
2022 Nov 26 19:02:44 0.25 sendmail[70115]: /var/spool/mqueue/qf2AR32ii2070114
2022 Nov 26 19:02:44 0.25 sendmail[70115]: /var/spool/mqueue/xf2AR32ii2070114
^C
</code></pre></div></div>

<p>Trace VFS create events by path:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># dwatch -X vop_create
INFO Sourcing vop_create profile [found in /usr/libexec/dwatch]
INFO Watching 'vfs:vop:vop_create:entry' ...
2022 Nov 26 19:09:14 1001.1001 mail[70625]: /tmp/mail.RshkOoUT6V9r
2022 Nov 26 19:09:14 1001.1001 mail[70625]: /tmp/mail.RsxKgOHLGsmf
2022 Nov 26 19:09:14 1001.25 sendmail[70626]: /var/spool/clientmqueue/df2AR39EnD070626
2022 Nov 26 19:09:14 1001.25 sendmail[70626]: /var/spool/clientmqueue/qf2AR39EnD070626
2022 Nov 26 19:09:14 0.0 sendmail[70627]: /var/spool/mqueue/df2AR39Elv070627
2022 Nov 26 19:09:14 0.0 sendmail[70627]: /var/spool/mqueue/qf2AR39Elv070627
2022 Nov 26 19:09:14 0.25 sendmail[70628]: /var/spool/mqueue/tf2AR39Elv070627
2022 Nov 26 19:09:14 0.0 mail.local[70629]: /tmp/local.5vsbk5
2022 Nov 26 19:09:14 0.0 mail.local[70629]: /var/mail/dusko.lock
^C
</code></pre></div></div>

<p>Trace VFS remove events by path:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># dwatch -X vop_remove
[ . . . ]
</code></pre></div></div>

<p>Trace VFS readdir events by path:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># dwatch -X vop_readdir
[ . . . ]
</code></pre></div></div>

<p>Trace VFS rename events by path and destination:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># dwatch -X vop_rename
INFO Sourcing vop_rename profile [found in /usr/libexec/dwatch]
INFO Watching 'vfs:vop:vop_rename:entry' ...
2022 Nov 26 19:19:39 0.25 sendmail[71356]: /var/spool/mqueue/tf2AR3Jd5P071355 -&gt; /var/spool/mqueue/qf2AR3Jd5P071355
^C
</code></pre></div></div>

<p>Trace processes performing writes with small buffers but ignore dtrace executable:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># dwatch -X write -t 'execname != "dtrace" &amp;&amp; this-&gt;nbytes &lt; 10'
[ . . . ]
</code></pre></div></div>

<h3 id="--use-this-2-of-2--">—»&gt;  USE THIS 2 OF 2!  «&lt;—</h3>

<p>From Systems Performance: Enterprise and the Cloud - By Brendan 
Gregg - Appendix D. DTrace One-Liners:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># dtrace -n 'syscall::open:entry { printf("%s %s", execname, copyinstr(arg0)); }'
[ . . . ]
</code></pre></div></div>

<p>Trace new processes with process name and arguments:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># dtrace -n 'proc:::exec-success { trace(curpsinfo-&gt;pr_psargs); }'
dtrace: description 'proc:::exec-success ' matched 1 probe
CPU     ID                    FUNCTION:NAME
  5  88556                none:exec-success   printf %s\n Testing.
  1  88556                none:exec-success   mail -v -s Test 6 dusko
  2  88556                none:exec-success   sendmail -i -v dusko
  2  88556                none:exec-success   sendmail -i -v dusko
  6  88556                none:exec-success   mail.local -l
^C
</code></pre></div></div>

<p>Trace new processes with arguments and time:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># dtrace -qn 'syscall::exec*:return { printf("%Y %s\n",walltimestamp,curpsinfo-&gt;pr_psargs); }'
[ . . . ]
</code></pre></div></div>

<p>Trace inbound TCP connections by remote address:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># dtrace -n 'tcp:::accept-established { trace(args[3]-&gt;tcps_raddr); }'
dtrace: description 'tcp:::accept-established ' matched 1 probe
CPU     ID                    FUNCTION:NAME
  4  88667          none:accept-established   127.0.0.1
^C
</code></pre></div></div>

<p>Trace files opened/created by process name:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># dtrace -n 'syscall::openat*:entry { printf("%s %s",execname,copyinstr(arg1)); }'
dtrace: description 'syscall::openat*:entry ' matched 2 probes
CPU     ID                    FUNCTION:NAME
  2  91306                     openat:entry mail /tmp/mail.RsdZQ34D6FcS
  2  91306                     openat:entry mail /tmp/mail.Rs0owR9iO4WP
  7  91306                     openat:entry sendmail /etc/mail/submit.cf
  7  91306                     openat:entry sendmail ./df2AQMK5BV055327
  7  91306                     openat:entry sendmail ./df2AQMK5BV055327
  7  91306                     openat:entry sendmail ./qf2AQMK5BV055327
  7  91306                     openat:entry sendmail /dev/crypto
  3  91306                     openat:entry sendmail /var/log/sendmail.st
  3  91306                     openat:entry sendmail ./df2AQMK5wg055328
  6  91306                     openat:entry sendmail ./df2AQMK5wg055328
  6  91306                     openat:entry sendmail ./qf2AQMK5wg055328
  7  91306                     openat:entry sendmail /var/spool/clientmqueue/sm-client.st
  3  91306                     openat:entry sendmail /dev/null
  3  91306                     openat:entry sendmail /dev/null
  3  91306                     openat:entry sendmail ./qf2AQMK5wg055328
  6  91306                     openat:entry sendmail /dev/null
  6  91306                     openat:entry sendmail /dev/null
  6  91306                     openat:entry sendmail /var/log/sendmail.st
  3  91306                     openat:entry sendmail ./df2AQMK5wg055328
  3  91306                     openat:entry sendmail ./tf2AQMK5wg055328
  3  91306                     openat:entry mail.local /tmp/local.iD5X5s
  3  91306                     openat:entry mail.local /var/mail/dusko.lock
  3  91306                     openat:entry mail.local /var/mail/dusko
  2  91306                     openat:entry sendmail /var/log/sendmail.st
^C
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># dtrace -n 'syscall::open:entry { printf("At %Y %s file opened by PID %d UID %d using %s\n", walltimestamp, copyinstr(arg0), pid, uid, execname); }'
[ . . . ]
</code></pre></div></div>

<p>Trace inbound TCP connections by local address:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># dtrace -n 'tcp:::accept-established { trace(args[3]-&gt;tcps_laddr); }'
dtrace: description 'tcp:::accept-established ' matched 1 probe
CPU     ID                    FUNCTION:NAME
  0  88667          none:accept-established   127.0.0.1
^C
</code></pre></div></div>

<p>Trace inbound TCP connections by local port:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># dtrace -n 'tcp:::accept-established { trace(args[3]-&gt;tcps_lport); }'
dtrace: description 'tcp:::accept-established ' matched 1 probe
CPU     ID                    FUNCTION:NAME
  7  88667          none:accept-established     25
^C
</code></pre></div></div>

<p>Other DTrace One-Liners:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># dtrace -n 'tcp:::accept-refused { trace(args[4]-&gt;tcp_dport); }'
dtrace: description 'tcp:::accept-refused ' matched 1 probe
CPU     ID                    FUNCTION:NAME
  1  88668              none:accept-refused  40691
  6  88668              none:accept-refused     25
^C
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># dtrace -n 'tcp:::accept-established { trace(args[3]-&gt;tcps_lport); }'
dtrace: description 'tcp:::accept-established ' matched 1 probe
CPU     ID                    FUNCTION:NAME
  7  88667          none:accept-established     25
^C
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># dtrace -n 'tcp:::receive { trace(args[3]-&gt;tcps_lport); }'

# dtrace -n 'tcp:::receive { trace(args[3]-&gt;tcps_lport); }'

# dtrace -n 'tcp:::receive { trace(args[2]-&gt;ip_daddr); }'
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># cat dtrace-ex1.d
syscall::open:entry
{
    printf("%s, %s\n", execname, copyinstr(arg0));
}
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># dtrace -q -s dtrace-ex1.d 
printf, /etc/libmap.conf
[ . . . ]
mail, /etc/libmap.conf
mail, /usr/local/etc/libmap.d
mail, /usr/local/etc/libmap.d/mesa.conf
mail, /var/run/ld-elf.so.hints
mail, /lib/libc.so.7
mail, /usr/share/misc/mail.rc
mail, /usr/local/etc/mail.rc
mail, /etc/mail.rc
mail, /home/dusko/.mailrc
mail, /home/dusko/.mail_aliases
mail, /etc/localtime
mail, /usr/share/zoneinfo/posixrules
mail, /tmp/mail.Rs6miNZyD4Du
mailwrapper, /etc/libmap.conf
mailwrapper, /usr/local/etc/libmap.d
mailwrapper, /usr/local/etc/libmap.d/mesa.conf
mailwrapper, /var/run/ld-elf.so.hints
mailwrapper, /lib/libutil.so.9
mailwrapper, /lib/libc.so.7
mailwrapper, /usr/local/etc/mail/mailer.conf
sendmail, /etc/libmap.conf
sendmail, /usr/local/etc/libmap.d
sendmail, /usr/local/etc/libmap.d/mesa.conf
sendmail, /var/run/ld-elf.so.hints
sendmail, /lib/libwrap.so.6
sendmail, /usr/lib/libwrap.so.6
sendmail, /lib/libsasl2.so.3
sendmail, /usr/lib/libsasl2.so.3
sendmail, /usr/lib/compat/libsasl2.so.3
sendmail, /usr/local/lib/libsasl2.so.3
sendmail, /lib/libblacklist.so.0
sendmail, /usr/lib/libblacklist.so.0
sendmail, /lib/libssl.so.111
sendmail, /usr/lib/libssl.so.111
sendmail, /lib/libcrypto.so.111
sendmail, /lib/libutil.so.9
sendmail, /lib/libc.so.7
sendmail, /lib/libdl.so.1
sendmail, /usr/lib/libdl.so.1
sendmail, /lib/libthr.so.3
sendmail, /etc/nsswitch.conf
sendmail, /etc/pwd.db
sendmail, /etc/pwd.db
sendmail, /etc/resolv.conf
sendmail, /etc/hosts
sendmail, /etc/hosts
sendmail, /etc/localtime
sendmail, /usr/share/zoneinfo/posixrules
sendmail, /usr/share/zoneinfo/UTC
sendmail, /usr/share/zoneinfo/posixrules
sendmail, /etc/pwd.db
sendmail, /etc/pwd.db
sendmail, /lib/libcrypto.so.111
sendmail, /etc/pwd.db
sendmail, /etc/pwd.db
sendmail, /etc/services
sendmail, /etc/hosts
sendmail, /etc/hosts
sendmail, /etc/hosts
sendmail, /etc/hosts
sendmail, /etc/services
sendmail, /etc/hosts.allow
sendmail, /etc/ssl/openssl.cnf
sendmail, /usr/lib/libssl.so.111
sendmail, /etc/spwd.db
sendmail, /etc/mail/aliases.db
sendmail, /etc/spwd.db
sendmail, /etc/shells
sendmail, /etc/spwd.db
sendmail, /etc/mail/aliases.db
sendmail, /etc/spwd.db
sendmail, /etc/shells
sendmail, /etc/group
sendmail, /etc/group
sendmail, /etc/group
sendmail, /etc/group
mail.local, /etc/libmap.conf
mail.local, /usr/local/etc/libmap.d
mail.local, /usr/local/etc/libmap.d/mesa.conf
mail.local, /var/run/ld-elf.so.hints
mail.local, /lib/libutil.so.9
mail.local, /lib/libc.so.7
mail.local, /etc/nsswitch.conf
mail.local, /etc/services
mail.local, /etc/resolv.conf
mail.local, /etc/hosts
mail.local, /etc/spwd.db
mail.local, /etc/localtime
mail.local, /usr/share/zoneinfo/posixrules
mail.local, /etc/spwd.db
[ . . . ]
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># cat dtrace-ex2.d
syscall::write:entry
{
        printf("%s", stringof(copyin(arg1, arg2)));
}
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># dtrace -q -s dtrace-ex2.d &gt; sendmailTRACE
^C#
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># file sendmailTRACE
sendmailTRACE: data

# wc -l sendmailTRACE
     791 sendmailTRACE
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># cat sendmailTRACE
  
Received: from fbsd1.home.arpa (localhost [127.0.0.1])
[ . . . ]
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># strings sendmailTRACE | wc -l
     898
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># strings sendmailTRACE
0.re\
|Testing.
Testing.
To: dusko
Subject: Test 01
[ . . . ]
1 sendmail[51179]: 2AO3Up92051179: SMTP outgoing connect on localhost
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ grep 2AO3Up92051179 /var/log/maillog
[ . . . ]
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ tail -21 ~/mbox
 
From dusko@fbsd1.home.arpa Wed Nov 23 19:30:52 2022
Return-Path: &lt;dusko@fbsd1.home.arpa&gt;
Received: from fbsd1.home.arpa (localhost [127.0.0.1])
        by fbsd1.home.arpa (8.17.1/8.17.1) with ESMTPS id 2AO3UpXe051180
        (version=TLSv1.3 cipher=TLS_AES_256_GCM_SHA384 bits=256 verify=NO)
        for &lt;dusko@fbsd1.home.arpa&gt;; Wed, 23 Nov 2022 19:30:51 -0800 (PST)
        (envelope-from dusko@fbsd1.home.arpa)
Received: (from dusko@localhost)
        by fbsd1.home.arpa (8.17.1/8.17.1/Submit) id 2AO3Up92051179
        for dusko; Wed, 23 Nov 2022 19:30:51 -0800 (PST)
        (envelope-from dusko)
Date: Wed, 23 Nov 2022 19:30:51 -0800 (PST)
From: dusko &lt;dusko@fbsd1.home.arpa&gt;
Message-Id: &lt;202211240330.2AO3Up92051179@fbsd1.home.arpa&gt;
To: dusko@fbsd1.home.arpa
Subject: Test 01
Status: RO

Testing.
</code></pre></div></div>

<h4 id="dtrace1---counts-statistics-and-such">dtrace(1) - Counts, Statistics and Such</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># dtrace -n 'syscall:::entry { @[execname, probefunc] = count(); }'

# dtrace -n 'syscall::read:return /execname == "sshd"/ { @ = quantize(arg0); }'

# dtrace -n 'syscall::read:entry { self-&gt;ts = timestamp; } syscall::read:return /self-&gt;ts / \
 { @ = quantize(timestamp - self-&gt;ts); self-&gt;ts = 0; }'

# dtrace -n 'syscall::read:entry { self-&gt;vts = vtimestamp; } syscall::read:return /self-&gt;vts/ \
 { @["On-CPU us:"] = lquantize((vtimestamp - self-&gt;vts) / 1000, 0, 10000, 10); self-&gt;vts = 0; }'

# dtrace -n 'proc::: { @[probename] = count(); } tick-5s { exit(0); }'

# dtrace -x stackframes=100 -n 'profile-99 /arg0/ { @[stack()] = count(); }'

# dtrace -n 'sched:::off-cpu { @[stack(8)] = count(); }'

# dtrace -n 'tcp:::accept-established { @[args[3]-&gt;tcps_raddr] = count(); }'
</code></pre></div></div>

<p><strong>REFERENCES:</strong></p>

<p><a href="https://wiki.freebsd.org/DTrace/One-Liners">DTraceOne-Liners - FreeBSD Wiki</a></p>

<h3 id="trace-the-flow-with-dtruss1m">Trace the Flow with <code class="language-plaintext highlighter-rouge">dtruss(1m)</code></h3>

<p>Examine all processes called “sendmail”:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># dtruss -n sendmail
[ . . . ]
</code></pre></div></div>

<p>Run and examine the following command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># dtruss 'printf %s\\n "Hello" | mail -v -s "Test" dusko'
[ . . . ]
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># dtruss -a mail -v dusko
[ . . . ]
</code></pre></div></div>

<h3 id="trace-the-flow-with-truss1">Trace the Flow with <code class="language-plaintext highlighter-rouge">truss(1)</code></h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># truss mail -v dusko
[ . . . ]
</code></pre></div></div>

<h3 id="trace-the-flow-with-ktrace1">Trace the Flow with <code class="language-plaintext highlighter-rouge">ktrace(1)</code></h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ktrace -i mail -v dusko
[ . . . ]
</code></pre></div></div>

<p>Then:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># kdump -f ktrace.out
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># strings ktrace.out
</code></pre></div></div>

<h2 id="how-do-i-see-how-sendmail-will-deliver-a-message">How do I see how sendmail will deliver a message?</h2>

<p>Based on <a href="http://www.harker.com/sendmail/debug.deliver.html">How do I see how sendmail will deliver a message?</a>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ hostname
fbsd1.home.arpa
</code></pre></div></div>

<p>For a local mailbox:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sendmail -bt
ADDRESS TEST MODE (ruleset 3 NOT automatically invoked)
Enter &lt;ruleset&gt; &lt;address&gt;
&gt; /parse dusko@fbsd1.home.arpa
Cracked address = $g
Parsing envelope recipient address
canonify           input: dusko @ fbsd1 . home . arpa
.
.   (output deleted)
.
final            returns: dusko
mailer local, user dusko
</code></pre></div></div>

<p>For an external (nonlocal) mailbox:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sendmail -bt
ADDRESS TEST MODE (ruleset 3 NOT automatically invoked)
Enter &lt;ruleset&gt; &lt;address&gt;
&gt; /parse testuser1@yahoo.com 
Cracked address = $g
Parsing envelope recipient address
canonify           input: testuser1 @ yahoo . com
.
.   (output deleted)
.
final            returns: testuser1 @ yahoo . com
mailer esmtp, host yahoo.com., user testuser1@yahoo.com
</code></pre></div></div>

<p>The “mailer” is the delivery agent that will do the actual delivery.
You can find it in your <code class="language-plaintext highlighter-rouge">sendmail.cf</code> file by looking for the line starting
with “Mmailername”, in this case “Mesmtp”.  The <em>esmtp</em> delivery agent is
the same as <em>smtp</em> mailer (the <em>smtp</em> mailer includes support for sending
email to other hosts on the Internet) but also speaks ESMTP (Extended SMTP).
This is the preferred delivery agent for delivery over networks.</p>

<p>The “host” is the host that <em>sendmail</em> will connect to, in this case
“yahoo.com”.</p>

<p>The “user” is the actual recipient address that will be passed to the next
host for delivery, in this case “testuser1@yahoo.com”.</p>

<h2 id="the-r-configuration-command">The R Configuration Command</h2>

<p>Rules are declared in the configuration file with the R configuration command. Like all configuration commands, the R rule configuration command must begin a line. The general form consists of an R command followed by three parts:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Rlhs    rhs   comment
    ↑       ↑
    tabs    tabs
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">lhs</code> stands for <em>lefthand</em> side and is most commonly expressed
as LHS.  The <code class="language-plaintext highlighter-rouge">rhs</code> stands for <em>righthand</em> side and is expressed as RHS.
The LHS and RHS are mandatory.  The third part (the <code class="language-plaintext highlighter-rouge">comment</code>) is optional.
The three parts must be separated from each other by one or more tab
characters (space characters will <em>not</em> work).</p>

<p>Space characters between the <code class="language-plaintext highlighter-rouge">R</code> and the LHS are optional.  If there is
a tab between the <code class="language-plaintext highlighter-rouge">R</code> and the LHS, <em>sendmail</em> prints and logs the
following error:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>configfile: line number: R line: null LHS
</code></pre></div></div>

<p>Space characters can be used inside any of the three parts: the LHS, RHS,
or comment.  They are often used in those parts to make rules clearer and
easier to parse visually.</p>

<p>The tabs leading to the comment and the comment itself are optional and
can be omitted.  If the RHS is absent, <em>sendmail</em> prints the following
warning and ignores that <code class="language-plaintext highlighter-rouge">R</code> line:</p>

<p><code class="language-plaintext highlighter-rouge">invalid rewrite line "bad rule here" (tab expected)</code></p>

<p>This error is printed when the RHS is absent, even if there are tabs
following the LHS.  (This warning is usually the result of tabs being
converted to spaces when text is copied from one window to another in
a windowing system using cut and paste.)</p>

<h2 id="o--set-option">O – Set Option</h2>

<p>From <em>Sendmail Installation and Operation Guide, No. 8, SMM</em> (on FreeBSD 13, location: <code class="language-plaintext highlighter-rouge">/usr/local/share/doc/sendmail/op.ps</code> (PostScript version) <code class="language-plaintext highlighter-rouge">/usr/local/share/doc/sendmail/op.txt</code> (plain text version)):</p>

<blockquote>
  <p>5.7.  O – Set Option</p>

  <p>There are a number of global options that can be set from a configuration file.
Options are represented by full words; some are also representable as single characters for back compatibility. 
The syntax of this line is:</p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>O  option=value
</code></pre></div>  </div>

  <p>This sets option option to be value.
Note that there must be a space between the letter <code class="language-plaintext highlighter-rouge">O</code> and the name of the option.
An older version is:</p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Oovalue
</code></pre></div>  </div>

  <p>where the option <code class="language-plaintext highlighter-rouge">o</code> is a single character.
Depending on the option, value may be a string, an integer, a boolean (with legal values “t”, “T”, “f”, or “F”; the default is TRUE), or a time interval.</p>

  <p>. . .</p>

  <p>The options supported (with the old, one character names in brackets) are:</p>

  <p>. . .</p>

  <p>AliasFile=spec, spec, …  <br />
[A]  Specify possible alias file(s).   <br />
. . .</p>

  <p>All options can be specified on the command line using the <code class="language-plaintext highlighter-rouge">-O</code> or <code class="language-plaintext highlighter-rouge">-o</code> flag, but most will cause <em>sendmail</em> to relinquish its  <em>set-user-ID</em>  permissions.</p>

  <p>The options that will not cause this are SevenBitInput [7], EightBitMode [8], MinFreeBlocks [b], CheckpointInterval [C], DeliveryMode [d], ErrorMode [e], IgnoreDots [i], SendMimeErrors [j], LogLevel [L], MeToo [m], OldStyleHeaders [o], PrivacyOptions [p], SuperSafe [s], Verbose [v], Que
ueSortOrder, MinQueueAge, DefaultCharSet, DialDelay, NoRecipientAction, ColonOkInAddr, MaxQueueRunSize, SingleLineFromHeader, and AllowBogusHELO.</p>

  <p>Actually, PrivacyOptions [p] given on the command line are added to those already specified in  the sendmail.cf  file, i.e., they can’t be reset.</p>

  <p>Also, M(define macro) when defining the r or s macros is also considered “safe”.</p>
</blockquote>

<h2 id="comments">Comments</h2>

<p>Comments provide you with the documentation necessary to maintain the
configuration file.  Because comments slow down <em>sendmail</em> by only
a negligible amount, and only at startup, it is better to overcomment
than to undercomment.</p>

<p>Blank lines and lines that begin with a <code class="language-plaintext highlighter-rouge">#</code> character are considered
comments and are ignored.  A blank line is one that contains no characters
at all (except for its terminating newline).  Indentation characters
(spaces and tabs) are invisible and can turn an apparently blank line into
an empty-looking line, which is not ignored:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># text            ← a comment
tabtext            ← a continuation line
            ← a blank line
tab            ← an "empty-looking line"
</code></pre></div></div>

<hr />

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sed -n 4647,4672p /usr/local/share/sendmail/cf/README 

+--------------------------+
| FORMAT OF FILES AND MAPS |
+--------------------------+

Files that define classes, i.e., F{classname}, consist of lines
each of which contains a single element of the class.  For example,
/etc/mail/local-host-names may have the following content:

my.domain
another.domain

Maps must be created using makemap(8) , e.g.,

        makemap hash MAP &lt; MAP

In general, a text file from which a map is created contains lines
of the form

key     value

where 'key' and 'value' are also called LHS and RHS, respectively.
By default, the delimiter between LHS and RHS is a non-empty sequence
of white space characters.
</code></pre></div></div>

<h2 id="v8-comments">V8 Comments</h2>

<p>Beginning with V8 <em>sendmail</em>, all lines of configuration files of version
levels 3 and above can have optional trailing comments.  That is, all text
from the first <code class="language-plaintext highlighter-rouge">#</code> character to the end of the line is ignored.
Any whitespace (space or tab characters) leading up to the <code class="language-plaintext highlighter-rouge">#</code> is also ignored:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CWlocalhost mailhost  # This is a comment
                    ↑
                    from here to end of line ignored
</code></pre></div></div>

<p>To include a <code class="language-plaintext highlighter-rouge">#</code> character in a line under V8 <em>sendmail</em>, precede it with
a backslash:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>DM16\#megs
</code></pre></div></div>

<p>Note that you do not need to escape the <code class="language-plaintext highlighter-rouge">#</code> in the <code class="language-plaintext highlighter-rouge">$#</code> operator.
The <code class="language-plaintext highlighter-rouge">$</code> has a higher precedence, and <code class="language-plaintext highlighter-rouge">$#</code> is interpreted correctly.</p>

<h2 id="continuation-lines">Continuation Lines</h2>

<p>A line that begins with either a tab or a space character is considered
a continuation of the preceding line.  Internally, such continuation lines
are joined to the preceding line, and the newline character of that
preceding line is retained.  Thus, for example:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>DZzoos
       lions and bears
↑
line begins with a tab character
</code></pre></div></div>

<p>is internally joined by <em>sendmail</em> to form:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>DZzoos\n       lions and bears
       ↑
       newline and tab retained
</code></pre></div></div>

<p>Both the newline (<code class="language-plaintext highlighter-rouge">\n</code>) and the tab are retained.  When such a joined line
is later used (as in a header), the joined line is split at the newline
and prints as two separate lines again.</p>

<h2 id="pitfalls">Pitfalls</h2>

<ul>
  <li>Avoid accidentally creating an empty-looking line (one that contains only
invisible space and tab characters) in the <em>sendmail.cf</em> file when you
really intend to create a blank line (one that contains only the newline
character).  The empty-looking line is joined by <em>sendmail</em> to the line
above it and is likely to cause mysterious problems that are difficult
to debug.  One way to find such lines is to run a command such as the
following, where there is a single space between the <code class="language-plaintext highlighter-rouge">^</code> and the dot:</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ grep '^ .*$' /etc/mail/sendmail.cf
</code></pre></div></div>

<ul>
  <li>The listening daemon and the submission <em>msp sendmail</em> use two different
configuration files (i.e., <em>sendmail.cf</em> and <em>submit.cf</em>).  Unless you
specify a specific configuration file with <code class="language-plaintext highlighter-rouge">-C</code>, the <code class="language-plaintext highlighter-rouge">-Am</code> and <code class="language-plaintext highlighter-rouge">-Ac</code>
switches determine which of the two configuration files is used.</li>
</ul>

<h2 id="pitfalls-1">Pitfalls</h2>

<ul>
  <li>The use of the <code class="language-plaintext highlighter-rouge">#</code> to place comments into a <em>.mc</em> file for eventual
transfer to your configuration file might not work as expected.  The <code class="language-plaintext highlighter-rouge">#</code> is
not special to the <em>m4</em> processor, so <em>m4</em> continues to process a line even
though that line is intended to be a comment.  So, instead of:</li>
</ul>

<p><code class="language-plaintext highlighter-rouge"># Here we define $m as our domain</code></p>

<p>(which would see <code class="language-plaintext highlighter-rouge">define</code> as an <em>m4</em> keyword), use single quotes to
insulate all such comments from <em>m4</em> interpretation:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># `Here we define $m as our domain'
</code></pre></div></div>

<ul>
  <li>Never blindly overwrite your <em>sendmail.cf</em> file with a new one.
Always compare the new version to the old first:</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ diff /etc/mail/sendmail.cf oursite.cf
19c19
&lt; ##### built by you@oursite.com on Sat Nov  3  11:26:39 PDT 2007
---
&gt; ##### built by you@oursite.com on Fri Dec 14 04:14:25 PDT 2007
</code></pre></div></div>

<p>Here, the only change was the date the files were built, but if you had
expected some other change, this would tell you the change had failed.</p>

<ul>
  <li>
    <p>Never edit your <em>sendmail.cf</em> file directly.  If you do, you will never
be able to generate a duplicate or update from your mc file.  This is an
especially serious problem when upgrading from one release of <em>sendmail</em>
to a newer release.  Should you make this mistake, reread the appropriate
sections in this book and the documentation supplied with the <em>sendmail</em>
source.</p>
  </li>
  <li>
    <p>Don’t assume that UUCP support and UUCP relaying are turned off by default.
Always use <code class="language-plaintext highlighter-rouge">FEATURE(nouucp)</code> to disable UUCP unless you actually support UUCP:</p>
  </li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>FEATURE(`nouucp')               ← recommended through V8.9
FEATURE(`nouucp',`reject')      ← recommended with V8.10 and later
</code></pre></div></div>

<h2 id="syntax">Syntax</h2>

<p>The <code class="language-plaintext highlighter-rouge">&gt;</code> prompt expects rule sets and addresses to be specified like this:</p>

<p><code class="language-plaintext highlighter-rouge">&gt; ident,ident,ident ...   address</code></p>

<p>Each <code class="language-plaintext highlighter-rouge">ident</code> is a rule set name or number.  When there is more than one
rule set, they must be separated from each other by commas (with no spaces
between them).</p>

<p>For numbered rule sets, the number must be in the range of 0 through the
highest number allowed.  A number that is too large causes <em>sendmail</em> to
print the following two errors:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bad rule set number (max max)
Undefined rule set number
</code></pre></div></div>

<p>A rule set whose number is below the maximum but was never defined will
act as though it was defined but lacks rules.</p>

<p>Named rule sets must exist in the symbol table. If the name specified was
never defined, the following error is printed:</p>

<p><code class="language-plaintext highlighter-rouge">Undefined rule set ident</code></p>

<p>If any rule set number in the comma-separated list of rule sets is omitted
(e.g., <code class="language-plaintext highlighter-rouge">ident,,ident</code>), <em>sendmail</em> interprets the second comma as part of
the second identifier, thus producing this error:</p>

<p><code class="language-plaintext highlighter-rouge">Undefined rule set ,identifier</code></p>

<p>The <code class="language-plaintext highlighter-rouge">address</code> is everything following the first whitespace (space and tab
characters) to the end of the line.  If whitespace characters appear
anywhere in the list of rule sets, the rule sets to the right of the
whitespace are interpreted as part of the address.</p>

<p>We show named rule sets in our examples, even though numbered rule sets
will work just as well.  But by using named rule sets, the examples will
still work even if the corresponding numbers change in the future.</p>

<h2 id="the-configuration-file">The Configuration File</h2>

<p>The configuration file contains all the information <em>sendmail</em> needs to do
its job.  Within it you provide information, such as file locations,
permissions, and modes of operation.</p>

<p>Rewriting rules and rule sets also appear in the configuration file.
They transform a mail address into another form that might be required for
delivery.  They are perhaps the single most confusing aspect of the
configuration file.  Because the configuration file is designed to be fast
for sendmail to read and parse, rules can look cryptic to humans:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>R $+ @ $+		$: $1 &lt; @ $2 &gt;	focus on domain
R $+ &lt; $+ @ $+ &gt;	$1 $2 &lt; @ $3 &gt;	move gaze right
</code></pre></div></div>

<p>But what appears to be complex is really just succinct.  The <code class="language-plaintext highlighter-rouge">R</code> at the
beginning of each line, for example, labels a rewrite rule.  And the <code class="language-plaintext highlighter-rouge">$+</code>
expressions mean to match one or more parts of an address.  With experience,
such expressions (and indeed the configuration file as a whole) soon
become meaningful.</p>

<p>Fortunately, you don’t need to learn the details of rule sets to configure
and install sendmail.  The <em>mc</em> form of configuration insulates you from
such details, and allows you to perform very complex tasks easily.</p>

<h2 id="configuration-commands">Configuration Commands</h2>

<p>The <em>sendmail.cf</em> configuration file is line-oriented.<br />
A configuration command, composed of a single letter, begins each line:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>V10/Berkeley                       ← good
V10/Berkeley                       ← bad, does not begin a line
V10/Berkeley Fw/etc/mail/mxhosts   ← bad, two commands on one line
Fw/etc/mail/mxhosts                ← good
</code></pre></div></div>

<p>Each configuration command is followed by parameters that are specific
to it.  For example, the <code class="language-plaintext highlighter-rouge">V</code> command is followed by an ASCII representation
of an integer value, a slash, and a vendor name.  Whereas the <code class="language-plaintext highlighter-rouge">F</code> command
is followed by a letter (a <code class="language-plaintext highlighter-rouge">w</code> in the example), then the full pathname of
a file.  The complete list of configuration commands is shown in
Footnotes  <strong><sup><a href="#footnotes">[2]</a></sup></strong>.</p>

<p>Some commands, such as <code class="language-plaintext highlighter-rouge">V</code>, should appear only once in your <em>sendmail.cf</em>
file.  Others, such as <code class="language-plaintext highlighter-rouge">R</code>, can appear often.</p>

<p>Blank lines and lines that begin with the <code class="language-plaintext highlighter-rouge">#</code> character are considered
comments and are ignored.  A line that begins with either a tab or a space
character is a continuation of the preceding line:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># a comment
V10
     /Berkeley  ← continuation of V line above
  ↑ tab
</code></pre></div></div>

<p>Note that anything other than a command, a blank line, a space, a tab,
or a <code class="language-plaintext highlighter-rouge">#</code> character causes an error.  If the <em>sendmail</em> program finds such
a character, it prints the following warning, ignores that line, and
continues to read the configuration file:</p>

<p><code class="language-plaintext highlighter-rouge">/etc/mail/sendmail.cf: line 15: unknown configuration line "v9"</code></p>

<p>Here, <em>sendmail</em> found a line in its <em>sendmail.cf</em> file that began with
the letter <code class="language-plaintext highlighter-rouge">v</code>.  Because a lowercase <code class="language-plaintext highlighter-rouge">v</code> is not a legal command, <em>sendmail</em>
printed a warning.  The line number in the warning is that of the line in
the <em>sendmail.cf</em> file that began with the illegal character.</p>

<h2 id="rules">Rules</h2>

<p>At the heart of the <em>sendmail.cf</em> file are sequences of rules that
rewrite (transform) mail addresses from one form to another.  This is
necessary chiefly because addresses must conform to many differing
standards.  The R command is used to define a rewriting rule:</p>

<p><code class="language-plaintext highlighter-rouge">R$-	$@ $1 @ $R     user -&gt;  user @ remote </code></p>

<p>Mail addresses are compared to the rule on the left (<code class="language-plaintext highlighter-rouge">$-</code>).  If they match
that rule, they are rewritten on the basis of the rule on the right
(<code class="language-plaintext highlighter-rouge">$@ $1 @ $R</code>).  The text at the far right is a comment (that doesn’t
require a leading <code class="language-plaintext highlighter-rouge">#</code>).</p>

<p>Use of multicharacter macros and <code class="language-plaintext highlighter-rouge">#</code> comments (V8 configuration files and
above) can make rules appear a bit less cryptic:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>R$-				# If a plain username
	$@ $1 @ ${REMOTE}	#    append "@" remote host
</code></pre></div></div>

<h2 id="rule-sets">Rule sets</h2>

<p>Because rewriting can require several steps, rules are organized into sets,
which can be thought of as subroutines.  The <code class="language-plaintext highlighter-rouge">S</code> command begins a rule set:</p>

<p><code class="language-plaintext highlighter-rouge">S3</code></p>

<p>This particular <code class="language-plaintext highlighter-rouge">S</code> command begins rule set 3.  Beginning with V8.7 <em>sendmail</em>,
rule sets can be given symbolic names as well as numbers:</p>

<p><code class="language-plaintext highlighter-rouge">SHubset</code></p>

<p>This particular <code class="language-plaintext highlighter-rouge">S</code> command begins a rule set named <code class="language-plaintext highlighter-rouge">Hubset</code>.  Named rule
sets are automatically assigned numbers by <em>sendmail</em>.</p>

<p>All the <code class="language-plaintext highlighter-rouge">R</code> commands (rules) that follow an <code class="language-plaintext highlighter-rouge">S</code> command belong to that
rule set.  A rule set ends when another <code class="language-plaintext highlighter-rouge">S</code> command appears to define
another rule set.</p>

<h2 id="chapter-18-the-r-rules-configuration-command">Chapter 18. The R (Rules) Configuration Command</h2>

<p>Rules are like little if-then or while-do clauses, existing inside rule
sets, that test a pattern against an address and change the address if the
two match.  The process of converting one form of an address into another
is called <strong>rewriting</strong>.  Most rewriting requires a sequence of many rules
because an individual rule is relatively limited in what it can do.
This need for many rules, combined with the <em>sendmail</em> program’s need for
succinct expressions, can make sequences of rules dauntingly cryptic.</p>

<h2 id="the-r-configuration-command-1">The R Configuration Command</h2>

<p>Rules are declared in the configuration file with the <code class="language-plaintext highlighter-rouge">R</code> configuration
command.  Like all configuration commands, the <code class="language-plaintext highlighter-rouge">R</code> rule configuration
command must begin a line.  The general form consists of an <code class="language-plaintext highlighter-rouge">R</code> command
followed by three parts:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Rlhs    rhs   comment
    ↑       ↑
    tabs    tabs
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">lhs</code> stands for <strong>lefthand side</strong> and is most commonly expressed
as <strong>LHS</strong>.  The <code class="language-plaintext highlighter-rouge">rhs</code> stands for <strong>righthand side</strong> and is expressed
as <strong>RHS</strong>.  The LHS and RHS are mandatory. The third part (the <code class="language-plaintext highlighter-rouge">comment</code>)
is optional.  The three parts must be separated from each other by one or
more <strong>tab</strong> characters (space characters will not work).</p>

<p>Space characters between the <code class="language-plaintext highlighter-rouge">R</code> and the LHS are optional.  If there is
a tab between the R and the LHS, <em>sendmail</em> prints and logs the following
error:</p>

<p><code class="language-plaintext highlighter-rouge">configfile: line number: R line: null LHS</code></p>

<p>Space characters can be used inside any of the three parts: the LHS, RHS,
or comment.  They are often used in those parts to make rules clearer and
easier to parse visually.</p>

<p>The tabs leading to the comment and the comment itself are optional and
can be omitted.  If the RHS is absent, <em>sendmail</em> prints the following
warning and ignores that <code class="language-plaintext highlighter-rouge">R</code> line:</p>

<p><code class="language-plaintext highlighter-rouge">invalid rewrite line "bad rule here" (tab expected)</code></p>

<p>This error is printed when the RHS is absent, even if there are tabs
following the LHS.  (This warning is usually the result of tabs being
converted to spaces when text is copied from one window to another in
a windowing system using cut and paste.)</p>

<h2 id="macros-in-rules">Macros in Rules</h2>

<p>Each noncomment part of a rule is expanded as the configuration file
is read.  (Actually, the comment part is expanded too, but with no effect
other than a tiny expenditure of time.)  Thus, any references to defined
macros are replaced with the value that the macro has at that point in the
configuration file.  To illustrate, consider the following mini
configuration file (which is named <em>test.cf</em>):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>V10
Stest
DAvalue1
R $A	$A.new
DAvalue2
R $A	$A.new
</code></pre></div></div>

<p>First, note that as of V8.10 <em>sendmail</em>, rules (the <code class="language-plaintext highlighter-rouge">R</code> lines) cannot exist
outside of rule sets (the <code class="language-plaintext highlighter-rouge">S</code> line).  If you omit a rule set declaration,
the following error will be printed and logged:</p>

<p><code class="language-plaintext highlighter-rouge">configfile: line number: missing valid ruleset for "bad rule here"</code></p>

<p>Second, note that beginning with V8.9, <em>sendmail</em> will complain if the
configuration file lacks a correct version number (the <code class="language-plaintext highlighter-rouge">V</code> line).
Had you omitted that line, <em>sendmail</em> would have printed and logged the
following warning:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Warning: .cf file is out of date: sendmail 8.12.6 supports version 10,
.cf file is version 0
</code></pre></div></div>

<p>The first <code class="language-plaintext highlighter-rouge">D</code> line assigns the value <code class="language-plaintext highlighter-rouge">value1</code> to the <code class="language-plaintext highlighter-rouge">$A</code> <em>sendmail</em> macro.
The second <code class="language-plaintext highlighter-rouge">D</code> line replaces the value assigned to <code class="language-plaintext highlighter-rouge">$A</code> in the first line
with the new value <code class="language-plaintext highlighter-rouge">value2</code>.  Thus, <code class="language-plaintext highlighter-rouge">$A</code> will have the value <code class="language-plaintext highlighter-rouge">value1</code> when
the first <code class="language-plaintext highlighter-rouge">R</code> line is expanded and <code class="language-plaintext highlighter-rouge">value2</code> when the second is expanded.
Prove this to yourself by running <em>sendmail</em> in <code class="language-plaintext highlighter-rouge">-bt</code> rule-testing mode to
test that file:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ printf =Stest | sendmail -bt -Ctest.cf
ADDRESS TEST MODE (ruleset 3 NOT automatically invoked)
Enter &lt;ruleset&gt; &lt;address&gt;
&gt; Rvalue1               value1 . new 
Rvalue2                 value2 . new 
&gt; $ 
</code></pre></div></div>

<p>Here, you used the <code class="language-plaintext highlighter-rouge">=S</code> command to show each rule after it has been read
and expanded.</p>

<p>Another property of macros is that an undefined macro expands to an empty
string.  Consider this rewrite of the previous <em>test.cf</em> file in which you
use a <code class="language-plaintext highlighter-rouge">$B</code> macro that was never defined:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>V10
Stest
DAvalue1
R $A	$A.$B
DAvalue2
R $A	$A.$B
</code></pre></div></div>

<p>Run <em>sendmail</em> again, in rule-testing mode, to see the result:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ printf =Stest | sendmail -bt -Ctest.cf
ADDRESS TEST MODE (ruleset 3 NOT automatically invoked)
Enter &lt;ruleset&gt; &lt;address&gt;
&gt; Rvalue1               value1 . 
Rvalue2                 value2 . 
&gt; $ 
</code></pre></div></div>

<p>Beginning with V8.7, <em>sendmail</em> macros can be either single-character or
multicharacter.  Both forms are expanded when the configuration file is read:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>D{YOURDOMAIN}us.edu
R ${YOURDOMAIN}    localhost.${YOURDOMAIN}
</code></pre></div></div>

<p>Multicharacter macros can be used in the LHS and in the RHS.
When the configuration file is read, the previous example is expanded
to look like this:</p>

<p><code class="language-plaintext highlighter-rouge">R us . edu               localhost . us . edu</code></p>

<p>It is critical to remember that macros are expanded when the
configuration file is read.  If you forget, you might discover that
your configuration file is not doing what you expect.</p>

<h2 id="rules-are-treated-like-addresses">Rules Are Treated Like Addresses</h2>

<p>After each side (LHS and RHS) is expanded, each is then normalized just
as though it were an address.  A check is made for any <strong>tabs</strong> that might
have been introduced during expansion.  If any are found, everything from
the first tab to the end of the string is discarded.</p>

<p>Then, if the version of the configuration file you are running is less
than 9 (that is, if the version of <em>sendmail</em> you are running is less
than V8.10), RFC2822-style comments are removed.  An RFC2822 comment is
anything between and including an unquoted pair of parentheses:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>DAroot@my.site (Operator)
R $A  &lt;tab&gt;RHS
   ↓
R root@my.site (Operator)  &lt;tab&gt;RHS        ← expanded
   ↓
R root@my.site  &lt;tab&gt;RHS      ← comment stripped prior to version 8 configs only
</code></pre></div></div>

<p>Finally, prior to V8.13 (as of V8.13, rules no longer need to balance),
a check was made for balanced quotation marks, and for right angle brackets
balanced by left (The <code class="language-plaintext highlighter-rouge">$&gt;</code> operator isn’t counted in checking balance.)
If any righthand character appeared without a corresponding lefthand
character, <em>sendmail</em> printed one of the following errors (where
<em>configfile</em> is the name of the configuration file that was being read,
<em>number</em> shows the line number in that file, and <em>expression</em> is the part
of the rule that was unbalanced) and attempted to make corrections:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>configfile : line number: expression  ...Unbalanced '"'
configfile : line number: expression ...Unbalanced ''
</code></pre></div></div>

<p>Note that prior to V8.13, an unbalanced quotation mark was corrected by
appending a second quotation mark, and an unbalanced angle bracket was
corrected by removing it.  Consider the following <em>test.cf</em> confirmation file:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>V8
Stest
R x      RHS"
R y      RHS&gt;
</code></pre></div></div>

<p>If you ran pre-V8.13 <em>sendmail</em> in rule-testing mode on this file, the
following errors and rules would be printed:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ printf =Stest | sendmail -bt -Ctest.cf
test.cf: line 3: RHS"... Unbalanced '"'
test.cf: line 4: RHS&gt;... Unbalanced '&gt;'
R x              RHS ""
R y              RHS
</code></pre></div></div>

<h3 id="as-of-v813-rules-no-longer-need-to-balance">As of V8.13, rules no longer need to balance</h3>

<p>Prior to V8.13, special characters in rules were required to balance.
If they didn’t, <em>sendmail</em> would issue a warning and try to make them balance:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SCheck_Subject
R ----&gt; test &lt;----         $#discard $: discard
</code></pre></div></div>

<h3 id="-operators-are-tokens">$-operators Are Tokens</h3>

<p>As we progress into the details of rules, you will see that certain
characters become operators when prefixed with a <code class="language-plaintext highlighter-rouge">$</code> character.
Operators cause <em>sendmail</em> to perform actions, such as looking for
a match (<code class="language-plaintext highlighter-rouge">$*</code> is a wildcard operator) or replacing tokens with others by
position (<code class="language-plaintext highlighter-rouge">$1</code> is a replacement operator).</p>

<p>For tokenizing purposes, operators always divide one token from another,
just as the characters in the master list did.  For example:</p>

<p><code class="language-plaintext highlighter-rouge">xxx$*zzz    becomes  →   xxx  $*  zzz</code></p>

<h3 id="the-space-character-is-special">The Space Character Is Special</h3>

<p>The space character is special for two reasons.  First, although the space
character is not in the master list, it <em>always</em> separates one token from
another:</p>

<p><code class="language-plaintext highlighter-rouge">xxx zzz    becomes →  xxx  zzz</code></p>

<p>Second, although the space character separates tokens, it is not itself
a token.  That is, in this example the seven characters on the left
(the fourth is the space in the middle) become two tokens of three
letters each, not three tokens.  Therefore, the space character can be
used inside the LHS or RHS of rules for improved clarity but does not
itself become a token or change the meaning of the rule.</p>

<h3 id="the-workspace">The Workspace</h3>

<p>As was mentioned, rules exist to rewrite addresses.  We won’t cover the
reasons this rewriting needs to be done just yet, but we will concentrate
on the general behavior of rewriting.</p>

<p>Before any rules are called to perform rewriting, a temporary buffer called
the “workspace” is created.  The address to be rewritten is then tokenized
and placed into that workspace.  The process of tokenizing addresses in the
workspace is exactly the same as the tokenizing of rules that you saw before:</p>

<p><code class="language-plaintext highlighter-rouge">gw@wash.dc.gov    becomes  →   gw  @  wash  .  dc  . gov</code></p>

<p>Here, the tokenizing characters defined by the <code class="language-plaintext highlighter-rouge">OperatorChars</code> option and
those defined internally by <em>sendmail</em> caused the address to be broken into
seven tokens.  The process of rewriting changes the tokens in the workspace:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>                       ← workspace is "gw" "@" "wash" "." "dc" "." "gov"
R &lt;lhs&gt; &lt;rhs&gt;  R &lt;lhs&gt; &lt;rhs&gt;                ← rules rewrite the workspace
R &lt;lhs&gt; &lt;rhs&gt;                        ← workspace is "gw" "." "LOCAL"
</code></pre></div></div>

<p>Here, the workspace began with seven tokens.  The three hypothetical rules
recognized that this was a local address (in token form) and rewrote it so
that it became three tokens.</p>

<h2 id="the-lhs">The LHS</h2>

<p>The LHS of any rule is compared to the current contents of the workspace
to determine whether the two match.  Table LHS Operators Table
<strong><sup><a href="#footnotes">[3]</a></sup></strong> displays a variety of special operators
offered by <em>sendmail</em> that make comparisons easier and more versatile.</p>

<h2 id="the-rhs">The RHS</h2>

<p>The purpose of the RHS in a rule is to rewrite the workspace.  To make this
rewriting more versatile, <em>sendmail</em> offers several special RHS operators.
The complete list is shown in Table RHS Operators Table
<strong><sup><a href="#footnotes">[4]</a></sup></strong>.</p>

<hr />

<h2 id="debuggingtroubleshooting-check_-in-sendmail">Debugging/Troubleshooting check_* in sendmail</h2>

<p>From <a href="https://www.sendmail.org/~ca/email/chk-dbg.h
tml">Debugging check_* in sendmail 8.8/8.9 and later</a> (By: Claus Aßmann - Last Update 2006-03-31)
(Retrieved on 2022-11-02)</p>

<p>and</p>

<p>sendmail, 4th Edition (a.k.a. Bat Book), Published by O’Reilly Media, Inc.,
Publication Date: October 2007 (Chapter 7. How to Handle Spam, 
Subchapter “The Local_check_ Rule Sets” - Section “Local_check_relay and check_relay”)</p>

<blockquote>
  <p>After you have installed the new <a href="https://www.sendmail.org/~ca/email/check.html">check_* rules</a>
or you
use <a href="https://www.sendmail.org/~ca/email/chk-89.html">sendmail 8.9 (and later) standard FEATUREs</a>
to avoid misuse of your system and spam from well-known
sites, you need to test them.  Or you can blindly trust the guys who wrote
them… (never do that, someone may have made a mistake!).</p>
</blockquote>

<blockquote>
  <p>First, you can use conventional debugging by testing the rewrite rules
directly with <code class="language-plaintext highlighter-rouge">sendmail -bt</code>.  If you want to test those rulesets
(<a href="https://www.sendmail.org/~ca/email/check.html#check_relay">check_relay</a>,
<a href="https://www.sendmail.org/~ca/email/check.html#check_compat">check_compat</a>)
which use the <code class="language-plaintext highlighter-rouge">$|</code> token, you should introduce the following ruleset first:</p>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>STranslate
R $* $$| $*	$: $1 $| $2	fake for -bt mode, remove for real version
</code></pre></div></div>

<p>NOTE:  There are two <strong>tab</strong> characters, one before  <code class="language-plaintext highlighter-rouge">$:</code> and the other
before <code class="language-plaintext highlighter-rouge">fake for -bt mode, remove for real version</code>.</p>

<p>This rule set changes a literal <code class="language-plaintext highlighter-rouge">$</code> and <code class="language-plaintext highlighter-rouge">|</code> into a <code class="language-plaintext highlighter-rouge">$|</code> operator so that
you can test rule sets such as <code class="language-plaintext highlighter-rouge">Local_check_relay</code> from rule-testing mode:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo su

# sendmail -bt
ADDRESS TEST MODE (ruleset 3 NOT automatically invoked)
Enter &lt;ruleset&gt; &lt;address&gt;
&gt; Translate,Local_check_relay bogus.host.domain $| 123.45.67.89
Translate          input: bogus . host . domain $| 123 . 45 . 67 . 89
Translate        returns: bogus . host . domain $| 123 . 45 . 67 . 89
Local_check_rela   input: bogus . host . domain $| 123 . 45 . 67 . 89
Local_check_rela returns: bogus . host . domain $| 123 . 45 . 67 . 89
&gt; 
&gt; /quit
</code></pre></div></div>

<p>Also, see:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sed -n 2910,2950p /usr/local/share/sendmail/cf/README
Header Checks
-------------

You can also reject mail on the basis of the contents of headers.
This is done by adding a ruleset call to the 'H' header definition command
in sendmail.cf.  For example, this can be used to check the validity of
a Message-ID: header:

        LOCAL_CONFIG
        HMessage-Id: $&gt;CheckMessageId

        LOCAL_RULESETS
        SCheckMessageId
        R&lt; $+ @ $+ &gt;            $@ OK
        R$*                     $#error $: 553 Header Error


The alternative format:

        HSubject: $&gt;+CheckSubject

that is, $&gt;+ instead of $&gt;, gives the full Subject: header including
comments to the ruleset (comments in parentheses () are stripped
by default).

A default ruleset for headers which don't have a specific ruleset
defined for them can be given by:

        H*: $&gt;CheckHdr

Notice:
1. All rules act on tokens as explained in doc/op/op.{me,ps,txt}.
That may cause problems with simple header checks due to the
tokenization.  It might be simpler to use a regex map and apply it
to $&amp;{currHeader}.
2. There are no default rulesets coming with this distribution of
sendmail.  You can write your own, can search the WWW for examples,
or take a look at cf/cf/knecht.mc.
3. When using a default ruleset for headers, the name of the header
currently being checked can be found in the $&amp;{hdr_name} macro.
</code></pre></div></div>

<hr />

<h2 id="footnotes">Footnotes</h2>

<p>[1] If you depended on the old behavior where <code class="language-plaintext highlighter-rouge">Family</code> and <code class="language-plaintext highlighter-rouge">family</code> both
worked, rebuild <em>sendmail</em> with the <em>Build</em>-time macro <code class="language-plaintext highlighter-rouge">_FFR_DPO_CS</code> defined.
Note that beginning with V8.15, <code class="language-plaintext highlighter-rouge">Addr</code>, <code class="language-plaintext highlighter-rouge">Family</code>, <code class="language-plaintext highlighter-rouge">Listen</code>, <code class="language-plaintext highlighter-rouge">Modifier</code>,
<code class="language-plaintext highlighter-rouge">Name</code>, and <code class="language-plaintext highlighter-rouge">SendBufferSize</code> became case-insensitive, all the others
remained case-sensitive.</p>

<p>[2] The <em>sendmail.cf</em> file’s configuration commands</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>+---------+------------------------------------------------------------+
| Command | Description                                                |
+---------+------------------------------------------------------------+
| C       | Define a class macro.                                      |
+---------+------------------------------------------------------------+
| D       | Define a macro.                                            |
+---------+------------------------------------------------------------+
| E       | Define an environment variable (beginning with V8.7).      |
+---------+------------------------------------------------------------+
| F       | Define a class macro from a file, pipe, or database map.   |
+---------+------------------------------------------------------------+
| H       | Define a header.                                           |
+---------+------------------------------------------------------------+
| K       | Declare a keyed database (beginning with V8.1).            |
+---------+------------------------------------------------------------+
| L       | Include extended load average support (contributed         |
|         | software, not covered).                                    |
+---------+------------------------------------------------------------+
| M       | Define a mail delivery agent.                              |
+---------+------------------------------------------------------------+
| O       | Define an option.                                          |
+---------+------------------------------------------------------------+
| P       | Define delivery priorities.                                | 
+---------+------------------------------------------------------------+
| Q       | Define a queue (beginning with V8.12).                     |
+---------+------------------------------------------------------------+
| R       | Define a rewriting rule.                                   |
+---------+------------------------------------------------------------+
| S       | Declare a rule-set start.                                  |
+---------+------------------------------------------------------------+
| T       | Declare trusted users (ignored in V8.1, restored in V8.7). | 
+---------+------------------------------------------------------------+
| V       | Define configuration file version (beginning with V8.1).   |
+---------+------------------------------------------------------------+
| X       | Define a mail filter (beginning with V8.12).               | 
+---------+------------------------------------------------------------+
</code></pre></div></div>

<p>[3]  LHS Operators Table</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>+----------+-------------------------+---------------------------------------+
| Operator | §                       | Description or use                    |
+----------+-------------------------+---------------------------------------+
| $*       |                         | Match zero or more tokens.            |
+----------+-------------------------+---------------------------------------+
| $+       |                         | Match one or more tokens.             |
+----------+-------------------------+---------------------------------------+
| $-       |                         | Match exactly one token.              |
+----------+-------------------------+---------------------------------------+
| $@       |                         | Match exactly zero tokens (V8 only).  |
+----------+-------------------------+---------------------------------------+
| $=       | Matching Any in         | Match any tokens in                   |
|          | a Class: $=             | a class.  [a]                         |
+----------+-------------------------+---------------------------------------+
| $˜       | Matching Any Token Not  | Match any single token not            |
|          | in a Class: $~          | in a class.                           |
+----------+-------------------------+---------------------------------------+
| $#       |                         | Match a literal $#.                   |
+----------+-------------------------+---------------------------------------+
| $|       |                         | Match a literal $|.                   |
+----------+-------------------------+---------------------------------------+
| $&amp;       | Use Value As Is with $&amp; | Delay macro expansion until runtime.  |
+----------+-------------------------+---------------------------------------+
</code></pre></div></div>

<p><strong>[a]</strong> Class matches either a single token or multiple tokens, depending on
        the version of <em>sendmail</em>.</p>

<p>The first three operators in the LHS Operators Table are wildcard operators,
which can be used to match arbitrary sequences of tokens in the workspace. 
Consider the following rule, which employs the <code class="language-plaintext highlighter-rouge">$-</code> operator (match any
single token):</p>

<p><code class="language-plaintext highlighter-rouge">R $-	fred.local</code></p>

<p>Here, a match is found only if the workspace contains a single token
(such as tom).  If the workspace contains multiple tokens (such as
<em>tom@host</em>), the LHS does not match.  A match causes the workspace to be
rewritten by the RHS to become <code class="language-plaintext highlighter-rouge">fred.local</code>.  The rewritten workspace is
then compared again to the <code class="language-plaintext highlighter-rouge">$-</code>, but this time there is no match because
the workspace contains three tokens (<code class="language-plaintext highlighter-rouge">fred</code>, a dot [<code class="language-plaintext highlighter-rouge">.</code>], and <code class="language-plaintext highlighter-rouge">local</code>).
Because there is no match, the <em>current</em> workspace (<code class="language-plaintext highlighter-rouge">fred.local</code>) is
carried down to the next rule (if there is one).</p>

<p>The <code class="language-plaintext highlighter-rouge">$@</code> operator (introduced in V8 <em>sendmail</em>) matches an empty workspace.
Merely omitting the LHS won’t work:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>R&lt;tab&gt;RHS                ← won't work
R $@&lt;tab&gt;RHS                ← will work
</code></pre></div></div>

<p>If you merely omit the LHS in a mistaken attempt to match an empty LHS,
you will see the following error when sendmail starts up:</p>

<p><code class="language-plaintext highlighter-rouge">configfile: line number: R line: null LHS</code></p>

<p>Note that all comparisons of tokens in the LHS to tokens in the workspace
are done in a case-insensitive manner.  That is, <code class="language-plaintext highlighter-rouge">tom</code> in the LHS matches
<code class="language-plaintext highlighter-rouge">TOM</code>, <code class="language-plaintext highlighter-rouge">Tom</code>, and even <code class="language-plaintext highlighter-rouge">ToM</code> in the workspace.</p>

<p>[4]  RHS Operators Table</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>+----------+-------------------------+---------------------------------------+
| RHS      | §                       | Description or use                    |
+----------+-------------------------+---------------------------------------+
| $ digit  | Copy by Position:       | Copy by position.                     | 
|          | $digit                  |                                       |
+----------+-------------------------+---------------------------------------+
| $:       | Rewrite Once Prefix: $: | Rewrite once (when used as a prefix), |
|          |                         | or specify the user in a delivery     |
|          |                         | agent "triple," or specify the        |
|          |                         | default value to return on a failed   |
|          |                         | database-map lookup.                  | 
+----------+-------------------------+---------------------------------------+
| $@       | Rewrite-and-Return      | Rewrite and return (when used as a    |
|          | Prefix: $@              | prefix), or specify the host in a     |
|          |                         | delivery-agent "triple," or specify   |
|          |                         | an argument to pass in a database-map |
|          |                         | lookup or action.                     | 
+----------+-------------------------+---------------------------------------+
| $&gt; set   | Rewrite Through a Rule  | Rewrite through another rule set      |
|          | Set: $&gt;set              | (such as a subroutine call that       |  
|          |                         | returns to the current position).     | 
+----------+-------------------------+---------------------------------------+
| $#       | Return a Selection: $#  | Specify a delivery agent or choose an |
|          |                         | action, such as to reject or discard  |
|          |                         | a recipient, sender, connection, or   |
|          |                         | message.                              |
+----------+-------------------------+---------------------------------------+
| $[ $]    | Canonicalize Hostname:  | Canonicalize the hostname.            | 
|          | $[ and $]               |                                       |
+----------+-------------------------+---------------------------------------+
| $( $)    | Use $( and $) in Rules  | Perform a lookup in an external       |
|          |                         | database, file, or network service,   |
|          |                         | or perform a change (such as          |
|          |                         | dequoting), or store a value into     |
|          |                         | a macro.                              |
+----------+-------------------------+---------------------------------------+
| $&amp;       | Use Value As Is with $&amp; | Delay conversion of a macro until     |
|          |                         | runtime.                              |
+----------+-------------------------+---------------------------------------+
</code></pre></div></div>

<p><a href="http://www.harker.com/sendmail/check_compat.in.check_rcpt.html">Using “env_sender $| env_rcpt” check_compat rules in the check_rcpt ruleset</a></p>

<p><a href="https://groups.google.com/g/comp.mail.sendmail/c/1WfyI-e0nHU/m/xkdi2LcNjG4J">Auth to ISP - comp.mail.sendmail news group</a></p>

</div>
  <div class="share-page">
  <span style="float: left;">Share this on &rarr;&nbsp;&nbsp;</span>

  <!-- Twitter -->
  <a href="https://twitter.com/share" class="twitter-share-button" data-via="github.io">Tweet</a>
  <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

  <!-- Facebook -->
  <div class="fb-share-button" data-href="http://localhost:4000/sendmail/smtp/mta/mailserver/cli/terminal/shell/freebsd/sysadmin/reference/2022/10/22/sendmail-notes.html" data-layout="button_count" style="position: relative; top: -8px; left: 3px;"></div>
</div>

<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.6&appId=1749788565247320";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>

</div>


  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
            
            <div class="panel-body">
              <h4>Related Posts</h4>
              <ul>
            
                <li class="relatedPost">
                  <a href="http://localhost:4000/howto/webbrowser/networking/sysadmin/unix/webdevelopment/http/html/ruby/tutorial/2024/09/24/testing-different-jekyll-themes.html">Testing Different Jekyll Themes</a>
                  
                    (Categories: <a href="/category/howto">howto</a>, <a href="/category/webbrowser">webbrowser</a>, <a href="/category/networking">networking</a>, <a href="/category/sysadmin">sysadmin</a>, <a href="/category/unix">unix</a>, <a href="/category/webdevelopment">webdevelopment</a>, <a href="/category/http">http</a>, <a href="/category/html">html</a>, <a href="/category/ruby">ruby</a>, <a href="/category/tutorial">tutorial</a>)
                  
                </li>
          
          
        
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
            
                <li class="relatedPost">
                  <a href="http://localhost:4000/unicode/utf8/x11/xorg/xterm/cli/terminal/shell/howto/sysadmin/unix/perl/python/vi/vim/ascii/plaintext/text/tex/latex/pdf/typography/font/html/design/webbrowser/webdevelopment/awk/regex/programming/coding/development/tool/reference/dotfiles/tip/2024/09/17/encodings-utf8-and-unicode-notes.html">Encodings, UTF-8 and Unicode Notes</a>
                  
                    (Categories: <a href="/category/unicode">unicode</a>, <a href="/category/utf8">utf8</a>, <a href="/category/x11">x11</a>, <a href="/category/xorg">xorg</a>, <a href="/category/xterm">xterm</a>, <a href="/category/cli">cli</a>, <a href="/category/terminal">terminal</a>, <a href="/category/shell">shell</a>, <a href="/category/howto">howto</a>, <a href="/category/sysadmin">sysadmin</a>, <a href="/category/unix">unix</a>, <a href="/category/perl">perl</a>, <a href="/category/python">python</a>, <a href="/category/vi">vi</a>, <a href="/category/vim">vim</a>, <a href="/category/ascii">ascii</a>, <a href="/category/plaintext">plaintext</a>, <a href="/category/text">text</a>, <a href="/category/tex">tex</a>, <a href="/category/latex">latex</a>, <a href="/category/pdf">pdf</a>, <a href="/category/typography">typography</a>, <a href="/category/font">font</a>, <a href="/category/html">html</a>, <a href="/category/design">design</a>, <a href="/category/webbrowser">webbrowser</a>, <a href="/category/webdevelopment">webdevelopment</a>, <a href="/category/awk">awk</a>, <a href="/category/regex">regex</a>, <a href="/category/programming">programming</a>, <a href="/category/coding">coding</a>, <a href="/category/development">development</a>, <a href="/category/tool">tool</a>, <a href="/category/reference">reference</a>, <a href="/category/dotfiles">dotfiles</a>, <a href="/category/tip">tip</a>)
                  
                </li>
          
          
        
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
            
                <li class="relatedPost">
                  <a href="http://localhost:4000/hpc/server/hardware/sysadmin/automation/configmanagement/howto/vm/virtualization/qemu/kvm/cli/terminal/shell/linux/unix/networking/2024/09/12/hpc-torque-pbs-xcat-psh.html">HPC with TORQUE/PBS, xCAT, Gaussian and WebMO</a>
                  
                    (Categories: <a href="/category/hpc">hpc</a>, <a href="/category/server">server</a>, <a href="/category/hardware">hardware</a>, <a href="/category/sysadmin">sysadmin</a>, <a href="/category/automation">automation</a>, <a href="/category/configmanagement">configmanagement</a>, <a href="/category/howto">howto</a>, <a href="/category/vm">vm</a>, <a href="/category/virtualization">virtualization</a>, <a href="/category/qemu">qemu</a>, <a href="/category/kvm">kvm</a>, <a href="/category/cli">cli</a>, <a href="/category/terminal">terminal</a>, <a href="/category/shell">shell</a>, <a href="/category/linux">linux</a>, <a href="/category/unix">unix</a>, <a href="/category/networking">networking</a>)
                  
                </li>
          
          
        
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
            
                <li class="relatedPost">
                  <a href="http://localhost:4000/unicode/utf8/x11/xorg/xterm/cli/terminal/shell/howto/sysadmin/unix/typography/font/webbrowser/html/2024/08/11/why-some-chars-displayed-as-squares.html">Why Does My Program Display Some Characters as Square (Tofu)?</a>
                  
                    (Categories: <a href="/category/unicode">unicode</a>, <a href="/category/utf8">utf8</a>, <a href="/category/x11">x11</a>, <a href="/category/xorg">xorg</a>, <a href="/category/xterm">xterm</a>, <a href="/category/cli">cli</a>, <a href="/category/terminal">terminal</a>, <a href="/category/shell">shell</a>, <a href="/category/howto">howto</a>, <a href="/category/sysadmin">sysadmin</a>, <a href="/category/unix">unix</a>, <a href="/category/typography">typography</a>, <a href="/category/font">font</a>, <a href="/category/webbrowser">webbrowser</a>, <a href="/category/html">html</a>)
                  
                </li>
          
          
        
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
            
                <li class="relatedPost">
                  <a href="http://localhost:4000/x11/xorg/xterm/cli/terminal/shell/howto/sysadmin/unix/2024/08/09/xorg-x11-window-id-by-process-id.html">How to Find an X11 Window ID (WID) by a Process ID (PID)</a>
                  
                    (Categories: <a href="/category/x11">x11</a>, <a href="/category/xorg">xorg</a>, <a href="/category/xterm">xterm</a>, <a href="/category/cli">cli</a>, <a href="/category/terminal">terminal</a>, <a href="/category/shell">shell</a>, <a href="/category/howto">howto</a>, <a href="/category/sysadmin">sysadmin</a>, <a href="/category/unix">unix</a>)
                  
                </li>
          
          
        
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
            
                <li class="relatedPost">
                  <a href="http://localhost:4000/perl/programming/tutorial/cli/terminal/shell/script/it/computing/unix/sysadmin/learning/2024/07/24/introduction-to-perl.html">Beginner's Introduction to Perl [WIP]</a>
                  
                    (Categories: <a href="/category/perl">perl</a>, <a href="/category/programming">programming</a>, <a href="/category/tutorial">tutorial</a>, <a href="/category/cli">cli</a>, <a href="/category/terminal">terminal</a>, <a href="/category/shell">shell</a>, <a href="/category/script">script</a>, <a href="/category/it">it</a>, <a href="/category/computing">computing</a>, <a href="/category/unix">unix</a>, <a href="/category/sysadmin">sysadmin</a>, <a href="/category/learning">learning</a>)
                  
                </li>
          
          
        
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
  
  </ul>
</div>


<div class="PageNavigation">
  
    <a class="prev" href="/howto/diagram/graph/graphviz/plaintext/text/tex/latex/visualization/sysadmin/documentation/2022/10/19/timemanagement-graphviz.html">&laquo; Time Management with Graphviz</a>
  
  
    <a class="next" href="/sendmail/smtp/mta/mailserver/cli/terminal/shell/freebsd/sysadmin/reference/2022/11/12/sendmail-auth-client.html">Sendmail SMTP AUTH Running As a Client [HOWTO] &raquo;</a>
  
</div>

<div class="disqus-comments">
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    /* <![CDATA[ */
    var disqus_shortname = "";
    var disqus_identifier = "http://localhost:4000_Sendmail Notes [WIP]";
    var disqus_title = "Sendmail Notes [WIP]";

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    /* ]]> */
  </script>
</div>

        <footer>
          <!-- &copy; Dusko Pijetlovic -->
          
            <!-- - <a href="https://github.com/duskopijetlovic">https://github.com/duskopijetlovic</a> - Powered by Jekyll. -->
          
          <div class="btn-github" style="float:right;">
            <!-- <iframe src="https://ghbtns.com/github-btn.html?user=agusmakmun&repo=agusmakmun.github.io&type=star&count=true" frameborder="0" scrolling="0" width="100" height="20px"></iframe> -->
            <!-- <iframe src="https://ghbtns.com/github-btn.html?user=agusmakmun&repo=agusmakmun.github.io&type=fork&count=true" frameborder="0" scrolling="0" width="100" height="20px"></iframe> -->
          </div>
        </footer>
      </div>
      <!-- end /.col-sm-8 -->
    </div>
    <!-- end /.container -->

    <!-- Bootstrap core JavaScript -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <script src="//code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
    <script src="/static/js/bootstrap.min.js"></script>
    <script src="/static/js/super-search.js"></script>
    <script src="/static/js/thickbox-compressed.js"></script>
    <script src="/static/js/projects.js"></script>
  </body>
</html>

